server {
    listen 80;

    # Allow very large file uploads (e.g., 2GB+ book archives, app builds)
    client_max_body_size 5G;

    # Increase timeouts for large file uploads
    client_body_timeout 300s;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Proxy all requests to the API service
    location / {
        proxy_pass http://api:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable request buffering for streaming large uploads
        # This streams data directly to backend without buffering entire request
        proxy_request_buffering off;

        # Disable response buffering for large downloads
        proxy_buffering off;

        # Forward CORS headers for proper CORS handling
        proxy_set_header Origin $http_origin;
        proxy_set_header Access-Control-Request-Method $http_access_control_request_method;
        proxy_set_header Access-Control-Request-Headers $http_access_control_request_headers;

        # Pass through CORS response headers from API
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
        add_header Access-Control-Allow-Origin $upstream_http_access_control_allow_origin always;
        add_header Access-Control-Allow-Credentials $upstream_http_access_control_allow_credentials always;
        add_header Access-Control-Allow-Methods $upstream_http_access_control_allow_methods always;
        add_header Access-Control-Allow-Headers $upstream_http_access_control_allow_headers always;
    }
}
