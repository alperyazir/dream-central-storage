# Story 5.8: Config.json Metadata Ingestion - Brownfield Addition

## Status
Done

## Story
**As an** administrator,
**I want** new book uploads to load metadata from `config.json`,
**so that** FlowBook archives can be ingested without maintaining duplicate metadata files.

## Story Context
**Existing System Integration:**
- Integrates with: `/books/upload` API and MinIO storage service (`apps/api/app/routers/books.py`, `apps/api/app/services/storage.py`).
- Technology: FastAPI + Pydantic backend, React + Material UI admin panel, MinIO S3 storage.
- Follows pattern: Story 5.1 flexible book upload flow using archive ingestion.
- Touch points: `BookCreate` schema, admin `UploadDialog` messaging, Pytest/Vitest suites.
- Sample dataset: FlowBook config at `/Users/alperyazir/Dev/Temp/project_heroes_6_abkitap/config.json` illustrates expected structure. 

## Acceptance Criteria
1. Backend `POST /books/upload` locates a UTF-8 `config.json` anywhere in the uploaded archive and returns HTTP 400 with an actionable message referencing `config.json` when the file is missing, unreadable, or invalid. 
2. Config parsing maps canonical fields (`publisher`, `book_name`, `language`, `category`, optional `version`, `status`) from identically named keys or FlowBook-specific synonyms such as `publisher_name` and `book_title`, trimming whitespace before persisting; missing required metadata yields an error that names the absent keys and points to `config.json`.
3. When both `config.json` and legacy `metadata.json` are present, the API prefers `config.json` but continues to accept `metadata.json` archives for backward compatibility while logging a deprecation warning; requests without `config.json` fail with guidance to add the file.
4. The admin panel upload dialog copy, helper text, and validation messaging instruct users to include `config.json` (with key mapping notes) instead of `metadata.json`, and the success banner surfaces the ingested `book_name`.
5. Automated tests cover config ingestion success, synonym mapping, missing-field errors, dual-file precedence, and UI messaging updates (Pytest for backend, Vitest/RTL for frontend).
6. Project documentation (PRD epic 5 and book data structure brief) is updated to state that new book uploads rely on `config.json` metadata and describe the accepted key mappings.

## Tasks / Subtasks
- [x] Audit `_extract_book_metadata` and related helpers to switch primary parsing to `config.json`, retaining `metadata.json` fallback logic with warnings (AC: 1, 2, 3) [Source: apps/api/app/routers/books.py]
  - [x] Implement key mapping logic and required-field validation with targeted HTTP 400 messages (AC: 1, 2) [Source: apps/api/app/schemas/book.py]
  - [x] Ensure uploads still stream to MinIO unchanged aside from metadata source (AC: 3) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-notes]
- [x] Refresh backend test fixtures to include FlowBook-style `config.json` archives and assert precedence plus error scenarios (AC: 1, 2, 3, 5) [Source: apps/api/tests/test_books_upload.py]
- [x] Update admin upload dialog guidance and behaviour for new book uploads, reflecting `config.json` expectations (AC: 4) [Source: apps/admin-panel/src/components/UploadDialog.tsx]
  - [x] Adjust client-side tests to mirror the new copy and validation behaviour (AC: 4, 5) [Source: apps/admin-panel/src/__tests__/dashboard.test.tsx]
- [x] Document the config-driven metadata flow and key mapping in PRD epic 5 and book data structure doc (AC: 6) [Source: docs/prd/epic-5-storage-ux-and-stability-upgrades.md; docs/dcs_project_draft.md#book-data-structure]
- [x] Coordinate release notes / comms to signal the deprecation of standalone `metadata.json` (AC: 3, 6) [Source: docs/prd/next-steps.md]

## Dev Notes
### Story Context
- Integrates with: `/books/upload` FastAPI route and shared MinIO upload service (`apps/api/app/routers/books.py`, `apps/api/app/services/storage.py`).
- Technology: FastAPI, SQLAlchemy, Pydantic (`apps/api`); React + Material UI (`apps/admin-panel`); MinIO S3 storage.
- Follows pattern: Story 5.1 flexible book upload flow and existing ZIP ingestion pipeline.
- Touch points: `BookCreate` schema validation, admin upload messaging, Pytest/Vitest suites.

### Definition of Done
- [ ] Config parsing selects required metadata, mapping synonyms and trimming values.
- [ ] Upload manifests and MinIO prefixes remain unchanged for books.
- [ ] UI communicates `config.json` requirement and handles validation feedback.
- [ ] Pytest and Vitest suites cover new parsing and messaging paths.
- [ ] Documentation reflects config-based metadata ingestion.
- [ ] Deprecation notice for `metadata.json` communicated.

### Risk and Compatibility Check
- Primary Risk: Existing archives lacking `config.json` may fail uploads if guidance is unclear.
- Mitigation: Keep `metadata.json` as fallback during transition and emit clear error copy.
- Rollback: Revert to previous parser or deploy hotfix toggling parser preference.

### Compatibility Verification
- [ ] No API contract changes for existing update (`/books/{id}/upload`) flows.
- [ ] Database schema unchanged.
- [ ] Admin UI styling remains aligned with Story 5.7 palette.
- [ ] Performance impact negligible since parsing is still in-memory JSON handling.

### Validation Checklist
- [ ] Change scoped to archive metadata parsing and UI messaging.
- [ ] Synonym mapping limited to documented key names.
- [ ] Error copy localized in both backend response and frontend helper text.
- [ ] Logging captures parser decisions for observability.

## Testing
- Backend: Pytest cases in `apps/api/tests/test_books_upload.py` for config success, synonym mapping, dual-file precedence, and missing-field errors.
- Frontend: Vitest + React Testing Library updates covering UploadDialog helper text and validation copy.
- Regression: `npm run test -- --run` (admin panel) and `pytest` (API) to ensure suites remain green.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-09 | 0.1 | Initial draft capturing config.json metadata ingestion enhancement. | Sarah (Product Owner) |
| 2025-10-05 | 0.2 | Story reviewed and approved for development. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (apps/api)
- `npm test -- --run` (apps/admin-panel)

### Completion Notes List
- Switched `/books/upload` to prefer `config.json`, map FlowBook key aliases, and only tap `metadata.json` as a gap filler while emitting warnings for the legacy file.
- Expanded backend coverage for config ingestion success, missing-field messaging, and metadata fallback logging.
- Updated admin upload guidance/tests plus product docs to highlight the `config.json` requirement and documented alias mapping.

### File List
- apps/api/app/routers/books.py
- apps/api/tests/test_books_upload.py
- apps/admin-panel/src/components/UploadDialog.tsx
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- docs/dcs_project_draft.md
- docs/prd/epic-5-storage-ux-and-stability-upgrades.md
- docs/stories/5.8.config-json-book-upload-metadata.md

## QA Results
