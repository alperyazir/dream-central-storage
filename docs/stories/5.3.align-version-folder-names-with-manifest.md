# Story 5.3: Align Version Folder Names with Manifest

## Status
Done

## Story
**As an** administrator,
**I want** storage folders to use the version defined in each uploadâ€™s `data/version` file,
**so that** book and app releases remain traceable to their official release numbers.

## Acceptance Criteria
1. During upload, the service reads `data/version` from the provided folder/archive for both books and apps.
2. The extracted version string names the destination folder under the relevant book or app path instead of a random identifier.
3. If a folder already exists for the specified version, the API blocks the upload and communicates the conflict to the UI unless an explicit override flag is provided.
4. Uploads missing the version file or containing invalid content fail with actionable error messages.
5. Audit logs or responses include the resolved version to aid troubleshooting.

## Tasks / Subtasks
- [x] Investigate current folder-naming logic in the upload services and document the touchpoints that generate UUIDs (AC: 1, 2) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-notes]
- [x] Implement manifest parsing that reads `data/version` safely (case sensitivity, whitespace) for both books and apps (AC: 1, 2, 4) [Source: docs/prd/epic-5-storage-ux-and-stability-upgrades.md#story-53-align-version-folder-names-with-manifest]
  - [x] Validate the version string against agreed formatting rules (e.g., semantic versioning) and return descriptive errors on failure (AC: 4) [Source: docs/prd/requirements.md#non-functional]
- [x] Update storage write operations to use the manifest version as the folder name and preserve previous UUIDs for backward compatibility where needed (AC: 2) [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Add conflict detection when the target folder already exists and design override semantics (AC: 3) [Source: docs/prd/requirements.md#functional]
  - [x] Surface conflict or override confirmation feedback in the admin panel modal (AC: 3, 4, 5) [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#dev-notes]
- [x] Expand automated tests covering version parsing, conflict handling, and response payloads for both content types (AC: 4, 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [x] Update operator documentation describing the requirement to include a `data/version` file in every upload (AC: 4, 5) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]

## Dev Notes
### Previous Story Insights
- Story 2.3 introduced app build uploads and currently generates random folder names; leverage its implementation notes to identify integration points. [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#dev-notes]
- Story 3.4 describes frontend messaging for uploads and should be extended to display version-related errors. [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#dev-notes]

### Data Models
- Book and app metadata include `version` fields; ensure persistence remains consistent when using manifest-driven naming. [Source: docs/architecture/4-data-models.md#book]

### API Specifications
- Confirm whether responses already surface version information; update OpenAPI definitions accordingly after adding manifest enforcement. [Source: docs/architecture/5-api-specification.md#file-uploads]

### Component Specifications
- Frontend toast/modals should communicate manifest errors clearly while aligning with the design system. [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]

### File Locations
- Backend modifications will occur within upload service modules under `apps/api/app/services` and routers under `apps/api/app/routers`. Frontend changes touch `apps/admin-panel/src/features/uploads`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Add unit tests for manifest parsing helpers, integration tests for conflict scenarios, and frontend tests for new error states. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Ensure uploads remain atomic; partial writes must be rolled back when manifest validation fails. [Source: docs/architecture/18-error-handling-strategy.md#error-boundaries]

### Project Structure Notes
- Share manifest parsing utilities across book and app pathways to avoid duplication. [Source: docs/architecture/13-development-workflow.md#shared-contracts]

## Testing
- Backend: unit + integration coverage for manifest parsing and storage writes.
- Frontend: tests for conflict and error messaging in upload flows.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-04 | 0.1 | Initial draft created. | Sarah (Product Owner) |
| 2025-10-05 | 0.2 | Manifest-based version folders with override UX, validation, and tests. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- pytest (apps/api)
- npm test -- --run (apps/admin-panel)

### Completion Notes List
- Added shared manifest-version extraction, conflict detection, and override handling for book and app uploads with versioned responses and audit logging.
- Refined admin upload dialog to display resolved versions, surface conflict prompts with override retry, and improve API error messaging via structured `ApiError` handling.
- Expanded automated coverage across backend and frontend plus updated operator documentation to require `data/version` manifests.

### File List
- apps/api/app/routers/apps.py
- apps/api/app/routers/books.py
- apps/api/app/services/__init__.py
- apps/api/app/services/storage.py
- apps/api/tests/test_apps_upload.py
- apps/api/tests/test_books_upload.py
- apps/api/tests/test_storage_service.py
- apps/admin-panel/src/lib/api.ts
- apps/admin-panel/src/lib/uploads.ts
- apps/admin-panel/src/stores/auth.ts
- apps/admin-panel/src/components/UploadDialog.tsx
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- apps/admin-panel/src/__tests__/auth.test.tsx
- docs/prd/user-interface-design-goals.md
- docs/stories/5.3.align-version-folder-names-with-manifest.md

## QA Results
- Not yet reviewed.
