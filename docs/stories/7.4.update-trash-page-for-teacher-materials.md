# Story 7.4: Update Trash Page for Teacher Materials

## Status

Done

## Story

**As an** administrator,
**I want** the Trash page to display and manage deleted teacher materials,
**so that** I can restore or permanently delete them alongside books and apps.

## Acceptance Criteria

1. Trash page displays teacher materials alongside books and apps.
2. Teacher material entries show `item_type` as "Teacher Material" (user-friendly label).
3. Teacher materials display teacher_id in the Name column.
4. Restore action works for teacher materials (returns to teachers bucket).
5. Permanent delete action works for teacher materials.
6. Optional: Filter/chip to show only teacher materials.

## Tasks / Subtasks

- [x] **Task 1: Update getEntryLabel Function (AC: 2, 3)**
  - [x] Modify `getEntryLabel()` in `Trash.tsx` to handle teacher_material type:
    ```typescript
    const getEntryLabel = (entry: TrashEntry) => {
      if (entry.item_type === 'book' && entry.metadata) {
        // existing book logic
      }
      if (entry.item_type === 'app' && entry.metadata) {
        // existing app logic
      }
      if (entry.item_type === 'teacher_material' && entry.metadata) {
        const teacherId = entry.metadata.teacher_id ?? entry.metadata.teacherId;
        if (teacherId) {
          return `Teacher: ${teacherId}`;
        }
      }
      return entry.path || entry.key;
    };
    ```

- [x] **Task 2: Update Table Display (AC: 1, 2)**
  - [x] Add item type column or badge to table (optional enhancement)
  - [x] Format bucket column to show "teachers" for teacher materials
  - [x] Ensure path column shows material path correctly

- [ ] **Task 3: Verify Restore Functionality (AC: 4)**
  - [ ] Test restore action for teacher_material entries
  - [ ] Verify materials return to `teachers/{teacher_id}/materials/` path
  - [ ] Confirm success notification shows correct details

- [ ] **Task 4: Verify Delete Functionality (AC: 5)**
  - [ ] Test permanent delete action for teacher_material entries
  - [ ] Verify delete confirmation shows teacher material details
  - [ ] Confirm success notification after deletion

- [x] **Task 5: Add Item Type Filter (AC: 6 - Optional)**
  - [x] Add filter chips above table:
    ```tsx
    <Stack direction="row" spacing={1} sx={{ mb: 2 }}>
      <Chip
        label="All"
        onClick={() => setTypeFilter('')}
        variant={typeFilter === '' ? 'filled' : 'outlined'}
      />
      <Chip
        label="Books"
        onClick={() => setTypeFilter('book')}
        variant={typeFilter === 'book' ? 'filled' : 'outlined'}
      />
      <Chip
        label="Apps"
        onClick={() => setTypeFilter('app')}
        variant={typeFilter === 'app' ? 'filled' : 'outlined'}
      />
      <Chip
        label="Teacher Materials"
        onClick={() => setTypeFilter('teacher_material')}
        variant={typeFilter === 'teacher_material' ? 'filled' : 'outlined'}
      />
    </Stack>
    ```
  - [x] Filter `sortedEntries` by `item_type` when filter active
  - [x] Show filter count: "Showing X items"

- [x] **Task 6: Update TrashEntry Type (if needed)**
  - [x] Verify `TrashEntry` interface in `lib/storage.ts` includes teacher_material support
  - [x] Add teacher_id to metadata type if not present:
    ```typescript
    interface TrashEntry {
      key: string;
      bucket: string;
      path: string;
      item_type: 'book' | 'app' | 'teacher_material' | 'unknown';
      metadata?: {
        publisher?: string;
        book_name?: string;
        platform?: string;
        version?: string;
        teacher_id?: string;  // Add this
      };
      object_count: number;
      total_size: number;
    }
    ```

- [ ] **Task 7: Test Integration**
  - [ ] Delete a teacher material from Teachers page
  - [ ] Verify it appears in Trash with correct metadata
  - [ ] Restore the material and verify it returns to Teachers page
  - [ ] Delete again and permanently delete from Trash
  - [ ] Verify existing book/app trash operations still work

## Dev Notes

### Backend Response Structure
[Source: apps/api/app/services/storage.py]

The backend already returns `item_type: "teacher_material"` for teacher entries in trash:
```python
elif bucket == "teachers" and len(parts) >= 3 and parts[2] == "materials":
    item_type = "teacher_material"
    prefix_parts = parts[1:3]  # [teacher_id, "materials"]
    metadata = {"teacher_id": parts[1]}
```

### TrashEntry Response Example
```json
{
  "key": "teachers/teacher_123/materials/",
  "bucket": "teachers",
  "path": "teacher_123/materials",
  "item_type": "teacher_material",
  "metadata": {
    "teacher_id": "teacher_123"
  },
  "object_count": 3,
  "total_size": 15360,
  "eligible_for_deletion": false,
  "oldest_object_age_days": 2
}
```

### Existing Trash Functions
[Source: apps/admin-panel/src/lib/storage.ts]

- `listTrashEntries(token, tokenType)` - Already returns all trash entries
- `restoreTrashEntry(key, token, tokenType)` - Works for any bucket type
- `deleteTrashEntry(key, token, tokenType, client, options)` - Works for any bucket type

No changes needed to these functions.

### File Locations

| File | Action |
|------|--------|
| `src/pages/Trash.tsx` | MODIFY (update getEntryLabel, add filter) |
| `src/lib/storage.ts` | VERIFY (TrashEntry type includes teacher_material) |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- Successfully updated `TrashItemType` to include 'teacher_material' type
- Updated `TrashEntry` interface metadata to include teacher_id field (both snake_case and camelCase variants for compatibility)
- Implemented `getEntryLabel()` to display teacher materials as "Teacher: {teacher_id}"
- Added `getItemTypeLabel()` helper function to convert item types to user-friendly labels
- Added "Type" column to trash table displaying "Teacher Material" for teacher items
- Implemented filter chip functionality with All/Books/Apps/Teacher Materials options
- Added item count display when filter is active
- All TypeScript compilation passes without errors
- No new lint errors introduced
- Tasks 3, 4, and 7 require manual testing to verify restore/delete functionality

### File List
- Modified: apps/admin-panel/src/lib/storage.ts
- Modified: apps/admin-panel/src/pages/Trash.tsx

---

## QA Results
(To be filled by QA Agent)
