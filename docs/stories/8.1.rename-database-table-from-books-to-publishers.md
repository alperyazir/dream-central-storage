# Story 8.1: Rename Database Table from Books to Publishers

## Status

Cancelled - Superseded by normalized schema design (see revised Epic 8)

## Story

**As a** database administrator,
**I want** the `books` table renamed to `publishers`,
**so that** the database schema accurately reflects that we store publisher metadata, not individual book metadata.

## Acceptance Criteria

1. Alembic migration created to rename table `books` → `publishers`.
2. Database constraints (primary keys, indexes, foreign keys if any) are preserved during rename.
3. Migration includes both `upgrade()` and `downgrade()` functions for rollback capability.
4. Migration tested in development environment before story completion.
5. Existing data remains intact and accessible after migration.
6. Application starts successfully and connects to renamed table.

## Tasks / Subtasks

- [x] **Task 1: Create Alembic Migration File (AC: 1, 2, 3)**
  - [x] Generate new migration file: `alembic revision -m "rename books table to publishers"`
  - [x] Migration file location: `apps/api/alembic/versions/YYYYMMDD_NN_rename_books_table_to_publishers.py`
  - [x] Follow naming pattern: `{date}_{sequence}_description.py` (e.g., `20251214_01_rename_books_table_to_publishers.py`)
  - [x] Set revision dependencies:
    - `down_revision` = ID of latest migration (check `apps/api/alembic/versions/` for most recent)
    - `branch_labels = None`
    - `depends_on = None`

- [x] **Task 2: Implement upgrade() Function (AC: 1, 2)**
  - [x] Add table rename SQL:
    ```python
    def upgrade() -> None:
        op.rename_table("books", "publishers")
    ```
  - [x] Verify this preserves all constraints (primary key, indexes, enum types)
  - [x] No need to rename columns - only the table name changes

- [x] **Task 3: Implement downgrade() Function (AC: 3)**
  - [x] Add rollback SQL:
    ```python
    def downgrade() -> None:
        op.rename_table("publishers", "books")
    ```
  - [x] Test downgrade restores original table name

- [x] **Task 4: Update ORM Model (AC: 6)**
  - [x] Open `apps/api/app/models/book.py`
  - [x] Update `__tablename__ = "books"` to `__tablename__ = "publishers"`
  - [x] Keep class name as `Book` for now (will be renamed in Story 8.2)
  - [x] This allows the application to connect to the renamed table

- [x] **Task 5: Test Migration in Development (AC: 4, 5, 6)**
  - [x] Backup current database or verify you can reset development environment
  - [x] Run migration: `cd apps/api && alembic upgrade head`
  - [x] Verify table renamed: `psql -d dream_central -c "\dt publishers"`
  - [x] Verify data intact: `psql -d dream_central -c "SELECT COUNT(*) FROM publishers;"`
  - [x] Verify application starts without errors: `cd apps/api && python -m app.main`
  - [x] Test downgrade: `alembic downgrade -1`
  - [x] Verify table renamed back to `books`
  - [x] Re-run upgrade to final state

- [x] **Task 6: Verify Constraints Preserved (AC: 2)**
  - [x] Query database constraints after migration:
    ```sql
    SELECT conname, contype FROM pg_constraint WHERE conrelid = 'publishers'::regclass;
    ```
  - [x] Verify primary key exists
  - [x] Verify enum constraint exists (book_status)
  - [x] Verify all original constraints are present

## Dev Notes

### Previous Story Insights
[Source: Story 7.4 - Update Trash Page for Teacher Materials]
- Epic 7 completed teacher storage namespace and admin panel integration
- Trash page now handles multiple item types (books, apps, teacher materials)
- Pattern established for multi-bucket storage management

### Current Database Schema
[Source: apps/api/app/models/book.py]
**Table:** `books` (will become `publishers`)
**Columns:**
- `id` (Integer, primary key, autoincrement)
- `publisher` (String(255), not null) - Publisher name/ID
- `book_name` (String(255), not null) - Book identifier
- `book_title` (String(255), nullable) - Display title
- `book_cover` (String(512), nullable) - Cover image path
- `activity_count` (Integer, nullable) - Number of activities
- `activity_details` (JSONB, nullable) - Activity metadata
- `total_size` (BigInteger, nullable) - Total file size in bytes
- `language` (String(64), not null) - Language code
- `category` (String(128), nullable) - Book category
- `status` (Enum: BookStatusEnum, not null, default='draft') - Lifecycle state
- `created_at` (DateTime with timezone, server_default=now())
- `updated_at` (DateTime with timezone, server_default=now(), onupdate=now())

**Enums:**
- `BookStatusEnum`: DRAFT, PUBLISHED, ARCHIVED

**Constraints:**
- Primary key on `id`
- Enum constraint on `status` field (name: `book_status`)

**IMPORTANT:** Column names (`publisher`, `book_name`) are NOT being renamed in this story - only the table name changes. This maintains compatibility with existing queries.

### Migration Pattern
[Source: apps/api/alembic/versions/20251116_02_remove_book_version_field.py]
**File Structure:**
```python
"""<Description of migration>"""
from __future__ import annotations
from alembic import op
import sqlalchemy as sa

revision = "YYYYMMDD_NN"
down_revision = "<previous_revision_id>"
branch_labels = None
depends_on = None

def upgrade() -> None:
    # Migration logic

def downgrade() -> None:
    # Rollback logic
```

**Naming Convention:**
- Format: `YYYYMMDD_NN_description.py`
- Date: Current date in YYYYMMDD format
- NN: Sequence number (01, 02, etc.) for same-day migrations
- Description: Snake_case description

### Alembic Commands
[Source: Architecture docs and existing migrations]
**Location:** `apps/api/` (must run from this directory)

**Create Migration:**
```bash
cd apps/api
alembic revision -m "rename books table to publishers"
```

**Run Migration:**
```bash
alembic upgrade head
```

**Rollback:**
```bash
alembic downgrade -1  # Go back one migration
```

**Check Current Version:**
```bash
alembic current
```

**View Migration History:**
```bash
alembic history
```

### Database Connection
[Source: apps/api/app/core/config.py]
- Database: PostgreSQL
- Connection configured via `Settings.database_url` property
- Uses environment variables with `DCS_` prefix:
  - `DCS_DATABASE_HOST` (default: localhost)
  - `DCS_DATABASE_PORT` (default: 5432)
  - `DCS_DATABASE_USER` (default: dream_admin)
  - `DCS_DATABASE_PASSWORD` (default: dream_password)
  - `DCS_DATABASE_NAME` (default: dream_central)

### Testing

[Source: Architecture 16-testing-strategy.md]
**Backend Testing:** Pytest

**Test Strategy for This Story:**
Since this is a pure database migration with no business logic changes, testing focuses on:
1. **Manual Migration Testing** (Task 5):
   - Run upgrade, verify table renamed
   - Verify data intact
   - Run downgrade, verify rollback
   - Re-run upgrade to final state
2. **Application Integration Testing:**
   - Start application after migration
   - Verify no errors in logs
   - Verify ORM can query the renamed table
3. **Constraint Verification** (Task 6):
   - Query database to confirm constraints preserved

**No unit tests required** for pure Alembic migrations. Testing is done via manual execution and verification.

**Test File Location:** `apps/api/tests/`
- Existing tests should continue to pass after migration
- Run test suite: `cd apps/api && pytest tests/`

### Project Structure
[Source: Architecture 12-unified-project-structure.md]
```
apps/api/
  alembic/
    versions/           ← Migration files go here
      YYYYMMDD_NN_description.py
    env.py             ← Alembic environment config
  app/
    models/
      book.py          ← Update __tablename__ here
    core/
      config.py        ← Database connection settings
  tests/               ← Test files
```

### Important Notes

**Why Only Table Name Changes:**
- Epic 8 Background: Epic 6 renamed the MinIO bucket from `books` to `publishers`
- Story 8.1 completes database alignment by renaming the table
- Story 8.2 will rename model classes and schemas
- Story 8.3 will rename API endpoints
- Column names stay as `publisher` and `book_name` for backward compatibility

**Data Safety:**
- `ALTER TABLE ... RENAME TO ...` is a metadata-only operation in PostgreSQL
- Does not copy data or modify rows
- Fast even with large tables
- Constraints are automatically preserved

**Development Environment:**
- This story assumes development environment (can reset database if needed)
- For production, would need additional safety checks and backup procedures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-14 | 1.0 | Implementation complete - all tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

- Successfully created Alembic migration file `20251214_01_rename_books_table_to_publishers.py`
- Migration file includes both `upgrade()` and `downgrade()` functions
- Updated ORM model `__tablename__` from "books" to "publishers" in `apps/api/app/models/book.py`
- Migration tested successfully in Docker environment:
  - Table renamed from `books` to `publishers`
  - Data integrity confirmed (0 rows, fresh database)
  - Application started successfully without errors
  - Downgrade tested and confirmed working (table restored to `books`)
  - Re-applied upgrade to final state
- All constraints preserved during rename:
  - Primary key constraint (`books_pkey`) on `id` column
  - Triggers (`books_updated_at_trigger`) preserved
  - Sequences (`books_id_seq`) preserved
  - All column definitions intact
- Migration executed inside Docker container using `docker exec infrastructure-api-1 alembic upgrade head`
- No breaking changes to existing functionality

### File List

**Created Files:**
- `apps/api/alembic/versions/20251214_01_rename_books_table_to_publishers.py` - Migration file with upgrade/downgrade functions

**Modified Files:**
- `apps/api/app/models/book.py` - Updated `__tablename__ = "publishers"` (line 26)

---

## QA Results

(To be populated by QA Agent)
