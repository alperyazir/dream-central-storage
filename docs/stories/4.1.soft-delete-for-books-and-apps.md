# Story 4.1: Soft-Delete for Books and Apps

## Status
Done

## Story
**As an** administrator,
**I want** to soft-delete books and app builds,
**so that** I can remove them from the main view without permanently losing them immediately.

## Acceptance Criteria
1. New API endpoints are created to handle soft-delete requests (e.g., `DELETE /books/{book_id}`).
2. When an item is deleted, its corresponding folder in MinIO is moved from the `books` or `apps` bucket to the `trash` bucket.
3. The path of the item within the `trash` bucket must be preserved to allow for restoration.
4. For books, the metadata `status` field in the database is updated to `archived`.
5. "Delete" buttons are added to the book and app lists in the Admin Panel UI, which trigger the soft-delete API call.

## Tasks / Subtasks
- [x] Implement backend soft-delete endpoints for books and app builds (AC: 1, 4) [Source: docs/stories/1.4.book-crud-endpoints.md#dev-notes]
  - [x] Extend `apps/api/app/routers/books.py` with `DELETE /books/{book_id}` using the existing JWT dependency and returning the updated book record with `status="archived"` (AC: 1, 4) [Source: architecture/4-data-models.md#book]
  - [x] Add a JWT-protected route under `apps/api/app/routers/apps.py` (e.g., `DELETE /apps/{platform}` with body/query for target path) to initiate app build soft-delete operations (AC: 1) [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#dev-notes]
- [x] Create storage service helpers to relocate prefixes into the `trash` bucket (AC: 2, 3) [Source: docs/stories/2.1.minio-service-connection-bucket-setup.md#dev-notes]
  - [x] Add a MinIO helper that moves all objects for a given prefix into `trash/{prefix}` while preserving the original relative path (AC: 2, 3) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-notes]
  - [x] Record audit logs capturing actor, source bucket, and target trash path per requirement FR7 (AC: 2, 3) [Source: docs/prd/requirements.md#functional]
- [x] Update repositories and models to flag archived books (AC: 4) [Source: docs/stories/1.4.book-crud-endpoints.md#dev-notes]
  - [x] Add a repository method that sets `Book.status` to `archived` and timestamps the update within an atomic transaction (AC: 4) [Source: architecture/4-data-models.md#book]
  - [x] Ensure the soft-delete service coordinates database updates with storage relocation, rolling back when MinIO operations fail (AC: 2, 4) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Wire dashboard delete controls to the new endpoints (AC: 5) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]
  - [x] Add delete actions to book rows with confirmation modals that call the soft-delete API and refresh table state (AC: 5) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
  - [x] Provide delete controls for app builds that submit the selected platform/path, surface optimistic feedback, and reuse shared API helpers (AC: 5) [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#dev-notes]
- [x] Testing and validation (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add Pytest coverage for happy path, missing resource, and MinIO failure scenarios on the new delete endpoints (AC: 1, 2, 3, 4) [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#dev-notes]
  - [x] Extend Vitest + React Testing Library coverage for dashboard delete interactions, ensuring tables refresh and error states render (AC: 5) [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#tasks--subtasks]
  - [x] Run admin panel and API lint/test/build commands to confirm regressions are not introduced (AC: 1, 2, 3, 4, 5) [Source: architecture/3-tech-stack.md#3-tech-stack]

## Dev Notes
### Previous Story Insights
- Dashboard tables already expose the book metadata and app build listings that delete controls must extend; reuse table rendering patterns and data refresh hooks. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]
- Upload UI story added shared API helpers for multipart requests and modal flows; leverage the same client structure for delete calls and UI feedback states. [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#dev-notes]
- MinIO connection, bucket bootstrap, and storage helpers exist; soft-delete logic should reuse the established client factory and bucket constants. [Source: docs/stories/2.1.minio-service-connection-bucket-setup.md#dev-notes]

### Data Models
- `Book.status` supports the `archived` value required for soft deletion; ensure repository updates respect the enum constraint. [Source: architecture/4-data-models.md#book]
- No dedicated app build metadata model exists; the storage listing tree uses `path`, `type`, and `size` fields returned by `/storage/apps/{platform}`. [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#dev-notes]

### API Specifications
- Book CRUD endpoints live under `/books`; align the soft-delete route with existing REST conventions and JWT protection. [Source: docs/stories/1.4.book-crud-endpoints.md#dev-notes]
- Storage endpoints already normalize prefixes for books (`publisher/book_name`) and apps (`platform/version`); reuse those conventions when constructing delete requests and trash paths. [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-notes]

### Component Specifications
- System architecture keeps MinIO operations in backend services and exposes functionality via REST APIs consumed by the React admin panel. [Source: architecture/6-components.md#6-components]
- UI actions that alter data should run within modals to preserve context and rely on existing dashboard patterns. [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]

### File Locations
- Backend routers reside in `apps/api/app/routers`, storage helpers in `apps/api/app/services`, and repository logic in `apps/api/app/repositories`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
- Frontend dashboard components live under `apps/admin-panel/src/pages` with supporting API utilities in `apps/admin-panel/src/services`. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]

### Testing Requirements
- Follow the existing Pytest patterns with mocked MinIO clients to validate storage relocation and error handling. [Source: architecture/16-testing-strategy.md#16-testing-strategy]
- Frontend tests should use Vitest + React Testing Library to assert button visibility, confirmation flows, and state updates post-delete. [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#tasks--subtasks]

### Technical Constraints
- Maintain transaction integrity by updating the database only after storage relocation succeeds, reverting changes if MinIO operations fail. [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- Log every delete action for auditing while excluding credentials, satisfying FR7 audit requirements. [Source: docs/prd/requirements.md#functional]
- Preserve original path prefixes inside the `trash` bucket to support restoration workflows in Story 4.2. [Source: docs/prd/requirements.md#functional]
- Retain trash contents for at least seven days as noted in NFR3; avoid permanent deletion logic in this story. [Source: docs/prd/requirements.md#non-functional]

### Project Structure Notes
- Keep new backend modules within the existing FastAPI app scope and ensure shared services remain reusable by upcoming restore workflows. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
- Frontend changes should extend the dashboard component rather than creating separate pages to align with the dashboard-centric UX vision. [Source: docs/prd/user-interface-design-goals.md#overall-ux-vision]

## Testing
- Pytest API suite: `pytest` (apps/api/) — 53 tests passed.
- Vitest UI suite: `npm test -- --run` (apps/admin-panel/) — 15 tests passed.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-29 | 0.2 | Implemented backend/frontend soft-delete flows with automated tests. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (apps/api/)
- `npm test -- --run` (apps/admin-panel/)

### Completion Notes List
- Added MinIO relocation helper and DELETE endpoints to archive books and move application builds into the trash bucket.
- Extended repositories and automated tests to cover soft-delete success paths, missing resources, and storage failures.
- Updated dashboard UI with confirmation dialog, API helpers, and Vitest coverage for book and app delete flows.

### File List
- apps/api/app/services/storage.py
- apps/api/app/services/__init__.py
- apps/api/app/routers/books.py
- apps/api/app/routers/apps.py
- apps/api/app/repositories/book.py
- apps/api/tests/test_books_endpoints.py
- apps/api/tests/test_apps_upload.py
- apps/api/tests/test_storage_service.py
- apps/admin-panel/src/pages/Dashboard.tsx
- apps/admin-panel/src/lib/api.ts
- apps/admin-panel/src/lib/books.ts
- apps/admin-panel/src/lib/apps.ts
- apps/admin-panel/src/__tests__/dashboard.test.tsx

## QA Results

### Review Date: 2025-09-29
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- PASS – Soft-delete endpoints reuse shared auth patterns and centralized MinIO relocation helper, keeping logic consistent with prior stories (`apps/api/app/routers/books.py:123`, `apps/api/app/routers/apps.py:96`, `apps/api/app/services/storage.py:156`).

### Acceptance Criteria Validation
- AC1 – `DELETE /books/{book_id}` and `DELETE /apps/{platform}` implemented with JWT enforcement and validated request payloads (`apps/api/app/routers/books.py:123`, `apps/api/app/routers/apps.py:96`).
- AC2 & AC3 – `move_prefix_to_trash` copies objects into the trash bucket while preserving bucket/prefix structure (`apps/api/app/services/storage.py:156`).
- AC4 – Repository archive helper marks books as `archived` post-relocation (`apps/api/app/repositories/book.py:37`).
- AC5 – Dashboard actions invoke confirmation dialog and refresh tables after successful deletion (`apps/admin-panel/src/pages/Dashboard.tsx:244`).

### Test Review
- Pytest suite covers relocation success/failure plus API delete endpoints and status transitions (`apps/api/tests/test_storage_service.py:76`, `apps/api/tests/test_books_endpoints.py:148`, `apps/api/tests/test_apps_upload.py:102`).
- Vitest exercises book/app delete flows, including happy path refresh and failure messaging (`apps/admin-panel/src/__tests__/dashboard.test.tsx:547`).
- Manual command verification: `pytest` (apps/api/) – 53 tests; `npm test -- --run` (apps/admin-panel/) – 15 tests.

### NFR Assessment
- Security: PASS – Endpoints require valid bearer token and reuse existing auth dependencies (`apps/api/app/routers/books.py:33`, `apps/api/app/routers/apps.py:36`).
- Performance: PASS – Relocation streams objects via MinIO SDK; keep an eye on very large prefixes but acceptable for current scope (`apps/api/app/services/storage.py:180`).
- Reliability: PASS – Errors from MinIO produce clear HTTP 502 responses surfaced to the UI with actionable messaging (`apps/api/app/routers/books.py:150`, `apps/admin-panel/src/pages/Dashboard.tsx:283`).
- Maintainability: PASS – Shared helper consolidates relocation logic and UI tests document expected flows (`apps/api/app/services/__init__.py:3`, `apps/admin-panel/src/__tests__/dashboard.test.tsx:581`).

### Issues & Risks
- None observed.

### Recommendations
- Future: consider pagination/streaming safeguards in `move_prefix_to_trash` for extremely large prefixes to avoid memory spikes (`apps/api/app/services/storage.py:168`).

### Gate Decision Recommendation
- Recommend **PASS** – Feature meets ACs with comprehensive automated coverage and no blocking findings.

### Suggested Status
- Ready for Done

### Review Date: 2025-10-03
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- PASS – Soft-delete endpoints coordinate MinIO relocation with repository updates and emit traceable audit logs for admins (`apps/api/app/routers/books.py:123`, `apps/api/app/routers/apps.py:142`).

### Acceptance Criteria Validation
- AC1 – `DELETE /books/{book_id}` and `DELETE /apps/{platform}` accept authenticated requests and validate payloads before executing (`apps/api/app/routers/books.py:123`, `apps/api/app/routers/apps.py:125`).
- AC2 & AC3 – `move_prefix_to_trash` keeps bucket/prefix paths intact when moving into `trash`, enabling future restores (`apps/api/app/services/storage.py:146`).
- AC4 – Repository helper archives books within the same request scope once relocation succeeds (`apps/api/app/repositories/book.py:37`).
- AC5 – Admin dashboard prompts for confirmation, calls the new APIs, and refreshes data on success (`apps/admin-panel/src/pages/Dashboard.tsx:214`).

### Test Review
- `pytest apps/api/tests/test_storage_service.py apps/api/tests/test_books_endpoints.py apps/api/tests/test_apps_upload.py`
- `npm test -- --run` inside `apps/admin-panel`

### NFR Assessment
- Security: PASS – Routes reuse the JWT guard and reject malformed tokens (`apps/api/app/routers/books.py:27`, `apps/api/app/routers/apps.py:38`).
- Performance: PASS – Relocation streams MinIO objects individually; acceptable for current dataset, though large prefixes should be monitored (`apps/api/app/services/storage.py:156`).
- Reliability: PASS – Relocation failures surface 502 responses and keep DB state unchanged, matching rollback expectations (`apps/api/app/routers/books.py:150`).
- Maintainability: PASS – Shared storage helper centralizes behavior and is exercised by unit tests covering success/failure paths (`apps/api/app/services/__init__.py:7`, `apps/api/tests/test_storage_service.py:83`).

### Issues & Risks
- None observed.

### Recommendations
- Future: Consider chunked iteration over MinIO listings to better handle extremely large prefixes without materializing all items (`apps/api/app/services/storage.py:150`).

### Gate Decision Recommendation
- Recommend **PASS** – Implementation meets the acceptance criteria with solid automated coverage.

### Suggested Status
- Ready for Done
