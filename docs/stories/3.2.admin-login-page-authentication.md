# Story 3.2: Admin Login Page & Authentication

## Status
Done

## Story
**As an** administrator,
**I want** to log in through a user interface,
**so that** I can securely access the Admin Panel.

## Acceptance Criteria
1. A `/login` page is created with fields for an email/username and password.
2. Submitting the form calls the `POST /auth/login` API endpoint.
3. On successful login, the returned JWT is securely stored, and the user is redirected to the dashboard.
4. An appropriate error message is displayed on the login page if authentication fails.
5. A state management solution (e.g., Zustand, Redux Toolkit) is implemented to manage the user's authentication state globally.

## Tasks / Subtasks
- [x] Implement login page UI (AC: 1, 4) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Build the `/login` route view with email and password inputs using the established component patterns (AC: 1) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Apply Material UI form components and ensure accessible labels, helper text, and submit button states (AC: 1, 4) [Source: architecture/3-tech-stack.md#3-tech-stack]
- [x] Integrate authentication API call (AC: 2) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Use the shared service layer to call `POST /auth/login` and parse the JWT payload (AC: 2) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Handle HTTP errors and surface a form-level error message for failed authentication (AC: 4) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
- [x] Manage authenticated session state with Zustand (AC: 3, 5) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Create an auth store that persists the JWT/token metadata using the prescribed state management approach (AC: 3, 5) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Keep JWT data in memory within the Zustand store and avoid localStorage/sessionStorage to minimize exposure to XSS (AC: 3) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Expose selectors/actions for login, logout, and auth checks that other routes can reuse (AC: 3, 5) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Redirect authenticated users and protect routes (AC: 3) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Implement a route guard that redirects unauthenticated access back to `/login` (AC: 3) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Redirect to the dashboard route after a successful login mutation resolves (AC: 3) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Testing and validation (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add Vitest + RTL tests for successful login, error messaging, and protected-route redirects (AC: 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Ensure workspace scripts run lint/test/build for the login feature without regressions (AC: 1) [Source: architecture/3-tech-stack.md#3-tech-stack]

## Dev Notes
### Previous Story Insights
- Story 3.1 established the `apps/admin-panel` React app with router scaffolding, placeholder Login/Dashboard routes, and a persistent layout shell to integrate new views. [Source: docs/stories/3.1.react-app-initialization-layout.md#dev-notes]
- The admin panel already exposes a typed environment configuration module and API helper wrappers for backend communication, which should be reused for authentication calls. [Source: docs/stories/3.1.react-app-initialization-layout.md#dev-agent-record]

### Data Models
- Authentication uses the `User` entity with `email` and `hashed_password` fields; sanitized responses should align with the `SafeUser` shape that omits credentials. [Source: architecture/4-data-models.md#user]

### API Specifications
- The REST API includes dedicated authentication endpoints; the login form must align with the existing Auth contract defined by the backend services. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Follow the frontend architecture guidance for organizing route-level views, with React Router used for navigation and guarded routes. [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- UI should leverage the Material UI component library for form controls to stay consistent with the design system. [Source: architecture/3-tech-stack.md#3-tech-stack]

### File Locations
- Place login-related pages, hooks, and stores within the `apps/admin-panel` workspace, keeping route components under the established `src` structure for the admin app. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Implement unit/component tests with Vitest and React Testing Library to cover user interaction flows and auth guards. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Frontend must continue using React 18+, TypeScript, React Router, and Zustand per the tech stack decisions for consistency across the admin panel. [Source: architecture/3-tech-stack.md#3-tech-stack]
- Handle authentication flows with attention to frontend security practices when surfacing errors or storing tokens. [Source: architecture/15-security-and-performance.md#15-security-and-performance]
- Store JWTs only in the in-memory Zustand state and avoid persistent browser storage to reduce XSS exposure. [Source: architecture/15-security-and-performance.md#15-security-and-performance]

## Testing
- Write Vitest + RTL specs under the admin panel `src/__tests__` directory to exercise login success, failure, and protected-route behavior. [Source: architecture/16-testing-strategy.md#16-testing-strategy]
- Execute the existing workspace lint/test/build commands defined for the admin panel to verify no regressions are introduced. [Source: architecture/3-tech-stack.md#3-tech-stack]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-28 | 0.2 | Login UI and auth flow implemented with protected routing and tests. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- No additional debug tooling required.

### Completion Notes List
- Delivered Material UI login form with inline validation and friendly error messaging.
- Added dedicated auth service and in-memory Zustand store that preserves JWT without browser storage.
- Introduced ProtectedRoute wrapper and logout-aware navigation to guard dashboard access.
- Implemented Vitest suites covering login success, failure messaging, and protected-route redirects.
- Verified lint, unit tests, and production build for the admin panel workspace.

### File List
- apps/admin-panel/package.json
- apps/admin-panel/src/App.tsx
- apps/admin-panel/src/__tests__/auth.test.tsx
- apps/admin-panel/src/__tests__/layout.test.tsx
- apps/admin-panel/src/components/NavBar.tsx
- apps/admin-panel/src/lib/auth.ts
- apps/admin-panel/src/pages/Login.tsx
- apps/admin-panel/src/routes/ProtectedRoute.tsx
- apps/admin-panel/src/stores/auth.ts
- apps/admin-panel/src/styles/navbar.css
- docs/stories/3.2.admin-login-page-authentication.md
- package-lock.json

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Implementation keeps JWT strictly in-memory via Zustand store, aligning with security guidance and avoiding browser persistence.
- Login page leverages MUI components with accessible labeling and clears server errors on field edits for a responsive UX.
- ProtectedRoute enforces authentication guard consistently, and NavBar logout reuses shared store logic without redundant navigation code.

### Requirements Traceability
- **AC1** – Covered by `auth.test.tsx` (unauthenticated redirect displays login form inputs) and `layout.test.tsx` (login fields rendered post-logout).
- **AC2** – `auth.test.tsx` verifies the `POST /auth/login` request payload and invocation.
- **AC3** – `auth.test.tsx` asserts dashboard redirect after successful login; store captures token metadata.
- **AC4** – `auth.test.tsx` failure path confirms inline error alert and re-enabled submit.
- **AC5** – Zustand store exercises global auth state; tests demonstrate guard + logout behavior.

### Test Architecture Assessment
- Unit/component tests target auth happy-path, failure messaging, and guard behavior with store resets wrapped in `act` to silence async warnings.
- Fetch mocking validates request body normalization while avoiding network access; no brittle implementation details asserted.
- Suggested future addition: introduce integration-level coverage once backend stubs are available (non-blocking).

### NFR Validation
- **Security:** PASS – Tokens never written to storage; errors remain generic to avoid leakage.
- **Performance:** PASS – Minimal client processing; API interaction delegated to shared client.
- **Reliability:** PASS – Guard handles logout redirect; tests cover failure recovery and state reset.
- **Maintainability:** PASS – Store/api modules isolated, with tests documenting expected flows.

### Testability Evaluation
- Controllability achieved via injected store helpers and fetch spies.
- Observability ensured through MUI `Alert` and route assertions.
- Debuggability aided by concentrated auth store and unit tests around edge cases.

### Risk Summary
- Residual Risk: Low – Remaining work involves future integration tests when backend fixtures exist; no blockers detected.

### Gate Decision Recommendation
- Recommend **PASS**. Story may move to "Ready for Done" once team reviews.

### Tests Observed
- `npm run lint --workspace apps/admin-panel`
- `npm run test --workspace apps/admin-panel -- --run`
- `npm run build --workspace apps/admin-panel`

### Additional Notes
- Consider adding integration/e2e coverage once API contract testing harness is available (tracking item, not required now).
