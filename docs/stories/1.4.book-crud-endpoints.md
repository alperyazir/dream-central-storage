# Story 1.4: Book CRUD Endpoints

## Status
Done

## Story
**As an** administrator,
**I want** API endpoints to create, read, update, and list book metadata,
**so that** I can manage the book catalog programmatically.

## Acceptance Criteria
1. All endpoints in this story are protected and require a valid JWT for access.
2. `POST /books`: Creates a new book metadata record in the database.
3. `GET /books`: Returns a list of all book metadata records.
4. `GET /books/{book_id}`: Retrieves the metadata for a single book.
5. `PUT /books/{book_id}`: Updates the metadata for an existing book.

## Tasks / Subtasks
- [x] Secure book endpoints with JWT dependency injection (AC: 1) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
  - [x] Add authentication dependency that verifies JWT tokens for protected routes (AC: 1) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Ensure unauthorized requests yield HTTP 401 responses across the books router (AC: 1) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
- [x] Implement book repository operations for persistence (AC: 2, 3, 4, 5) [Source: architecture/2-high-level-architecture.md#architectural-patterns]
  - [x] Add create/list/get/update methods leveraging SQLAlchemy session patterns (AC: 2, 3, 4, 5) [Source: docs/stories/1.2.book-metadata-model-database-migration.md#dev-agent-record]
  - [x] Handle not-found cases with domain-appropriate exceptions (AC: 4, 5) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Expose book HTTP endpoints (AC: 1, 2, 3, 4, 5) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Create `POST /books` route validating request payload and returning `201 Created` with persisted record (AC: 2) [Source: architecture/4-data-models.md#book]
  - [x] Add `GET /books` to return paginated or full list per API contract (AC: 3) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Add `GET /books/{book_id}` to fetch single resource, returning 404 when missing (AC: 4) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Add `PUT /books/{book_id}` to update fields allowed by schema, ensuring status enum constraints (AC: 5) [Source: architecture/4-data-models.md#book]
- [x] Integrate schema models for request/response shapes (AC: 2, 3, 4, 5) [Source: architecture/4-data-models.md#book]
  - [x] Introduce Pydantic schemas for create/update operations including validation rules (AC: 2, 5) [Source: architecture/4-data-models.md#book]
  - [x] Ensure read responses leverage ORM mode to serialize SQLAlchemy entities (AC: 3, 4) [Source: architecture/4-data-models.md#book]
- [x] Add backend tests verifying CRUD behaviour (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write tests covering happy paths for create/list/get/update flows with JWT auth (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Include failure cases (unauthorized, not found, validation errors) to ensure robust error handling (AC: 1, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Dev Notes
### Previous Story Insights
- Authentication endpoints and JWT issuance are already implemented; reuse security utilities and patterns for protecting book routes. [Source: docs/stories/1.3.user-authentication-endpoints.md#dev-agent-record]
- Book schema, migrations, and repository scaffolding were introduced previously; extend those modules for CRUD coverage. [Source: docs/stories/1.2.book-metadata-model-database-migration.md#dev-agent-record]

### Data Models
- Book metadata requires fields (`id`, `publisher`, `book_name`, `language`, `category`, `version?`, `status`, `created_at`, `updated_at`) with status constrained to `draft`, `published`, `archived`. [Source: architecture/4-data-models.md#book]

### API Specifications
- CRUD routes must follow the documented REST contract for path structure, payloads, and response codes. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- No specific guidance found in architecture docs.

### File Locations
- Router modules live under `apps/api/app/routers`; repository logic under `apps/api/app/repositories`; tests under `apps/api/tests`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Use Pytest to cover repository logic and endpoint behaviour, integrated with the existing test suite. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Implement using FastAPI, SQLAlchemy, and JWT-based auth per project standards. [Source: architecture/3-tech-stack.md#3-tech-stack]
- Maintain repository pattern, session management, and security best practices. [Source: architecture/11-backend-architecture.md#11-backend-architecture]

### Project Structure Notes
- New code must stay within the `apps/api` boundary to respect monorepo organization. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing
- Ensure tests run via `pytest` without extra setup so CI continues to pass. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | Implementation completed; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Added unit coverage for JWT decoding per QA guidance. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from `apps/api/`, 20 tests passed)

### Completion Notes List
- Added JWT validation helper and protected all book routes with Bearer token enforcement.
- Extended `BookRepository` with commit-aware create/update helpers to persist changes reliably.
- Implemented `/books` CRUD endpoints returning Pydantic schemas and consistent HTTP responses.
- Authored integration tests covering authorized flows, unauthorized access, and failure conditions for book APIs.
- Added unit tests verifying `decode_access_token` handles valid payloads, tampered signatures, and expirations.

### File List
- apps/api/app/core/security.py
- apps/api/app/main.py
- apps/api/app/repositories/book.py
- apps/api/app/routers/__init__.py
- apps/api/app/routers/books.py
- apps/api/tests/test_books_endpoints.py
- apps/api/tests/test_security.py
- docs/stories/1.4.book-crud-endpoints.md

## QA Results
- Gate: PASS â€“ Authenticated CRUD endpoints meet acceptance criteria with repository commits, JWT validation, and updated regression coverage (`apps/api/app/routers/books.py:1`, `apps/api/tests/test_books_endpoints.py:1`).
- Evidence:
  - Repository helpers commit and refresh entities, ensuring API responses reflect database state (`apps/api/app/repositories/book.py:9`).
  - `/books` router enforces Bearer authentication and returns expected status codes for create/list/get/update flows (`apps/api/app/routers/books.py:22`).
  - Pytest suite verifies authorized paths, unauthorized access, 404 handling, state changes, and now unit coverage for JWT decode logic (`apps/api/tests/test_books_endpoints.py:92`, `apps/api/tests/test_security.py:1`).
- Residual Risks:
  - None identified; decoder now has focused unit tests, closing the previous advisory.
