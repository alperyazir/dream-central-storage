# Story 5.12: Media Preview in Book Explorer

## Status
Done

## Story
**As an** administrator,
**I want** to preview media assets (audio, video, images) directly inside the book explorer,
**so that** I can validate uploaded content without downloading files or leaving the admin panel.

## Story Context
**Existing System Integration:**
- Builds on: Book content explorer drawer (Story 5.11), storage download endpoints, range-enabled streaming support from earlier requirements. [Source: docs/stories/5.11.book-content-explorer.md#story-context; docs/prd/requirements.md#functional]
- Technology: React + Material UI frontend, HTML5 media elements, FastAPI proxy endpoints supporting Range headers, MinIO storage. [Source: docs/architecture/3-tech-stack.md#3-tech-stack]
- Touch points: Explorer components, storage client helpers, admin toasts, and MinIO object downloads.

## Acceptance Criteria
1. Explorer surfaces inline previews when a supported image file is selected (PNG, JPG, WebP), showing a responsive thumbnail/lightbox within the drawer.
2. Audio files (e.g., MP3, WAV) render an HTML5 audio player that streams content via range requests through the existing file endpoint without forcing full download.
3. Video files (e.g., MP4) render an HTML5 video player with play/pause controls and scrub support using Range; playback errors surface user-friendly messages.
4. Files with unsupported types retain existing download actions and show a message indicating previews are unavailable.
5. Automated tests cover preview component selection logic, range-enabled fetch invocation, and graceful handling of failed media loads.

## Tasks / Subtasks
- [x] Extend explorer UI to detect file type by extension/MIME metadata and render appropriate preview component (AC: 1-4) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- [x] Implement image preview component with responsive containment, alt text, and close interaction (AC: 1) [Source: docs/stories/5.7.refresh-admin-ui-light-turquoise.md#dev-notes]
- [x] Create audio player wrapper using HTML5 `<audio>` element wired to signed/proxied download URLs with `Range` header support (AC: 2) [Source: docs/prd/requirements.md#functional]
- [x] Create video player wrapper using HTML5 `<video>` with range streaming and fallback poster messaging (AC: 3) [Source: docs/prd/requirements.md#non-functional]
- [x] Update storage client to provide helper for constructing preview URLs and headers; ensure it reuses auth tokens (AC: 2, 3) [Source: apps/admin-panel/src/lib/storage.ts]
- [x] Add Vitest + RTL coverage for preview selection, rendering, and error handling (AC: 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [x] Update operator/admin documentation describing preview capabilities and supported formats (AC: 4) [Source: docs/operations/minio-backup-runbook.md]

## Dev Notes
### Previous Story Insights
- Story 2.4 established storage listing contract; use returned paths for preview fetches. [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#dev-notes]
- Story 5.5 introduced toast/error conventions for storage operations; reuse them for preview errors. [Source: docs/stories/5.5.permanent-delete-from-trash.md#dev-notes]

### Data Models
- No schema changes; previews rely on existing object naming and config metadata. Ensure fallback copy uses book title/config data when available. [Source: docs/stories/5.8.config-json-book-upload-metadata.md#acceptance-criteria]

### API Specifications
- Download endpoints already support Range requests and JWT auth; previews should leverage streaming without new backend work. [Source: docs/prd/requirements.md#functional]
- Consider cache-busting via query params when reusing URLs to avoid stale content. [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture]

### Component Specifications
- Preview components must respect accessibility: keyboard focus, captions/labels, and alternative text. [Source: docs/prd/user-interface-design-goals.md#overall-ux-vision]
- Maintain light turquoise palette and spacing tokens for overlay/drawer backgrounds. [Source: docs/stories/5.7.refresh-admin-ui-light-turquoise.md#dev-notes]

### File Locations
- Frontend components under `apps/admin-panel/src/features/books/explorer` (new) or similar; shared previews in `apps/admin-panel/src/components/media`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]
- Client helper updates in `apps/admin-panel/src/lib/storage.ts`.

### Testing Requirements
- Vitest + RTL to simulate selecting supported/unsupported files, verifying preview elements, and error state messaging. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- Consider lightweight Cypress/Playwright manual script later for full playback validation.

### Technical Constraints
- Ensure range streaming uses chunked buffering to prevent large in-memory loads; rely on browser media buffering. [Source: docs/prd/requirements.md#non-functional]
- Provide fallback message when browser cannot play a given format (e.g., unsupported codec). [Source: docs/prd/requirements.md#functional]

### Project Structure Notes
- Avoid coupling preview logic directly with tree component; maintain separation for testability. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Risk and Compatibility Check
- Primary Risk: Large media files stuttering due to network; ensure Range requests respected and show loading indicator.
- Mitigation: Provide buffering state, allow manual download fallback.
- Rollback: Disable previews behind feature flag, retain explorer baseline.

### Validation Checklist
- [x] Preview only mounted when supported file selected.
- [x] Audio/video players honour Range and resume playback after pause.
- [x] Accessibility labels/controls meet admin panel standards.
- [x] Unsupported files show clear call-to-action for download.

## Testing
- Frontend: Vitest + RTL for preview logic; mock fetch responses for Range handling.
- Manual: In staging, open explorer, preview image/audio/video assets, confirm playback and fallback states.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-06 | 0.1 | Initial draft detailing media preview capability inside explorer. | John (Product Manager) |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- None

### Completion Notes List
- Media preview pipeline loads image, audio, and video assets with loading indicators and inline error handling.
- Storage client helper now exposes authenticated preview requests with optional Range headers.
- Added Vitest + RTL suites covering preview rendering, unsupported messaging, and error scenarios.
- Skipped `npx turbo run test --filter=admin-panel` per prior instruction; no alternative local test run executed.

### File List
- apps/admin-panel/src/features/books/BookExplorerDrawer.tsx
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/__tests__/bookExplorerDrawer.test.tsx
- apps/admin-panel/src/__tests__/storage.test.ts
- docs/operations/minio-backup-runbook.md

## QA Results
- 
