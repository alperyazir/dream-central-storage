# Story 6.4: Activate Teachers Storage Namespace

## Status

Done

## Story

**As a** teacher,
**I want** a dedicated storage namespace for my custom materials,
**so that** I can upload and manage teaching resources independently from publisher content.

## Acceptance Criteria

1. The existing `teachers` bucket configuration is verified active and bucket is created on startup.
2. New API endpoints are created for teacher material management:
   - `POST /teachers/{teacher_id}/upload` - Upload material to teacher namespace
   - `GET /teachers/{teacher_id}/materials` - List teacher's materials
   - `GET /teachers/{teacher_id}/materials/{path}` - Download specific material
   - `DELETE /teachers/{teacher_id}/materials/{path}` - Soft-delete material to trash
3. Storage path structure follows: `teachers/{teacher_id}/materials/{filename}`.
4. Teacher uploads support common file types (PDF, images, audio, video, documents).
5. Trash operations support teacher materials with correct bucket detection and restore logic.
6. Admin panel displays teacher materials in a dedicated section (optional, can be deferred).
7. Automated tests cover upload, list, download, and delete operations for teacher materials.

## Tasks / Subtasks

- [x] **Task 1: Verify Teachers Bucket Configuration (AC: 1)**
  - [x] Confirm `minio_teachers_bucket` exists in `apps/api/app/core/config.py:41` with value `"teachers"`
  - [x] Confirm `minio_buckets` property at line 70-78 includes `minio_teachers_bucket`
  - [x] Verify `init_minio.py` creates the `teachers` bucket on startup
  - [x] Confirm teacher-specific config settings exist:
    - `teacher_quota_bytes` (500MB default)
    - `teacher_max_file_size_bytes` (100MB default)
    - `teacher_allowed_mime_types` property
    - `teacher_all_allowed_mime_types` property

- [x] **Task 2: Create Teachers Router File (AC: 2, 3, 4)**
  - [x] Create new file: `apps/api/app/routers/teachers.py`
  - [x] Import required modules following books.py pattern:
    ```python
    from fastapi import APIRouter, Depends, HTTPException, UploadFile, Query, status
    from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer
    from fastapi.responses import StreamingResponse
    from sqlalchemy.orm import Session
    from app.core.config import get_settings
    from app.services import get_minio_client, move_prefix_to_trash
    ```
  - [x] Define router: `router = APIRouter(prefix="/teachers", tags=["Teachers"])`
  - [x] Implement `_require_admin()` authentication helper (copy from storage.py)
  - [x] Implement `_build_teacher_object_key(teacher_id, relative_path)` helper:
    - Path structure: `{teacher_id}/materials/{relative_path}`
  - [x] Implement `_validate_file_type(content_type)` helper using `settings.teacher_all_allowed_mime_types`

- [x] **Task 3: Implement Upload Endpoint (AC: 2, 3, 4)**
  - [x] Create `POST /teachers/{teacher_id}/upload` endpoint
  - [x] Validate file MIME type against `settings.teacher_all_allowed_mime_types`
  - [x] Validate file size against `settings.teacher_max_file_size_bytes`
  - [x] Upload to path: `{teacher_id}/materials/{filename}`
  - [x] Return upload manifest with file path and size

- [x] **Task 4: Implement List Materials Endpoint (AC: 2, 3)**
  - [x] Create `GET /teachers/{teacher_id}/materials` endpoint
  - [x] Use `list_objects_tree()` from storage service
  - [x] Prefix: `{teacher_id}/materials/`
  - [x] Return hierarchical tree of teacher's materials

- [x] **Task 5: Implement Download Endpoint (AC: 2, 3)**
  - [x] Create `GET /teachers/{teacher_id}/materials/{path:path}` endpoint
  - [x] Support HTTP Range requests (copy pattern from storage.py download_book_object)
  - [x] Use `_get_media_type()` for content-type detection
  - [x] Stream file content with proper headers

- [x] **Task 6: Implement Delete (Soft-Delete) Endpoint (AC: 2, 5)**
  - [x] Create `DELETE /teachers/{teacher_id}/materials/{path:path}` endpoint
  - [x] Use `move_prefix_to_trash()` from storage service
  - [x] Source bucket: `settings.minio_teachers_bucket`
  - [x] Trash path structure: `trash/teachers/{teacher_id}/materials/{filename}`

- [x] **Task 7: Update Trash Logic for Teachers Bucket (AC: 5)**
  - [x] Modify `list_trash_entries()` in `apps/api/app/services/storage.py:444-455`
  - [x] Add condition for teachers bucket:
    ```python
    elif bucket == "teachers" and len(parts) >= 3 and parts[1] == "materials":
        item_type = "teacher_material"
        prefix_parts = parts[1:3]  # ["materials", filename]
        metadata = {"teacher_id": parts[0].split("/")[-1], "material": parts[2]}
    ```
    Wait - need to reconsider path structure in trash:
    - Trash stores: `trash/{source_bucket}/{original_path}`
    - For teachers: `trash/teachers/{teacher_id}/materials/{filename}`
    - So parts after bucket would be: `[teacher_id, "materials", filename]`
  - [x] Add teacher bucket handling:
    ```python
    elif bucket == "teachers" and len(parts) >= 3 and parts[1] == "materials":
        item_type = "teacher_material"
        prefix_parts = parts[0:3]  # [teacher_id, "materials", filename]
        metadata = {"teacher_id": parts[0], "material_path": parts[2]}
    ```

- [x] **Task 8: Update Restore Logic for Teachers Bucket (AC: 5)**
  - [x] Add `_extract_teacher_identifiers()` helper in `apps/api/app/routers/storage.py`:
    ```python
    def _extract_teacher_identifiers(path_parts: list[str]) -> tuple[str, str]:
        if len(path_parts) < 3 or path_parts[1] != "materials":
            raise HTTPException(status.HTTP_400_BAD_REQUEST, detail="Teacher restore key is incomplete")
        return path_parts[0], path_parts[2]  # teacher_id, material_name
    ```
  - [x] Update `restore_item()` endpoint at line 538-556 to handle `bucket == "teachers"`
  - [x] Update `delete_trash_entry()` endpoint at line 609-621 to handle `bucket == "teachers"`

- [x] **Task 9: Register Teachers Router (AC: 2)**
  - [x] Add import in `apps/api/app/main.py`: `from app.routers import teachers`
  - [x] Register router: `app.include_router(teachers.router)`

- [x] **Task 10: Create Test File (AC: 7)**
  - [x] Create `apps/api/tests/test_teachers_endpoints.py`
  - [x] Test upload endpoint with valid file types
  - [x] Test upload endpoint rejects invalid MIME types
  - [x] Test upload endpoint enforces file size limits
  - [x] Test list materials endpoint
  - [x] Test download endpoint (full file and range requests)
  - [x] Test delete endpoint (soft-delete to trash)

- [x] **Task 11: Test Trash Integration (AC: 5, 7)**
  - [x] Update `apps/api/tests/test_storage_service.py` or create new test
  - [x] Test `list_trash_entries()` correctly aggregates teacher materials
  - [x] Test restore from trash for teacher materials
  - [x] Test permanent delete from trash for teacher materials

- [x] **Task 12: Run Full Test Suite (AC: 7)**
  - [x] Run `pytest apps/api/tests/test_teachers_endpoints.py -v`
  - [x] Run `pytest apps/api/tests/test_storage_service.py -v`
  - [x] Run full test suite: `pytest apps/api/tests/`

## Dev Notes

### Previous Story Insights (Story 6.3)
[Source: Story 6.3 Dev Agent Record]
- Trash path parsing updated to handle `/books/` segment for publishers bucket
- Pattern for bucket detection: `if bucket == "X" and len(parts) >= N and parts[i] == "keyword":`
- Pre-existing test failures (SQLite/JSONB compatibility) are unrelated to this epic

### Config Already Prepared
[Source: apps/api/app/core/config.py]

The teachers bucket and related settings already exist:

```python
# Line 41
minio_teachers_bucket: str = "teachers"

# Lines 44-46 - Teacher storage configuration
teacher_quota_bytes: int = 524288000  # 500MB default
teacher_max_file_size_bytes: int = 104857600  # 100MB default

# Lines 81-106 - Allowed MIME types property
@property
def teacher_allowed_mime_types(self) -> dict[str, list[str]]:
    return {
        "documents": ["application/pdf", "text/plain", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"],
        "images": ["image/jpeg", "image/png", "image/gif", "image/webp"],
        "audio": ["audio/mpeg", "audio/wav", "audio/ogg", "audio/mp4"],
        "video": ["video/mp4", "video/webm", "video/quicktime"],
    }

# Lines 108-115 - Flat list of all allowed MIME types
@property
def teacher_all_allowed_mime_types(self) -> list[str]:
    return [mime for mimes in self.teacher_allowed_mime_types.values() for mime in mimes]

# Lines 70-78 - Bucket list includes teachers
@property
def minio_buckets(self) -> list[str]:
    return [
        self.minio_publishers_bucket,
        self.minio_apps_bucket,
        self.minio_trash_bucket,
        self.minio_teachers_bucket,
    ]
```

### Path Structure
[Source: Epic 6.4 Technical Notes]

**Teacher Materials Path:**
```
teachers/{teacher_id}/materials/{filename}
```

**Trash Path Structure:**
```
trash/teachers/{teacher_id}/materials/{filename}
```

**Path Parts Breakdown (when parsing trash objects):**
```
Object: trash/teachers/teacher_123/materials/lesson.pdf
Split by "/": ["teachers", "teacher_123", "materials", "lesson.pdf"]
             parts[0]     parts[1]        parts[2]     parts[3]

Extraction:
- bucket = parts[0] = "teachers"
- teacher_id = parts[1] = "teacher_123"
- materials_segment = parts[2] = "materials" (validate this!)
- filename = parts[3] = "lesson.pdf"
- key = "teachers/teacher_123/materials/"
```

### Router Pattern to Follow
[Source: apps/api/app/routers/books.py, apps/api/app/routers/storage.py]

```python
router = APIRouter(prefix="/teachers", tags=["Teachers"])
_bearer_scheme = HTTPBearer(auto_error=True)
logger = logging.getLogger(__name__)

# Use same _require_admin pattern from storage.py:137-157
# Use get_settings() and get_minio_client(settings) pattern
# Use StreamingResponse for downloads with Range header support
```

### Key Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `apps/api/app/routers/teachers.py` | CREATE | New router for teacher endpoints |
| `apps/api/app/main.py` | MODIFY | Register teachers router |
| `apps/api/app/services/storage.py` | MODIFY | Update `list_trash_entries()` for teachers bucket (lines 444-455) |
| `apps/api/app/routers/storage.py` | MODIFY | Add teacher handling in restore/delete endpoints |
| `apps/api/tests/test_teachers_endpoints.py` | CREATE | New test file for teacher endpoints |

### Code Change Details

**services/storage.py - Add teachers bucket handling (after line 451):**
```python
elif bucket == "teachers" and len(parts) >= 3 and parts[1] == "materials":
    item_type = "teacher_material"
    prefix_parts = parts[0:3]  # [teacher_id, "materials", filename_or_subpath]
    metadata = {"teacher_id": parts[0], "material": parts[2] if len(parts) > 2 else ""}
```

**routers/storage.py - Add _extract_teacher_identifiers (after line 505):**
```python
def _extract_teacher_identifiers(path_parts: list[str]) -> tuple[str, str]:
    """Extract teacher_id and material path from trash key parts."""
    if len(path_parts) < 3 or path_parts[1] != "materials":
        raise HTTPException(status.HTTP_400_BAD_REQUEST, detail="Teacher restore key is incomplete")
    return path_parts[0], "/".join(path_parts[2:])  # teacher_id, material_path
```

**routers/storage.py - Update restore_item (add after line 556):**
```python
elif bucket == "teachers":
    item_type = "teacher_material"
    # No database record for teacher materials, just restore files
```

**routers/storage.py - Update delete_trash_entry (add after line 621):**
```python
elif bucket == "teachers":
    item_type = "teacher_material"
    # No database record for teacher materials, just delete files
```

### Tech Stack Reference
[Source: architecture.md#Tech Stack]
- Backend: Python 3.11+, FastAPI 0.111+
- Testing: Pytest 8.2+
- Storage: MinIO with S3-compatible API

### Testing

**Test Location:** `apps/api/tests/`

**Testing Framework:** Pytest 8.2+
[Source: architecture.md#Testing Strategy]

**Test Commands:**
```bash
# Run teacher endpoint tests
pytest apps/api/tests/test_teachers_endpoints.py -v

# Run storage service tests (includes trash logic)
pytest apps/api/tests/test_storage_service.py -v

# Run all storage tests
pytest apps/api/tests/test_storage_endpoints.py -v

# Run full test suite
pytest apps/api/tests/ -v
```

**Test Patterns to Follow:**
[Source: apps/api/tests/test_storage_endpoints.py, test_books_endpoints.py]
- Use `@pytest.fixture` for test client setup
- Mock MinIO client with `unittest.mock.patch`
- Test both success and error cases
- Test authentication requirements

### Verification Checklist
- [ ] Teachers bucket created on startup
- [ ] Upload endpoint accepts allowed MIME types
- [ ] Upload endpoint rejects disallowed MIME types
- [ ] Upload endpoint enforces file size limits
- [ ] List endpoint returns correct file tree
- [ ] Download endpoint streams files correctly
- [ ] Download endpoint supports Range requests
- [ ] Delete endpoint moves files to trash
- [ ] Trash listing shows teacher materials with correct metadata
- [ ] Restore from trash works for teacher materials
- [ ] Permanent delete from trash works for teacher materials

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-13 | 1.0 | Implementation complete - all tasks done, 22 tests pass | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All 22 teacher-related tests pass
- Pre-existing test failures (SQLite/JSONB compatibility) remain unrelated to this story

### Completion Notes List
- Teachers bucket configuration verified in config.py (already present from previous setup)
- Created teachers.py router with 4 endpoints: upload, list, download, delete
- All endpoints follow existing patterns from storage.py and books.py
- HTTP Range request support added for audio/video streaming
- Trash logic updated in services/storage.py to detect teachers bucket
- Restore/delete logic updated in routers/storage.py for teacher materials
- Teacher materials don't require database records (unlike books)
- MIME type validation uses config settings (documents, images, audio, video)
- File size validation uses teacher_max_file_size_bytes (100MB default)

### File List
| File | Action | Description |
|------|--------|-------------|
| `apps/api/app/routers/teachers.py` | CREATED | New router with upload, list, download, delete endpoints |
| `apps/api/app/main.py` | MODIFIED | Added teachers router import and registration |
| `apps/api/app/services/storage.py` | MODIFIED | Added teachers bucket handling in list_trash_entries() |
| `apps/api/app/routers/storage.py` | MODIFIED | Added _extract_teacher_identifiers(), updated restore_item() and delete_trash_entry() |
| `apps/api/tests/test_teachers_endpoints.py` | CREATED | 19 tests for teacher endpoints |
| `apps/api/tests/test_storage_service.py` | MODIFIED | Added 3 tests for teacher trash integration |

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation is clean, well-structured, and follows existing patterns consistently. The code demonstrates strong attention to security (path sanitization, input validation) and maintainability (clear separation of concerns, proper error handling).

**Highlights:**
- Comprehensive input validation for MIME types and file sizes
- Path traversal prevention with `_sanitize_segment()` and `_normalize_relative_path()`
- HTTP Range request support for efficient media streaming
- Proper resource cleanup in streaming (close/release_conn)
- Consistent error handling with appropriate HTTP status codes
- Well-documented functions with docstrings

### Refactoring Performed

None required - code quality is sufficient for release.

### Compliance Check

- Coding Standards: ✓ Follows project conventions, proper typing, logging patterns
- Project Structure: ✓ Router in correct location, test file properly named
- Testing Strategy: ✓ Unit tests with mocks, covers success/error/edge cases
- All ACs Met: ✓ All 7 acceptance criteria verified (AC6 marked optional/deferred)

### Requirements Traceability

| AC | Test Coverage | Status |
|----|---------------|--------|
| AC1 | Verified via config.py inspection, init_minio uses minio_buckets | ✓ |
| AC2 | 4 endpoints tested: upload, list, download, delete | ✓ |
| AC3 | Path structure verified in test assertions | ✓ |
| AC4 | test_upload_teacher_material_various_allowed_types | ✓ |
| AC5 | 3 trash integration tests in test_storage_service.py | ✓ |
| AC6 | Deferred (optional per AC definition) | N/A |
| AC7 | 22 automated tests covering all operations | ✓ |

### Improvements Checklist

- [x] All endpoints properly authenticated
- [x] Input validation comprehensive (MIME, size, path)
- [x] Error handling covers edge cases
- [x] Tests verify authentication requirements
- [x] Range request support for streaming
- [ ] Consider adding quota enforcement per teacher (future enhancement)
- [ ] Consider adding rate limiting for upload endpoint (future enhancement)

### Security Review

**Status: PASS**

Security measures implemented:
- JWT authentication required for all endpoints
- Path traversal prevention via sanitization
- MIME type whitelist validation
- File size limits enforced
- No secrets exposed in responses

No vulnerabilities identified.

### Performance Considerations

**Status: PASS**

- Streaming downloads avoid loading entire files into memory
- HTTP Range requests enable efficient seeking in media files
- File size validation occurs before upload to MinIO
- No N+1 query patterns

### Files Modified During Review

None - no refactoring was needed.

### Gate Status

**Gate: PASS** → docs/qa/gates/6.4-activate-teachers-storage-namespace.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no blocking issues identified.
