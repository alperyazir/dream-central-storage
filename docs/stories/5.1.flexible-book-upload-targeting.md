# Story 5.1: Flexible Book Upload Targeting

## Status
Done

## Story
**As an** administrator,
**I want** the book upload flow to support both fresh titles and targeted updates,
**so that** I can add new books quickly while still being able to apply updates to existing entries.

## Acceptance Criteria
1. The upload modal distinguishes between creating a new book and updating an existing one, hiding the target selector for new uploads and enforcing it for updates.
2. Submitting a new book upload without a selected target succeeds and returns the newly created book metadata to the dashboard list within one refresh cycle.
3. Update uploads require an explicit book selection and propagate the identifier to the API as part of the request payload.
4. API handlers accept both flows: automatically creating metadata for new submissions and preserving current behavior for updates.
5. Validation and user messaging cover missing selections when "update" is chosen, as well as backend errors specific to either flow.

## Tasks / Subtasks
- [x] Audit current book upload API routes to confirm request/response contracts and identify changes needed to support new book creation (AC: 2, 4) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#acceptance-criteria]
  - [x] Design request payload/endpoint adjustments (e.g., optional `book_id` or dedicated `/books/upload` route) and document them for frontend consumption (AC: 2, 3, 4) [Source: docs/prd/epic-5-storage-ux-and-stability-upgrades.md#story-51-flexible-book-upload-targeting]
- [x] Update admin panel upload modal to provide a clear toggle or radio selection for "New book" vs "Update existing" (AC: 1) [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#acceptance-criteria]
  - [x] Ensure the book dropdown is conditionally required only for update mode and retains accessibility coverage (AC: 1, 5) [Source: docs/architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Implement frontend API client changes to call the appropriate backend path based on the chosen mode and display success/error states (AC: 2, 3, 5) [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture]
  - [x] Refresh dashboard cache/listings after successful new book creation to show the returned metadata (AC: 2) [Source: docs/prd/requirements.md#user-flows]
- [x] Expand automated tests covering both new and update flows, including validation for missing selections in update mode (AC: 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [x] Update UI documentation to outline the new upload modes and selection rules (AC: 1, 5) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]

## Dev Notes
### Previous Story Insights
- Story 3.4 delivered the current upload modal and assumes an existing book selection for every upload; its implementation notes will guide the UI changes. [Source: docs/stories/3.4.book-and-app-folder-upload-ui.md#dev-notes]
- Story 2.2 implemented the backend endpoint that presently requires a book identifier, so changes must remain backward compatible for update mode. [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-notes]

### Data Models
- Book metadata fields (e.g., `book_name`, `language`, `category`) live in the architecture docs; ensure new uploads populate mandatory fields when auto-creating entries. [Source: docs/architecture/4-data-models.md#book]

### API Specifications
- Review existing REST patterns to decide whether a new endpoint (`POST /books/upload`) or optional parameter approach best fits the established API design. [Source: docs/architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- The admin panel uses React with Material UI; keep modal interactions consistent with the shared component library and ProtectedRoute patterns. [Source: docs/architecture/3-tech-stack.md#frontend]

### File Locations
- Frontend changes will touch `apps/admin-panel/src/features/uploads` (modal, forms) and shared API clients under `apps/admin-panel/src/api`. Backend updates belong in `apps/api/app/routers/books.py` and associated services. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Extend Vitest + React Testing Library coverage for the modal states and Pytest integration tests for the new backend behavior. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Preserve authentication requirements on upload endpoints and ensure new flows respect existing permission checks. [Source: docs/architecture/15-security-and-performance.md#security]

### Project Structure Notes
- Coordinate shared type definitions between backend and frontend packages if request payloads change. [Source: docs/architecture/13-development-workflow.md#shared-contracts]

## Testing
- Unit tests: frontend modal state management, backend request validation.
- Integration tests: end-to-end upload covering both new and update modes via API clients.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-04 | 0.1 | Initial draft created. | Sarah (Product Owner) |
| 2025-10-04 | 0.2 | Status updated to Approved after PO validation. | Sarah (Product Owner) |
| 2025-10-04 | 0.3 | Implementation completed and ready for review. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (apps/api)
- `npm test -- --run` (apps/admin-panel)

### Completion Notes List
- Added `/books/upload` endpoint that parses `metadata.json`, prevents duplicates, and auto-creates book records before streaming archives to MinIO.
- Introduced upload dialog toggle for new vs update flows with conditional validation and success messaging based on returned metadata.
- Updated API client helpers plus Vitest and Pytest coverage to exercise both pathways and surfaced new design guidance in the UX documentation.

### File List
- apps/api/app/routers/books.py
- apps/api/tests/test_books_upload.py
- apps/admin-panel/src/lib/uploads.ts
- apps/admin-panel/src/components/UploadDialog.tsx
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- docs/prd/user-interface-design-goals.md

## QA Results
- Not yet reviewed.
