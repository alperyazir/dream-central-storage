# Story 2.1: MinIO Service Connection & Bucket Setup

## Status
Done

## Story
**As a** developer,
**I want** the API to connect to the MinIO storage service and ensure the necessary buckets exist,
**so that** the application is ready to handle file storage operations.

## Acceptance Criteria
1. The FastAPI application securely connects to the MinIO instance using credentials from environment variables.
2. A utility script or an application s*agentartup event ensures the required buckets (`books`, `apps`, `trash`) are created if they don't already exist.
3. The connection is robust and includes basic error handling for connectivity issues.

## Tasks / Subtasks
- [x] Configure MinIO client initialization with environment-driven credentials (AC: 1) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Add configuration entries for MinIO endpoint/access keys in `Settings` and ensure safe loading from environment variables (AC: 1) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
  - [x] Implement a reusable MinIO client factory under `apps/api/app/services` respecting dependency patterns (AC: 1) [Source: architecture/2-high-level-architecture.md#architectural-patterns]
- [x] Create bucket bootstrap utility (AC: 2) [Source: architecture/14-deployment-architecture.md#14-deployment-architecture]
  - [x] Implement function/script to ensure `books`, `apps`, and `trash` buckets exist, creating them idempotently (AC: 2) [Source: architecture/8-core-workflows.md#8-core-workflows]
  - [x] Add application startup hook or CLI entrypoint that invokes the bucket bootstrapper (AC: 2) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Add error handling and observability (AC: 3) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Wrap MinIO client operations with basic exception handling and meaningful log messages (AC: 3) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
  - [x] Ensure failures surface actionable errors without exposing credentials (AC: 3) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
- [x] Add tests validating MinIO bootstrap logic (AC: 1, 2, 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write unit tests with mocked MinIO client covering successful bucket creation and existing-bucket scenarios (AC: 2, 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add failure-case tests confirming exceptions are handled and logged appropriately (AC: 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Dev Notes
### Previous Story Insights
- Authentication infrastructure and repository patterns are in place from Epic 1; follow established dependency injection and configuration patterns for new services. [Source: docs/stories/1.3.user-authentication-endpoints.md#dev-agent-record]
- Existing scripts demonstrate how to provide CLI utilities leveraging application settings and session factories. [Source: docs/stories/1.3.user-authentication-endpoints.md#dev-agent-record]

### Data Models
- No new data models introduced; storage structure controlled by bucket naming conventions. [Source: architecture/4-data-models.md#book]

### API Specifications
- No direct API endpoints in this story; focus is on service connectivity and infrastructure readiness. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Storage integration is described at a high level; ensure MinIO utilities reside within backend service layer per architecture guidelines. [Source: architecture/6-components.md#storage]

### File Locations
- Place MinIO service utilities under `apps/api/app/services` and CLI/startup hooks within existing backend structure. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Use Pytest with dependency injection/mocking to validate storage bootstrap code without calling real MinIO. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Respect existing FastAPI application patterns, loading configuration via Pydantic Settings and wiring dependencies through FastAPI's DI. [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- MinIO interactions should use the recommended Python SDK compatible with the tech stack (e.g., `minio` library). [Source: architecture/3-tech-stack.md#3-tech-stack]

### Project Structure Notes
- Keep storage-related code within backend app boundaries, avoiding leakage into shared packages. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing
- Integrate new tests into `pytest` suite to maintain CI coverage. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | MinIO connection and bucket bootstrap implemented; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Story verified and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from 
  `apps/api/`, 24 tests passed)

### Completion Notes List
- Extended application settings with MinIO configuration and reusable bucket list.
- Added service layer helpers to construct MinIO clients and idempotently ensure bucket existence with logging.
- Wired MinIO bootstrap into FastAPI lifespan and provided a CLI utility for manual initialization.
- Added mocked unit tests covering bucket bootstrap flows and error handling.
- Included `minio` SDK dependency in project configuration.

### File List
- apps/api/app/core/config.py
- apps/api/app/main.py
- apps/api/app/services/__init__.py
- apps/api/app/services/minio.py
- apps/api/app/scripts/init_minio.py
- apps/api/scripts/init_minio.py
- apps/api/tests/test_minio_service.py
- apps/api/pyproject.toml
- docs/stories/2.1.minio-service-connection-bucket-setup.md

## QA Results
- Gate: PASS â€“ MinIO buckets are bootstrapped via FastAPI lifespan and CLI, with settings-driven credentials and defensive error handling (`apps/api/app/main.py:1`, `apps/api/app/services/minio.py:1`).
- Evidence:
  - Configuration exposes endpoint, credentials, and required bucket list ensuring consistent usage (`apps/api/app/core/config.py:26`).
  - Service helpers construct the MinIO client and create buckets idempotently while logging failures (`apps/api/app/services/minio.py:18`).
  - Pytest suite covers happy path, existing bucket, and error scenarios, plus overall regression run (`apps/api/tests/test_minio_service.py:1`, `pytest` run with 24 tests).
- Residual Risks:
  - None identified; CLI and application bootstrap share the same helper ensuring consistent behaviour.
