# Story 3.3: Dashboard for Listing Books & Apps

## Status
Done

## Story
**As an** administrator,
**I want** to see lists of all available books and application builds on a dashboard,
**so that** I can get an overview of the stored content.

## Acceptance Criteria
1. The dashboard page is a protected route, redirecting unauthenticated users to the login page.
2. On page load, the component calls the necessary API endpoints to fetch the list of books and app builds.
3. The book and app data are displayed in clear, sortable tables.
4. The book list table includes columns for key metadata like Title, Publisher, Language, and Category.
5. The UI provides a way to filter the book list (e.g., by publisher).

## Tasks / Subtasks
- [x] Secure and route the dashboard view (AC: 1) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Wrap the dashboard route with the shared ProtectedRoute pattern so unauthenticated users are redirected to `/login` (AC: 1) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Ensure the dashboard consumes the Zustand auth store to confirm session state before rendering content (AC: 1) [Source: architecture/3-tech-stack.md#3-tech-stack]
- [x] Fetch books and app builds through the services layer (AC: 2) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Extend the admin-panel API client to invoke `GET /books` for metadata listing and map the payload to dashboard view models (AC: 2) [Source: docs/stories/1.4.book-crud-endpoints.md#acceptance-criteria]
  - [x] Request application build listings via `GET /storage/apps/{platform}` (per platform) and normalize the tree response shape for table rendering (AC: 2) [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#acceptance-criteria]
  - [x] Handle loading and error states to keep the dashboard responsive while requests are in-flight (AC: 2) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Render sortable data tables for books and app builds (AC: 3, 4) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Map the book table columns to Title, Publisher, Language, and Category fields per the shared Book model (AC: 4) [Source: architecture/4-data-models.md#book]
  - [x] Present app build metadata in a dedicated table using the `path`, `type`, and `size` fields from the storage listing tree (AC: 3) [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#dev-agent-record]
  - [x] Provide column-based sorting interactions using Material UI table primitives (AC: 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
- [x] Add filtering controls for the book list (AC: 5) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Implement a publisher filter control that binds to the book table data set (AC: 5) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
  - [x] Ensure filter state is stored locally within the dashboard view to avoid polluting global state (AC: 5) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Testing and validation (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add Vitest + React Testing Library coverage for guard behavior, successful data rendering, sorting, and filtering flows (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Execute workspace lint, test, and build commands for the admin panel to confirm no regressions (AC: 1, 2, 3, 4, 5) [Source: architecture/3-tech-stack.md#3-tech-stack]

## Dev Notes
### Previous Story Insights
- Story 3.2 delivered the in-memory Zustand auth store, ProtectedRoute wrapper, and logout-aware navigation that the dashboard must reuse for protected access. [Source: docs/stories/3.2.admin-login-page-authentication.md#dev-agent-record]
- Story 3.1 established the admin panel application shell with routing, layout scaffolding, and a typed API configuration module under `apps/admin-panel`. [Source: docs/stories/3.1.react-app-initialization-layout.md#dev-agent-record]

### Data Models
- Book metadata includes `publisher`, `book_name`, `language`, `category`, status, and timestamp fields; use these properties when rendering the table. [Source: architecture/4-data-models.md#book]
- Storage listings for application builds return hierarchical nodes with `path`, `type`, and optional `size` values for files; surface these columns in the UI. [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#dev-agent-record]

### API Specifications
- `GET /books` returns the list of book metadata records for dashboard consumption. [Source: docs/stories/1.4.book-crud-endpoints.md#acceptance-criteria]
- `GET /storage/apps/{platform}` provides authenticated listings of application build folders with optional version filtering; issue one call per supported platform. [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#acceptance-criteria]

### Component Specifications
- Follow the frontend architecture guidance for organizing route-level views, Zustand-powered state, and the shared services layer. [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- Material UI is the approved component library for tables, forms, and layout primitives within the admin panel. [Source: architecture/3-tech-stack.md#3-tech-stack]

### File Locations
- Implement the dashboard view within the `apps/admin-panel` workspace, keeping route components under the established `src/pages` structure and UI helpers under `src/components`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Use Vitest with React Testing Library for component and interaction tests covering guard redirects, data rendering, sorting, and filtering scenarios. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Continue using React 18+, TypeScript, React Router, Zustand, and Material UI per the approved tech stack. [Source: architecture/3-tech-stack.md#3-tech-stack]
- Maintain secure handling of authenticated sessions when conditionally rendering the dashboard content. [Source: architecture/15-security-and-performance.md#15-security-and-performance]

### Project Structure Notes
- Align new files with the monorepo conventions under `apps/admin-panel`; no structural conflicts identified. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

## Testing
- Add Vitest + RTL suites under `apps/admin-panel/src/__tests__` to verify protected access, data display, sorting interactions, and filtering behavior. [Source: architecture/16-testing-strategy.md#16-testing-strategy]
- Run the admin panel workspace lint, test, and build scripts to validate the dashboard feature. [Source: architecture/3-tech-stack.md#3-tech-stack]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-29 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-29 | 0.2 | Implemented dashboard tables, filtering, data services, and test coverage. | James (Developer) |
| 2025-09-29 | 0.3 | Story verified, acceptance confirmed, and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- npm run lint --workspace apps/admin-panel
- npm run test --workspace apps/admin-panel -- --run
- npm run build --workspace apps/admin-panel

### Completion Notes List
- Added dashboard route content that loads book metadata and storage listings with loading and error states.
- Introduced reusable API helpers for authorized book queries and storage tree retrieval.
- Built MUI tables with sorting and publisher filtering plus byte-size formatting for build artifacts.
- Authored Vitest + RTL suites covering guard behavior, data rendering, sorting toggles, and filter interactions.
- Verified admin-panel lint, unit tests, and production build succeed with new assets.

### File List
- apps/admin-panel/src/lib/http.ts
- apps/admin-panel/src/lib/books.ts
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/pages/Dashboard.tsx
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- apps/admin-panel/src/__tests__/auth.test.tsx
- apps/admin-panel/src/__tests__/layout.test.tsx

## QA Results

### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Data loading stays within auth guard boundaries and avoids stale state updates through the subscription flag and token gate (`apps/admin-panel/src/pages/Dashboard.tsx:130`).
- Storage tree flattening produces consistent build rows while preserving platform/version segmentation (`apps/admin-panel/src/pages/Dashboard.tsx:70`).
- Helper modules centralize authorized requests, keeping headers normalized and reusable across future endpoints (`apps/admin-panel/src/lib/http.ts:1`, `apps/admin-panel/src/lib/books.ts:1`, `apps/admin-panel/src/lib/storage.ts:1`).

### Requirements Traceability
- **AC1** – Given an unauthenticated visitor, when navigating to the dashboard, then they are redirected to the login page (`apps/admin-panel/src/__tests__/auth.test.tsx:32`).
- **AC2** – Given an authenticated admin, when the dashboard mounts, then the UI requests `/books` and `/storage/apps/{platform}` with auth headers (`apps/admin-panel/src/__tests__/dashboard.test.tsx:58`).
- **AC3 & AC4** – Given returned metadata, when rendering tables, then book rows and build rows surface the required columns (`apps/admin-panel/src/__tests__/dashboard.test.tsx:139`).
- **AC5** – Given a publisher selection, when the filter changes, then the table narrows results and resorting updates order (`apps/admin-panel/src/__tests__/dashboard.test.tsx:186`).

### Test Architecture Assessment
- Component tests stub fetch to verify authorization headers, loading states, and error handling pathways (`apps/admin-panel/src/__tests__/dashboard.test.tsx:120`).
- Existing auth and layout suites now cover post-login navigation and guard flows with deterministic fetch stubs (`apps/admin-panel/src/__tests__/auth.test.tsx:28`, `apps/admin-panel/src/__tests__/layout.test.tsx:8`).

### NFR Validation
- **Security:** PASS – Requests only fire when a token is present and always include normalized bearer headers; unauthorized flows redirect before the view mounts (`apps/admin-panel/src/pages/Dashboard.tsx:134`).
- **Performance:** PASS – Concurrent `Promise.all` batching minimizes round trips and memoized sorting prevents redundant computation during renders (`apps/admin-panel/src/pages/Dashboard.tsx:147`).
- **Reliability:** PASS – Errors collapse tables into a known state and surface messaging for operators, while the unsubscribe guard prevents setState on unmounted components (`apps/admin-panel/src/pages/Dashboard.tsx:163`).
- **Maintainability:** PASS – Table renderers remain declarative, helpers encapsulate API concerns, and tests document expected request shapes for future agents (`apps/admin-panel/src/lib/books.ts:1`).

### Testability Evaluation
- Controllability: Zustand store resets and fetch spies allow deterministic arrangement of auth and API responses (`apps/admin-panel/src/__tests__/dashboard.test.tsx:9`).
- Observability: Tables and alerts expose semantic roles so assertions capture UI state without implementation coupling (`apps/admin-panel/src/pages/Dashboard.tsx:202`).
- Debuggability: Isolated helpers and descriptive error messages narrow investigation scope when data calls fail (`apps/admin-panel/src/pages/Dashboard.tsx:168`).

### Risk Summary
- Residual risk: Low – Future platform additions require updating the static list; capture as follow-up if platform catalog grows beyond the current two.

### Gate Decision Recommendation
- Recommend **PASS** and move story to Ready for Done after PO sign-off.
