# Story 10.13: Admin Processing Dashboard

## Status
Done

## Story
**As an** administrator,
**I want** to view and manage AI processing status for all books from a centralized dashboard,
**so that** I can monitor processing progress, identify failures, and trigger bulk reprocessing without navigating to individual books.

## Acceptance Criteria

1. View all books with processing status
2. Filter: processed, pending, failed, not started
3. Trigger manual processing
4. View processing progress
5. View and clear errors
6. Bulk re-process action
7. Processing queue view

## Tasks / Subtasks

- [x] Task 1: Create Processing page component (AC: 1, 2, 4)
  - [x] Create `apps/admin-panel/src/pages/Processing.tsx`
  - [x] Implement table view showing all books with processing status columns
  - [x] Add status chip display using existing `getStatusColor` and `getStatusLabel` helpers
  - [x] Add progress column with LinearProgress for active jobs
  - [x] Implement status filter dropdown (all, not_started, queued, processing, completed, failed, partial)
  - [x] Add search by book title/publisher

- [x] Task 2: Add backend endpoint for books with processing status (AC: 1, 2)
  - [x] Create `GET /api/v1/processing/books` endpoint in `apps/api/app/routers/processing.py`
  - [x] Return list of books with their latest processing status
  - [x] Support query params: `status`, `publisher`, `page`, `page_size`
  - [x] Include processing metadata (progress, current_step, error_message)
  - [x] Add unit tests

- [x] Task 3: Add processing queue endpoint (AC: 7)
  - [x] Create `GET /api/v1/processing/queue` endpoint
  - [x] Return list of jobs currently in queue (queued + processing)
  - [x] Include position in queue, estimated wait time
  - [x] Add unit tests

- [x] Task 4: Implement manual processing trigger (AC: 3)
  - [x] Add "Process" action button per book row
  - [x] Reuse existing `ProcessingDialog` component for individual processing
  - [x] Show confirmation before triggering

- [x] Task 5: Implement error viewing and clearing (AC: 5)
  - [x] Add expandable error details in table row
  - [x] Add "Clear Error" action that resets status to not_started
  - [x] Create `POST /api/v1/processing/books/{book_id}/clear-error` endpoint
  - [x] Add unit tests

- [x] Task 6: Implement bulk re-process action (AC: 6)
  - [x] Add checkbox selection to table rows
  - [x] Add "Bulk Re-process" button in toolbar
  - [x] Create `POST /api/v1/processing/bulk-reprocess` endpoint
  - [x] Accept array of book IDs to reprocess
  - [x] Show progress dialog during bulk operation
  - [x] Add unit tests

- [x] Task 7: Add Processing Queue panel (AC: 7)
  - [x] Create collapsible "Queue Status" panel at top of page
  - [x] Show count of queued/processing jobs
  - [x] List next 5 jobs in queue with book title and position
  - [x] Auto-refresh every 10 seconds when jobs are active

- [x] Task 8: Add navigation and routing (AC: 1)
  - [x] Add `/processing` route in `App.tsx`
  - [x] Add "AI Processing" menu item in sidebar navigation
  - [x] Use appropriate icon (e.g., AutoFixHighIcon or SettingsSuggestIcon)

- [x] Task 9: Add frontend lib functions (AC: 1-7)
  - [x] Add `getBooksWithProcessingStatus` function to `lib/processing.ts`
  - [x] Add `getProcessingQueue` function
  - [x] Add `clearProcessingError` function
  - [x] Add `bulkReprocess` function

- [x] Task 10: Write unit tests (AC: 1-7)
  - [x] Create `apps/admin-panel/src/__tests__/processing.test.tsx`
  - [x] Test table rendering with different statuses
  - [x] Test filter functionality
  - [x] Test bulk selection
  - [x] Create `apps/api/tests/test_processing_dashboard.py`
  - [x] Test all new API endpoints

## Dev Notes

### Previous Story Insights (Story 10.12)
- Auto-processing on upload is now enabled via `ai_auto_process_on_upload` setting
- `PROCESSING_STARTED`, `PROCESSING_COMPLETED`, `PROCESSING_FAILED` webhook event types added
- Processing triggers use `BackgroundTasks` pattern
- Queue service integrates with arq/Redis

### Existing Processing Infrastructure
[Source: `apps/admin-panel/src/components/ProcessingDialog.tsx`]
- `ProcessingDialog` component exists for individual book processing
- Handles status polling (3-second interval)
- Shows progress with LinearProgress
- Uses `triggerProcessing`, `getProcessingStatus`, `deleteAIData` from lib/processing.ts

[Source: `apps/admin-panel/src/lib/processing.ts`]
```typescript
export type ProcessingStatus = 'queued' | 'processing' | 'completed' | 'failed' | 'partial' | 'cancelled';
export const getStatusColor = (status: ProcessingStatus) => { ... }
export const getStatusLabel = (status: ProcessingStatus) => { ... }
```

### Admin Panel Patterns
[Source: `apps/admin-panel/src/App.tsx`]
- Routes are defined in `App.tsx` with React Router
- Protected routes use `ProtectedRoute` wrapper
- Pages are in `src/pages/` directory
- Layout uses `MainLayout` component

[Source: `apps/admin-panel/src/stores/auth.ts`]
- Auth state managed with Zustand
- Token and tokenType available from `useAuthStore`

### Component Patterns
- MUI components used throughout (Table, Chip, Button, Dialog)
- Icons from `@mui/icons-material`
- Forms use MUI Select, TextField components
- Tables use DataGrid or custom Table components

### API Patterns
[Source: `apps/api/app/routers/processing.py`]
- Existing processing endpoints:
  - `POST /api/v1/books/{book_id}/process-ai`
  - `GET /api/v1/books/{book_id}/process-ai/status`
  - `DELETE /api/v1/books/{book_id}/ai-data`

### Processing Status Values
From Epic 10 PRD:
- `not_started` - No AI processing done
- `queued` - In processing queue
- `processing` - Currently being processed
- `completed` - Successfully processed
- `failed` - Processing failed (with error details)
- `partial` - Some steps completed, others failed

### File Locations
- New page: `apps/admin-panel/src/pages/Processing.tsx`
- Lib functions: `apps/admin-panel/src/lib/processing.ts`
- API router: `apps/api/app/routers/processing.py`
- Frontend tests: `apps/admin-panel/src/__tests__/processing.test.tsx`
- Backend tests: `apps/api/tests/test_processing_dashboard.py`

## Testing

### Test File Locations
- Frontend: `apps/admin-panel/src/__tests__/processing.test.tsx`
- Backend: `apps/api/tests/test_processing_dashboard.py`

### Testing Standards
- Frontend: Vitest with React Testing Library
- Backend: Pytest with mocked dependencies
- Mock API calls to avoid external dependencies
- Test both success and error states
- Test filter and bulk selection functionality

### Test Cases
1. `test_renders_books_with_status` - verify table displays books
2. `test_filter_by_status` - verify filter dropdown works
3. `test_bulk_selection` - verify checkbox selection
4. `test_trigger_processing_from_row` - verify action button
5. `test_queue_panel_shows_active_jobs` - verify queue display
6. Backend: `test_list_books_with_processing_status` - verify endpoint
7. Backend: `test_bulk_reprocess` - verify bulk operation
8. Backend: `test_clear_error` - verify error clearing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-30 | 0.1 | Initial story draft | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List
- Created full-stack Admin Processing Dashboard for monitoring and managing AI book processing
- Backend: Added 4 new endpoints to dashboard_router in processing.py (GET /processing/books, GET /processing/queue, POST /processing/books/{book_id}/clear-error, POST /processing/bulk-reprocess)
- Frontend: Created Processing.tsx page with table view, status filters, search, checkbox selection, and queue panel
- Added processing status types including 'not_started' for unprocessed books
- Implemented bulk reprocessing with validation (requires user auth, checks book exists and has content)
- Queue panel shows active jobs with auto-refresh every 10 seconds
- Error viewing with inline expandable error messages and clear error action
- 22 unit tests total: 9 backend tests (pytest) + 13 frontend tests (vitest)
- Used SmartToyIcon for AI Processing navigation item
- Pre-existing test failures in other files unrelated to this story (SQLite/JSONB compatibility issues)

### File List
**New Files:**
- `apps/admin-panel/src/pages/Processing.tsx` - Admin Processing Dashboard page component
- `apps/admin-panel/src/__tests__/processing.test.tsx` - Frontend tests (13 tests)
- `apps/api/tests/test_processing_dashboard.py` - Backend tests (9 tests)

**Modified Files:**
- `apps/admin-panel/src/lib/processing.ts` - Added ExtendedProcessingStatus type, getBooksWithProcessingStatus, getProcessingQueue, clearProcessingError, bulkReprocess functions, getExtendedStatusColor/Label helpers
- `apps/admin-panel/src/App.tsx` - Added /processing route
- `apps/admin-panel/src/components/NavBar.tsx` - Added AI Processing nav item with SmartToyIcon
- `apps/api/app/routers/processing.py` - Added dashboard_router with 4 new endpoints and Pydantic models
- `apps/api/app/main.py` - Registered dashboard_router

## QA Results

### Review Date: 2024-12-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean full-stack implementation following established project patterns. Proper separation between dashboard_router and existing processing endpoints. Well-typed TypeScript with comprehensive state management using useState/useCallback/useMemo. Good reuse of existing ProcessingDialog component.

**Strengths:**
- Clean React component with proper hooks usage
- Well-organized backend with dedicated dashboard_router
- Proper Pydantic models for all request/response types
- Auto-refresh with conditional logic (only when jobs active)
- Good error handling with ApiError checks
- Proper auth enforcement on all endpoints

### Refactoring Performed

None required - code quality is production-ready.

### Compliance Check

- Coding Standards: ✓ Follows project conventions, linter passes on new files
- Project Structure: ✓ Files in correct locations per architecture
- Testing Strategy: ✓ 22 tests (9 backend + 13 frontend) with mocked dependencies
- All ACs Met: ✓ All 7 acceptance criteria fully implemented

### Requirements Traceability

| AC | Requirement | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| 1 | View all books with processing status | `GET /processing/books` + `Processing.tsx` table | ✓ `test_list_books_returns_books_with_status`, `renders books in the table` |
| 2 | Filter by status | `statusFilter` state + query param | ✓ `filters by status` |
| 3 | Trigger manual processing | `ProcessingDialog` reuse via action button | ✓ Implicit via `ProcessingDialog` mock |
| 4 | View processing progress | `LinearProgress` component | ✓ `renders queue panel`, `shows queue items` |
| 5 | View and clear errors | Error display + `POST /processing/books/{id}/clear-error` | ✓ `shows error message`, `test_clear_error_success` |
| 6 | Bulk re-process action | `POST /processing/bulk-reprocess` + `handleBulkReprocess` | ✓ `test_bulk_reprocess_success`, `calls bulk reprocess` |
| 7 | Processing queue view | `GET /processing/queue` + Queue panel | ✓ `test_get_queue_returns_active_jobs`, `renders queue panel` |

### Improvements Checklist

- [x] All 4 backend endpoints implemented with proper validation
- [x] Frontend page component with table, filters, queue panel
- [x] Auto-refresh every 10s when jobs are active
- [x] Bulk operations require user authentication (not API key)
- [x] Error clearing validates job is in failed state
- [x] Comprehensive test coverage (22 tests)
- [ ] Consider batch query for job status to avoid N+1 in list_books_with_processing_status (future optimization)
- [ ] Remove redundant client-side search filter (server already handles it)

### Security Review

**Status: PASS**

- ✓ All endpoints require Bearer token authentication (JWT or API key)
- ✓ Bulk reprocess requires user auth (returns 403 for API key auth)
- ✓ Clear error validates job is in failed state before allowing clear
- ✓ No SQL injection (uses SQLAlchemy ORM)
- ✓ No XSS vulnerabilities (React handles escaping)

### Performance Considerations

**Status: CONCERNS (minor)**

- Note: `list_books_with_processing_status` has N+1 query potential - calls `queue_service.list_jobs` per book. Acceptable for dashboard use case but could be optimized with batch query.
- ✓ Auto-refresh only activates when jobs are in queue (not always polling)
- ✓ Pagination implemented (default 50 per page)

### Files Modified During Review

None - no refactoring was required.

### Gate Status

Gate: **PASS** → docs/qa/gates/10.13-admin-processing-dashboard.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, tests passing, code quality excellent.

