# Story 4.2: Restore Functionality from Trash

## Status
Review

## Story
**As an** administrator,
**I want** to view and restore soft-deleted items,
**so that** I can recover from accidental deletions.

## Acceptance Criteria
1. A new "Trash" page/view in the Admin Panel lists all items inside the `trash` bucket.
2. Each trash entry provides a "Restore" action for administrators.
3. A JWT-protected API endpoint (e.g., `POST /storage/restore`) accepts restore requests.
4. Restoring an item moves its folder from `trash` back to the original `books` or `apps` bucket while preserving the prior path.
5. Restoring a soft-deleted book updates its metadata status from `archived` back to `published`.

## Tasks / Subtasks
- [x] Design trash listing contract and determine pagination or filtering needs (AC: 1) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- [x] Implement storage restore helper that replays prefixes from the trash bucket to their original location (AC: 4) [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]
  - [x] Ensure the restore helper preserves original bucket and prefix structure for books and apps (AC: 4) [Source: docs/prd/epic-4-advanced-features-production-readiness.md#story-42-restore-functionality-from-trash]
  - [x] Emit audit logs reflecting actor, source trash path, and restored destination (AC: 4) [Source: docs/prd/requirements.md#functional]
- [x] Extend repository logic to publish archived books within a single transaction (AC: 5) [Source: architecture/4-data-models.md#book]
  - [x] Guard against invalid state transitions (e.g., restoring already published books) (AC: 5) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Expose authenticated REST endpoint to trigger restores via FastAPI router (AC: 3) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Validate payloads for book vs. app restore flows and reuse JWT admin dependency (AC: 3) [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]
  - [x] Return consistent error responses when restore fails, aligning with global handlers (AC: 3) [Source: architecture/18-error-handling-strategy.md#18-error-handling-strategy]
- [x] Build Admin Panel Trash view that aggregates trash contents per platform and publisher (AC: 1) [Source: docs/prd/user-interface-design-goals.md#overall-ux-vision]
  - [x] Provide restore buttons with confirmation modals mirroring delete UX (AC: 2) [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]
  - [x] Refresh dashboard/trash listings upon successful restore and surface failure messaging (AC: 2) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- [x] Integrate restore API call in frontend services with proper auth headers (AC: 2, 3) [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]
- [x] Update documentation and user guidance for trash retention expectations (AC: 1, 4) [Source: docs/prd/requirements.md#non-functional]
- [x] Testing and validation (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add Pytest coverage for restore success, missing records, and MinIO failure scenarios (AC: 3, 4, 5) [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#testing]
  - [x] Extend Vitest tests for Trash view interactions, including confirmation flows and optimistic UI updates (AC: 1, 2) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
  - [x] Run API and Admin Panel test suites plus lint/build guards (AC: 1-5) [Source: architecture/3-tech-stack.md#3-tech-stack]

## Dev Notes
### Previous Story Insights
- Soft-delete implementation introduced `move_prefix_to_trash` and auditing patterns that restoration must mirror in reverse to ensure consistent bucket structure and logs. [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]
- Dashboard delete flows already handle confirmation dialogs and table refreshes; reuse those UI patterns for restore actions to maintain familiarity. [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]

### Data Models
- `Book.status` enum supports `draft`, `published`, and `archived`; restoring a book requires switching from `archived` back to `published` while preserving timestamps. [Source: architecture/4-data-models.md#book]
- No dedicated metadata exists for app builds, so restoration relies on object prefixes from storage listings (platform/version). [Source: docs/prd/epic-4-advanced-features-production-readiness.md#story-42-restore-functionality-from-trash]

### API Specifications
- FastAPI routers expose CRUD-style endpoints; new restore endpoint should follow REST conventions under storage routes and reuse JWT bearer auth. [Source: architecture/5-api-specification.md#5-api-specification]
- Service layer patterns encapsulate external integrations; restoration logic should live alongside existing storage helpers for cohesion. [Source: architecture/11-backend-architecture.md#11-backend-architecture]

### Component Specifications
- Admin Panel actions are modal-driven with table-centric layouts; the Trash view should align with dashboard UX and provide clear call-to-action buttons. [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- React services module centralizes API calls to keep components lean; hook restore requests through shared utilities similar to existing delete flows. [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes]

### File Locations
- Backend routers live in `apps/api/app/routers`, storage helpers in `apps/api/app/services`, and repository utilities in `apps/api/app/repositories`, ensuring restore features stay near existing soft-delete code. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
- Frontend Trash view should reside under `apps/admin-panel/src/pages`, with supporting API helpers in `apps/admin-panel/src/lib`. [Source: docs/prd/user-interface-design-goals.md#core-screens-and-views]

### Testing Requirements
- Follow Pytest-based integration tests for FastAPI endpoints and mocked MinIO interactions, plus Vitest + React Testing Library coverage for UI behavior. [Source: architecture/16-testing-strategy.md#16-testing-strategy]
- Maintain manual command verification (`pytest`, `npm test -- --run`) to guard regressions, mirroring previous story practice. [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#testing]

### Technical Constraints
- Maintain transactional integrity: only update SQL status after verifying MinIO restore succeeded, and surface consistent JSON errors via global handlers. [Source: architecture/11-backend-architecture.md#11-backend-architecture]
- All state-changing operations require audit logs per FR7; ensure restore actions log actor, source trash path, and destination. [Source: docs/prd/requirements.md#functional]
- Trash contents must be retained for at least seven days; restoration should not inadvertently purge items or bypass retention rules. [Source: docs/prd/requirements.md#non-functional]
- Apply standard security practices (JWT validation, CORS, rate limiting) and monitor performance impact of large restores. [Source: architecture/15-security-and-performance.md#15-security-and-performance]

### Project Structure Notes
- Keep restore helper flexible for future permanent-delete workflows by sharing interfaces with existing storage services. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
- Ensure new Trash view integrates with existing routing and layout shell to preserve dashboard-centric navigation. [Source: docs/prd/user-interface-design-goals.md#overall-ux-vision]

## Testing
- `pytest` (apps/api/) – 62 tests
- `npm test -- --run` (apps/admin-panel/) – 17 tests

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-03 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-10-03 | 0.2 | Implemented trash listing, restore APIs, UI, and automated tests. | James (Developer) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest`
- `npm test -- --run`

### Completion Notes List
- Added MinIO trash aggregation and restore helpers with FastAPI endpoints and book repository updates.
- Delivered React Trash page with restore dialog, API wiring, and automated Vitest coverage.
- Documented trash retention guidance and verified full backend/frontend regression suites.

### File List
- apps/api/app/repositories/book.py
- apps/api/app/routers/storage.py
- apps/api/app/schemas/__init__.py
- apps/api/app/schemas/storage.py
- apps/api/app/services/__init__.py
- apps/api/app/services/storage.py
- apps/api/tests/test_storage_endpoints.py
- apps/api/tests/test_storage_service.py
- apps/api/tests/test_storage_trash_endpoints.py
- apps/admin-panel/src/App.tsx
- apps/admin-panel/src/__tests__/auth.test.tsx
- apps/admin-panel/src/__tests__/layout.test.tsx
- apps/admin-panel/src/__tests__/trash.test.tsx
- apps/admin-panel/src/components/NavBar.tsx
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/pages/Trash.tsx
- docs/prd/user-interface-design-goals.md
- docs/stories/4.2.restore-functionality-from-trash.md

## QA Results
