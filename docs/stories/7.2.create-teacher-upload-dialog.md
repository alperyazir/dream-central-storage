# Story 7.2: Create Teacher Material Upload Dialog

## Status

Done

## Story

**As an** administrator,
**I want** to upload materials for a specific teacher,
**so that** I can add teaching resources on their behalf.

## Acceptance Criteria

1. TeacherUploadDialog component opens from Teachers page "Upload Material" button.
2. Dialog requires teacher ID input before upload.
3. File picker accepts allowed MIME types (PDF, images, audio, video, documents).
4. Upload progress indicator displays during upload.
5. Success/error feedback shown after upload attempt.
6. File size limit (100MB) displayed to user; validation occurs before upload.
7. After successful upload, callback triggers to refresh Teachers page.
8. Dialog follows BookUploadDialog.tsx patterns for consistency.

## Tasks / Subtasks

- [x] **Task 1: Create TeacherUploadDialog Component (AC: 1, 8)**
  - [x] Create `apps/admin-panel/src/components/TeacherUploadDialog.tsx`
  - [x] Define props interface:
    ```typescript
    interface TeacherUploadDialogProps {
      open: boolean;
      onClose: () => void;
      token: string | null;
      tokenType: string | null;
      onSuccess: () => void;
      initialTeacherId?: string;  // Pre-fill if uploading for specific teacher
    }
    ```
  - [x] Import MUI components: Dialog, DialogTitle, DialogContent, DialogActions, Button, TextField, Alert, LinearProgress, Typography, Box

- [x] **Task 2: Implement Teacher ID Input (AC: 2)**
  - [x] Add TextField for teacher_id input
  - [x] Make teacher_id required with validation
  - [x] Add helper text: "Enter the teacher's unique identifier"
  - [x] Disable upload button if teacher_id is empty
  - [x] If `initialTeacherId` prop provided, pre-fill and optionally disable field

- [x] **Task 3: Implement File Picker (AC: 3)**
  - [x] Create drag-and-drop zone (following BookUploadDialog pattern)
  - [x] Accept MIME types:
    ```typescript
    const ALLOWED_TYPES = [
      'application/pdf',
      'text/plain',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'image/jpeg', 'image/png', 'image/gif', 'image/webp',
      'audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/mp4',
      'video/mp4', 'video/webm', 'video/quicktime'
    ];
    ```
  - [x] Show accepted file types hint to user
  - [x] Display selected file name and size

- [x] **Task 4: Implement File Size Validation (AC: 6)**
  - [x] Define max size constant: `const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB`
  - [x] Validate file size on selection
  - [x] Show error if file exceeds limit: "File size must be under 100MB"
  - [x] Display current file size vs limit

- [x] **Task 5: Implement Upload Function (AC: 4, 5)**
  - [x] Add `uploadTeacherMaterial()` to `lib/teachers.ts`:
    ```typescript
    export const uploadTeacherMaterial = async (
      teacherId: string,
      file: File,
      token: string,
      tokenType: string
    ): Promise<UploadResponse> => {
      const formData = new FormData();
      formData.append('file', file);
      return apiClient.post(`/teachers/${teacherId}/upload`, formData, {
        headers: {
          ...buildAuthHeaders(token, tokenType),
          'Content-Type': 'multipart/form-data'
        }
      });
    };
    ```
  - [x] Handle upload progress (if supported by API client)
  - [x] Return upload result with path and size

- [x] **Task 6: Implement Progress Indicator (AC: 4)**
  - [x] Add `uploading` state
  - [x] Show LinearProgress during upload
  - [x] Disable all inputs and buttons while uploading
  - [x] Show "Uploading..." text on button

- [x] **Task 7: Implement Feedback Messages (AC: 5)**
  - [x] Show success Alert with green background
  - [x] Show error Alert with detailed message
  - [x] Auto-close dialog after successful upload (1.5s delay)
  - [x] Keep dialog open on error for retry

- [x] **Task 8: Implement Success Callback (AC: 7)**
  - [x] Call `onSuccess()` prop after successful upload
  - [x] Reset form state after successful upload
  - [x] Clear file selection and teacher_id

- [x] **Task 9: Wire Up to Teachers Page (AC: 1)**
  - [x] Import TeacherUploadDialog in Teachers.tsx
  - [x] Add upload dialog state and handlers:
    ```tsx
    const [uploadDialogOpen, setUploadDialogOpen] = useState(false);

    <TeacherUploadDialog
      open={uploadDialogOpen}
      onClose={() => setUploadDialogOpen(false)}
      token={token}
      tokenType={tokenType}
      onSuccess={loadMaterials}
    />
    ```

## Dev Notes

### API Endpoint
[Source: apps/api/app/routers/teachers.py]

```
POST /teachers/{teacher_id}/upload
Content-Type: multipart/form-data

Request: FormData with 'file' field
Response: {
  "teacher_id": "teacher_123",
  "filename": "lesson.pdf",
  "path": "teacher_123/materials/lesson.pdf",
  "size": 1024,
  "content_type": "application/pdf"
}
```

### Allowed MIME Types
[Source: apps/api/app/core/config.py]

```python
teacher_allowed_mime_types = {
    "documents": ["application/pdf", "text/plain", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"],
    "images": ["image/jpeg", "image/png", "image/gif", "image/webp"],
    "audio": ["audio/mpeg", "audio/wav", "audio/ogg", "audio/mp4"],
    "video": ["video/mp4", "video/webm", "video/quicktime"],
}
```

### File Size Limit
[Source: apps/api/app/core/config.py]

```python
teacher_max_file_size_bytes: int = 104857600  # 100MB
```

### BookUploadDialog Pattern to Follow
[Source: apps/admin-panel/src/components/BookUploadDialog.tsx]

```tsx
// Drag-and-drop zone styling
<Box
  sx={{
    border: '2px dashed',
    borderColor: 'divider',
    borderRadius: 2,
    p: 4,
    textAlign: 'center',
    bgcolor: 'background.default',
    cursor: uploading ? 'not-allowed' : 'pointer',
    '&:hover': uploading ? {} : {
      borderColor: 'primary.main',
      bgcolor: 'action.hover',
    },
  }}
  component="label"
>
  <CloudUploadIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
  <Typography variant="h6">Click to select file</Typography>
  <input type="file" hidden onChange={handleFileChange} disabled={uploading} />
</Box>
```

### File Locations

| File | Action |
|------|--------|
| `src/components/TeacherUploadDialog.tsx` | CREATE |
| `src/lib/teachers.ts` | MODIFY (add uploadTeacherMaterial) |
| `src/pages/Teachers.tsx` | MODIFY (wire up dialog) |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-14 | 0.2 | Implementation complete - all 9 tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-5-20250929)

### Debug Log References
None - implementation proceeded without blocking issues.

### Completion Notes List
- Created TeacherUploadDialog component following BookUploadDialog patterns
- Added `uploadTeacherMaterial()` and `UploadTeacherMaterialResponse` interface to teachers.ts
- Dialog includes: Teacher ID input (required), drag-and-drop file zone, file type/size validation
- File size validation (100MB) occurs client-side before upload attempt
- LinearProgress indicator shown during upload
- Success/error feedback with auto-close on success (1.5s delay)
- Wired dialog to Teachers.tsx replacing placeholder
- All 19 teachers API tests pass
- No TypeScript errors in modified files
- Pre-existing lint warnings in other files (Dashboard.tsx, Books.tsx) unrelated to this story

### File List
| File | Action |
|------|--------|
| `apps/admin-panel/src/components/TeacherUploadDialog.tsx` | CREATED |
| `apps/admin-panel/src/lib/teachers.ts` | MODIFIED (added uploadTeacherMaterial, UploadTeacherMaterialResponse) |
| `apps/admin-panel/src/pages/Teachers.tsx` | MODIFIED (wired TeacherUploadDialog, added import) |

---

## QA Results

### Review Date: 2025-12-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates strong adherence to established patterns and clean component design. The TeacherUploadDialog follows BookUploadDialog.tsx patterns effectively, with proper state management, error handling, and user feedback. The upload function in teachers.ts uses native fetch API appropriately for multipart/form-data uploads.

**Strengths:**
- Clean separation of concerns between component and API layer
- Comprehensive client-side validation (file type, size, required fields)
- User-friendly error messages with specific validation feedback
- Proper TypeScript typing throughout
- Follows MUI component patterns consistently
- Good UX with visual feedback (LinearProgress, Alert messages, auto-close)

**Minor Observations:**
- Variable `fileSizeError` is used for both file size and file type errors - slightly misleading name but functionally correct
- No frontend unit tests (consistent with existing project pattern for dialogs/pages)

### Refactoring Performed

None - code quality is production-ready as implemented.

### Compliance Check

- Coding Standards: ✓ Follows established React/TypeScript patterns
- Project Structure: ✓ Files in correct locations (components/, lib/, pages/)
- Testing Strategy: ✓ Backend API tests present (19/19 pass), frontend tests not required per existing patterns
- All ACs Met: ✓ All 8 acceptance criteria fully implemented

### Improvements Checklist

- [N/A] No blocking issues requiring immediate action
- [N/A] No refactoring needed - implementation is clean
- [ ] Future consideration: Add frontend unit tests for TeacherUploadDialog component (not blocking, project has no frontend tests currently)

### Security Review

✓ **PASS** - Security measures are appropriate:
- Authentication headers properly included in upload request
- Teacher ID is URL-encoded to prevent injection
- File type validation occurs both client-side and server-side
- File size validation prevents oversized uploads
- Server performs final validation (backend tests confirm)

### Performance Considerations

✓ **PASS** - Performance is well-optimized:
- Client-side validation prevents unnecessary API calls for invalid files
- File size check occurs before upload (saves bandwidth)
- FormData used correctly for efficient binary uploads
- No performance bottlenecks identified

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/7.2-create-teacher-upload-dialog.yml

### Recommended Status

**✓ Ready for Done** - Implementation meets all requirements with high quality. No changes required.
