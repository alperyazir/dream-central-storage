# Story 5.6: Persist Admin Sessions Across Refreshes

## Status
Done

## Story
**As an** administrator,
**I want** my authenticated session to survive page refreshes,
**so that** I can continue working without logging in repeatedly.

## Acceptance Criteria
1. Authentication tokens or session cookies persist beyond a single page load while respecting existing backend time-to-live settings.
2. On app bootstrap, the admin panel attempts to rehydrate and validate any persisted session before redirecting to the login page.
3. Failed validations (expired/invalid tokens) trigger a controlled logout with messaging prompting re-authentication.
4. Security practices follow architecture guidance (e.g., HTTP-only cookies or secure storage wrappers) with documented reasoning.
5. Automated tests cover persisted-state rehydration, expiry handling, and logout flows.

## Tasks / Subtasks
- [x] Review current authentication flow to determine best persistence mechanism (HTTP-only cookie vs encrypted storage) in line with architecture guidance (AC: 1, 4) [Source: docs/stories/3.2.admin-login-page-authentication.md#dev-notes]
- [x] Implement persistence layer (e.g., secure cookie issuance from backend or encrypted storage wrapper in frontend) and update login success handling (AC: 1) [Source: docs/architecture/15-security-and-performance.md#security]
- [x] Modify app initialization to check for persisted credentials, validate them via API, and hydrate state before rendering protected routes (AC: 2) [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture]
- [x] Handle expiry/invalid tokens by clearing persisted state, redirecting to login, and surfacing appropriate messaging (AC: 3) [Source: docs/prd/requirements.md#non-functional]
- [x] Add automated tests covering persisted session success, expiry, and forced logout scenarios (AC: 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [x] Update documentation to clarify administrator expectations around session duration and logout triggers (AC: 4) [Source: docs/prd/user-interface-design-goals.md#overall-ux-vision]

## Dev Notes
### Previous Story Insights
- Story 3.2 intentionally avoided session persistence; revisit its decisions to implement a secure version without reintroducing prior risks. [Source: docs/qa/gates/3.2-admin-login-page-authentication.yml]
- Story 3.3 leverages Zustand for auth state; ensure persistence changes remain compatible with existing store patterns. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]

### Data Models
- User tokens and metadata are defined in authentication modules; confirm any additional fields (e.g., refresh tokens) are captured if introduced. [Source: docs/architecture/4-data-models.md#4-data-models]

### API Specifications
- If shifting to cookie-based sessions, document new endpoints or response headers (e.g., `Set-Cookie`) in the API spec. [Source: docs/architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Ensure ProtectedRoute components handle loading states while session validation occurs to avoid flicker. [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]

### File Locations
- Backend authentication logic lives under `apps/api/app/core/auth`. Frontend auth store and guards reside in `apps/admin-panel/src/stores/auth` and `apps/admin-panel/src/routes`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Include unit tests for persistence helpers, integration tests for API validation, and frontend tests ensuring routes respect persisted sessions. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Maintain compliance with security requirements (e.g., secure/httponly flags for cookies, encryption for storage) to prevent token leakage. [Source: docs/architecture/15-security-and-performance.md#security]

### Project Structure Notes
- Coordinate with DevOps to ensure any environment variables needed for cookie secrets or token lifetimes are documented. [Source: docs/architecture/14-deployment-architecture.md#14-deployment-architecture]

## Testing
- Backend: tests for session validation endpoints or cookie issuance.
- Frontend: unit/integration tests for persistence and logout flows.
- Manual: verify persistence across refresh and expiry timers in staging.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-04 | 0.1 | Initial draft created. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- N/A

### Completion Notes List
- Selected localStorage-backed token persistence with server-side validation to balance deployment simplicity and security, documenting the rationale in the UX guide.
- Added `/auth/session` endpoint plus validation logic so the UI rehydrates sessions safely and clears invalid tokens with controlled messaging.
- Hydrated the admin store on app bootstrap, introduced a bootstrap loader, and expanded automated coverage for session reuse and retention errors.

### File List
- apps/api/app/routers/auth.py
- apps/api/app/schemas/auth.py
- apps/api/app/schemas/__init__.py
- apps/api/tests/test_auth_login.py
- apps/admin-panel/src/App.tsx
- apps/admin-panel/src/lib/auth.ts
- apps/admin-panel/src/lib/auth-storage.ts
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/stores/auth.ts
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- apps/admin-panel/src/__tests__/layout.test.tsx
- apps/admin-panel/src/__tests__/trash.test.tsx
- docs/prd/user-interface-design-goals.md

## QA Results
- Not yet reviewed.
