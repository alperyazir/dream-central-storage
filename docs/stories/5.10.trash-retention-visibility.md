# Story 5.10: Trash Retention Visibility - Brownfield Addition

## Status
In Progress

## Story
**As an** administrator,
**I want** the trash view to show when each entry satisfies the seven-day retention window,
**so that** I can plan deletions or escalate overrides without trial-and-error API failures.

## Story Context
**Existing System Integration:**
- Integrates with: `GET /storage/trash` listing endpoint, permanent delete flow (`DELETE /storage/trash`), and admin trash table rendering (`apps/api/app/routers/storage.py`, `apps/api/app/services/storage.py`, `apps/admin-panel/src/pages/Trash.tsx`).
- Technology: FastAPI + Pydantic backend, React + Material UI frontend, Zustand auth store, MinIO storage. [Source: docs/architecture/3-tech-stack.md#3-tech-stack]
- Follows pattern: Story 5.5 permanent deletion workflow and Story 4.2 trash restore interactions provide modal flows and error handling conventions. [Source: docs/stories/5.5.permanent-delete-from-trash.md#dev-notes; docs/stories/4.2.restore-functionality-from-trash.md#dev-notes]
- Touch points: `TrashEntryRead` schema, `trash_retention_days` configuration, admin `deleteTrashEntry` client, confirmation modal copy, Vitest trash UI suite.

## Acceptance Criteria
1. `GET /storage/trash` returns retention metadata per entry: the newest object timestamp, the deletion eligibility timestamp (youngest + retention window), and a boolean flag indicating if the entry is eligible for deletion without overrides.
2. The admin trash table surfaces each entryâ€™s retention status, showing a relative countdown (e.g., "Eligible in 5 days" or "Eligible now") and exposing accessible text describing retention constraints. [Source: docs/prd/user-interface-design-goals.md#core-screens-and-views]
3. When an entry is still within the retention window, the regular "Delete" button remains disabled and displays guidance explaining the remaining duration; once eligible, the button re-enables without requiring a refresh, and force-delete UI from Story 5.9 can still be triggered intentionally.
4. Successful retention metadata is audited alongside existing trash reads; errors follow established JSON error patterns. [Source: docs/prd/requirements.md#non-functional; docs/architecture/18-error-handling-strategy.md#18-error-handling-strategy]
5. Automated tests cover retention metadata calculations, serialization, UI messaging, and button state transitions in both eligible and ineligible scenarios. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

## Tasks / Subtasks
- [x] Extend storage aggregation to compute `youngest_last_modified`, `eligible_at`, and `eligible_for_deletion` using `trash_retention_days`, including UTC handling and None-safe fallbacks (AC: 1, 4) [Source: apps/api/app/services/storage.py]
  - [x] Update `TrashEntryRead` schema (and TypeScript equivalent) to surface the new fields with ISO 8601 strings and boolean flag (AC: 1) [Source: apps/api/app/schemas/storage.py; apps/admin-panel/src/lib/storage.ts]
  - [x] Add Pytest coverage for aggregation scenarios (mix of eligible/ineligible entries, missing timestamps) and ensure audit logging captures retention metadata references (AC: 1, 4, 5) [Source: apps/api/tests/test_storage_service.py]
- [x] Enhance `GET /storage/trash` router to map new dataclass fields, log retention context, and document the response in generated OpenAPI (AC: 1, 4) [Source: apps/api/app/routers/storage.py; docs/architecture/5-api-specification.md#5-api-specification]
- [x] Update admin trash UI to consume new metadata, render countdown/status badges, and disable delete buttons until eligible while providing tooltips and screen-reader text; ensure override modal from Story 5.9 can still initiate force deletions (AC: 2, 3) [Source: apps/admin-panel/src/pages/Trash.tsx]
  - [x] Refresh client helpers and Zustand interactions to thread retention metadata through state, and update Vitest suites for countdown messaging and button state toggles (AC: 2, 3, 5) [Source: apps/admin-panel/src/lib/storage.ts; apps/admin-panel/src/__tests__/trash.test.tsx]
- [x] Document retention visibility behaviour in operator/admin guidance so support teams know how to interpret the countdown (AC: 2, 4) [Source: docs/operations/minio-backup-runbook.md]

## Dev Notes
### Previous Story Insights
- Story 5.5 established delete modals, success toasts, and error copy for trash actions; reuse its pattern for surfacing retention messaging alongside the confirmation dialog. [Source: docs/stories/5.5.permanent-delete-from-trash.md#dev-notes]
- Story 5.9 introduces force-delete overrides; retention countdown should integrate by clarifying when overrides are necessary and by surfacing the remaining duration before natural eligibility. [Source: docs/stories/5.9.force-delete-trash-override.md#dev-notes]

### Data Models
- `TrashEntryRead` currently omits retention metadata; expand the schema with timestamp fields (`youngest_last_modified`, `eligible_at`) and an `eligible_for_deletion` flag while keeping backward compatibility for existing consumers. [Source: apps/api/app/schemas/storage.py]
- Settings include `trash_retention_days`, so calculation should use `timedelta(days=settings.trash_retention_days)` and produce UTC-aware timestamps. [Source: apps/api/app/core/config.py:40]

### API Specifications
- `GET /storage/trash` is authenticated via JWT and maps dataclass fields into Pydantic responses; add retention metadata fields to the response and ensure OpenAPI docs update automatically. [Source: apps/api/app/routers/storage.py#L106; docs/architecture/11-backend-architecture.md#11-backend-architecture]
- Storage service aggregation needs to normalize MinIO `last_modified` values (already `datetime`) and handle entries lacking timestamps by defaulting eligibility to false until retention can be verified. [Source: apps/api/app/services/storage.py#L342]

### Component Specifications
- Trash page uses Material UI table rows with action buttons; introduce a status column or inline badge that communicates retention countdown with accessible labels. [Source: apps/admin-panel/src/pages/Trash.tsx:210]
- Client helpers in `apps/admin-panel/src/lib/storage.ts` define `TrashEntry`; update the interface and associated consumers to include the retention fields and derived helpers for formatting durations. [Source: apps/admin-panel/src/lib/storage.ts#L11]

### File Locations
- Backend changes: `apps/api/app/services/storage.py`, `apps/api/app/schemas/storage.py`, `apps/api/app/routers/storage.py`, tests under `apps/api/tests/` per unified structure. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]
- Frontend changes: `apps/admin-panel/src/lib/storage.ts`, `apps/admin-panel/src/pages/Trash.tsx`, shared utilities under `apps/admin-panel/src/utils` if needed, Vitest suites in `apps/admin-panel/src/__tests__/trash.test.tsx`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Follow testing pyramid: Pytest for backend retention calculations, Vitest + React Testing Library for UI countdown and button states, end-to-end scenario verifying eligibility toggles optional. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Retention messaging must align with the seven-day requirement and remain compliant with audit expectations; ensure timestamps use UTC ISO strings for consistency. [Source: docs/prd/requirements.md#non-functional]
- UI messaging should remain accessible and match light turquoise design updates (Story 5.7); use existing typography/color tokens. [Source: docs/stories/5.7.refresh-admin-ui-light-turquoise.md#dev-notes]

### Project Structure Notes
- No deviations from existing monorepo layout; reuse service-layer patterns for retention calculations. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Risk and Compatibility Check
- Primary Risk: Incorrect timestamp calculations could enable premature deletions or keep eligible entries blocked.
- Mitigation: Unit-test edge cases (no timestamps, timezones, exactly 7 days) and verify countdown formatting ties to backend metadata.
- Rollback: Revert schema/UI additions; trash listing still functions with minimal data.

### Compatibility Verification
- [x] Ensure API consumers (admin panel only) are updated before deployment to avoid runtime errors.
- [x] Confirm added schema fields remain backward compatible for future integrations.
- [x] Validate countdown respects language-neutral formatting and handles large durations gracefully.

### Validation Checklist
- [x] Countdown always references backend timestamps.
- [x] Delete buttons unblock as soon as entries become eligible without reload (poll or targeted refresh).
- [x] Override flow messaging references retention countdown appropriately.
- [x] Documentation explains retention timeline clearly.

## Testing
- Backend: Pytest coverage for retention metadata aggregation and router serialization in `apps/api/tests/test_storage_endpoints.py`.
- Frontend: Vitest + RTL cases for countdown text, tooltip/aria messaging, and button disablement scenarios in `apps/admin-panel/src/__tests__/trash.test.tsx`.
- Manual: Smoke test trash listing with entries at various ages, confirm countdown transitions at eligibility, and verify logs capture retention context.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-06 | 0.1 | Initial draft defining trash retention visibility story. | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- None

### Completion Notes List
- Added retention metadata (`youngest_last_modified`, `eligible_at`, `eligible_for_deletion`) to storage aggregation, API schema, and router logging.
- Updated admin trash UI to show countdown badges, disable delete actions until eligible, and provide inline override access with accessible messaging.
- Expanded backend Pytest coverage for aggregation edge cases and Vitest suites for retention messaging, button state transitions, and override flows.
- Skipped `npx turbo run test --filter=admin-panel` per prior instruction; executed targeted `pytest apps/api/tests/test_storage_service.py::test_list_trash_entries_aggregates_books_and_apps`.

### File List
- apps/api/app/services/storage.py
- apps/api/app/routers/storage.py
- apps/api/app/schemas/storage.py
- apps/api/tests/test_storage_service.py
- apps/api/tests/test_storage_trash_endpoints.py
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/pages/Trash.tsx
- apps/admin-panel/src/__tests__/trash.test.tsx
- docs/operations/minio-backup-runbook.md

## QA Results
- 
