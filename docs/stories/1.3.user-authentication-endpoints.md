# Story 1.3: User Authentication Endpoints

## Status
Done

## Story
**As an** administrator,
**I want** to securely log in to the system,
**so that** I can receive an access token for making authenticated API requests.

## Acceptance Criteria
1. A `users` table is created in the database to store admin credentials securely (hashed passwords).
2. An endpoint (e.g., `POST /auth/login`) is created that accepts admin credentials.
3. Upon successful authentication, the endpoint returns a JWT access token.
4. A command-line script is created to securely add the first admin user to the database.

## Tasks / Subtasks
- [x] Define user persistence model and migration (AC: 1) [Source: architecture/4-data-models.md#user]
  - [x] Add SQLAlchemy `User` model with hashed password field in `apps/api/app/models` (AC: 1) [Source: architecture/4-data-models.md#user]
  - [x] Create Alembic revision that provisions the `users` table with secure defaults (AC: 1) [Source: architecture/3-tech-stack.md#3-tech-stack]
- [x] Implement credential storage and provisioning utilities (AC: 1, 4) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Introduce reusable password hashing/verification helpers aligned with FastAPI security patterns (AC: 1) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
  - [x] Build a CLI script to insert the initial admin with hashed password in `apps/api/scripts` (AC: 4) [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
- [x] Expose authentication schemas and repository helpers (AC: 1, 2) [Source: architecture/11-backend-architecture.md#11-backend-architecture]
  - [x] Add Pydantic request schema for login payload and response schema for JWT token (AC: 2, 3) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Extend repository layer with user lookup method for authentication (AC: 1, 2) [Source: architecture/2-high-level-architecture.md#architectural-patterns]
- [x] Implement `POST /auth/login` endpoint with JWT issuance (AC: 2, 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Validate credentials against hashed passwords and return 401 on failure (AC: 2) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Issue JWT access token containing user identifier and expiry (AC: 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
- [x] Add backend tests covering authentication flows (AC: 1, 2, 3, 4) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write Pytest cases for successful and failed login scenarios (AC: 2, 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add test ensuring admin bootstrap script hashes passwords and persists users correctly (AC: 1, 4) [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Dev Notes
### Previous Story Insights
- Alembic migrations and ORM models are already established for the books domain, so follow the same patterns when introducing the user schema and migrations. [Source: docs/stories/1.2.book-metadata-model-database-migration.md#dev-agent-record]

### Data Models
- Admin users must persist `email` and `hashed_password` fields, matching the shared `User` contract; responses should avoid exposing the hashed credential. [Source: architecture/4-data-models.md#user]

### API Specifications
- REST API endpoints follow the project’s OpenAPI contract, which includes authentication routes; ensure the login request/response align with the documented shape. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- No specific guidance found in architecture docs.

### File Locations
- Backend code, including models, routers, and scripts, belongs under `apps/api` consistent with the monorepo layout. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Backend behaviour is validated with Pytest; add unit tests for authentication logic and provisioning utilities to maintain coverage. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Implement the solution using FastAPI on Python 3.11+ with PostgreSQL and JWT-based authentication per the approved stack. [Source: architecture/3-tech-stack.md#3-tech-stack]
- Apply the repository abstraction for database access to keep persistence logic modular. [Source: architecture/2-high-level-architecture.md#architectural-patterns]
- Follow established backend patterns for authentication dependencies and security best practices. [Source: architecture/11-backend-architecture.md#11-backend-architecture]

### Project Structure Notes
- New modules for authentication (routers, schemas, repositories, scripts) must adhere to the existing monorepo structure under `apps/api`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing
- Ensure new Pytest suites integrate with the existing command set so CI continues to run linting and tests automatically. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | Implementation completed; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Story verified and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from `apps/api/`, all 12 tests passed)

### Completion Notes List
- Added SQLAlchemy `User` model with Alembic migration and dialect-aware trigger to maintain updated timestamps.
- Implemented PBKDF2 password hashing, lightweight JWT generation utilities, and a user repository lookup helper.
- Delivered `/auth/login` FastAPI router returning bearer tokens and normalized email handling.
- Created CLI bootstrap script plus entry-point wrapper for seeding the first admin with hashed credentials.
- Authored Pytest suites covering migrations, login success/failure flows, and admin bootstrap behaviour.

### File List
- apps/api/alembic/env.py
- apps/api/alembic/versions/20250923_01_create_users_table.py
- apps/api/app/core/config.py
- apps/api/app/core/security.py
- apps/api/app/main.py
- apps/api/app/models/__init__.py
- apps/api/app/models/user.py
- apps/api/app/repositories/__init__.py
- apps/api/app/repositories/user.py
- apps/api/app/routers/__init__.py
- apps/api/app/routers/auth.py
- apps/api/app/schemas/__init__.py
- apps/api/app/schemas/auth.py
- apps/api/app/scripts/__init__.py
- apps/api/app/scripts/create_admin.py
- apps/api/scripts/__init__.py
- apps/api/scripts/create_admin.py
- apps/api/tests/test_auth_login.py
- apps/api/tests/test_migrations_users.py
- apps/api/tests/test_scripts_create_admin.py
- docs/stories/1.3.user-authentication-endpoints.md

## QA Results
- Gate: PASS – Authentication flow, migrations, and bootstrap tooling satisfy acceptance criteria; tests cover login success/failure and schema triggers (`apps/api/tests/test_auth_login.py:1`, `apps/api/tests/test_migrations_users.py:1`).
- Evidence:
  - Alembic migration provisions `users` table with timestamp trigger validated via integration tests (`apps/api/alembic/versions/20250923_01_create_users_table.py:15`).
  - Login endpoint issues bearer token and enforces credential rejection on mismatch (`apps/api/app/routers/auth.py:18`, `apps/api/tests/test_auth_login.py:28`).
  - Bootstrap script applies hashed passwords and guards duplicate admins (`apps/api/app/scripts/create_admin.py:18`, `apps/api/tests/test_scripts_create_admin.py:28`).
- Residual Risks:
  - No dedicated unit test asserts JWT claims/expiry despite manual token construction; consider adding coverage for `create_access_token` to catch regressions (`apps/api/app/core/security.py:63`).
