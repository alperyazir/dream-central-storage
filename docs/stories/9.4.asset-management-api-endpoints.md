# Story 9.4: Asset Management API Endpoints

## Status

Ready for Review

## Story

**As an** API consumer,
**I want** endpoints to upload and manage publisher assets by type,
**so that** the frontend can support dynamic content type uploads.

## Acceptance Criteria

1. New endpoints in `app/routers/publishers.py`:
   ```
   GET  /publishers/{publisher_id}/assets
        → List all asset types with file counts

   GET  /publishers/{publisher_id}/assets/{asset_type}
        → List files in specific asset type

   POST /publishers/{publisher_id}/assets/{asset_type}
        → Upload file to asset type (creates folder if needed)

   DELETE /publishers/{publisher_id}/assets/{asset_type}/{filename}
        → Soft-delete file to trash
   ```

2. Storage path structure:
   ```
   publishers/
     {publisher_name}/
       books/           ← Existing book content
         {book_name}/
       assets/          ← New asset structure
         materials/
           worksheet1.pdf
         logos/
           logo.png
         {custom_type}/
           file.ext
   ```

3. Asset type validation:
   - Pattern: `^[a-z0-9_-]{1,50}$`
   - Reserved names rejected: `books`, `trash`, `temp`
   - Returns 400 Bad Request for invalid asset type

4. `GET /publishers/{id}/assets` response:
   ```json
   {
     "publisher_id": 1,
     "publisher_name": "Universal ELT",
     "asset_types": [
       {"name": "materials", "file_count": 5, "total_size": 15000000},
       {"name": "logos", "file_count": 2, "total_size": 50000}
     ]
   }
   ```

5. `POST /publishers/{id}/assets/{type}` behavior:
   - Creates `assets/{type}/` folder if doesn't exist
   - Validates file against content type rules (if defined)
   - Returns uploaded file metadata

6. Delete moves to trash with metadata:
   ```
   trash/publishers/{publisher_name}/assets/{type}/{filename}
   ```

7. Trash listing (`list_trash_entries`) updated to recognize asset items:
   - `item_type: "publisher_asset"`
   - `metadata: {"publisher": "...", "asset_type": "...", "filename": "..."}`

8. All endpoints require authentication (existing `_require_admin` pattern).

9. Tests added for all new endpoints.

## Tasks / Subtasks

- [x] **Task 1: Define Pydantic Schemas for Assets (AC: 4)**
  - [x] Create `apps/api/app/schemas/asset.py`:
    ```python
    class AssetTypeInfo(BaseModel):
        name: str
        file_count: int
        total_size: int

    class PublisherAssetsResponse(BaseModel):
        publisher_id: int
        publisher_name: str
        asset_types: list[AssetTypeInfo]

    class AssetFileInfo(BaseModel):
        name: str
        path: str
        size: int
        content_type: str
        last_modified: datetime | None
    ```

- [x] **Task 2: Add Asset Type Validation Helper (AC: 3)**
  - [x] Add to `app/routers/publishers.py`:
    ```python
    import re

    ASSET_TYPE_PATTERN = re.compile(r'^[a-z0-9_-]{1,50}$')
    RESERVED_ASSET_TYPES = {'books', 'trash', 'temp'}

    def validate_asset_type(asset_type: str) -> None:
        if not ASSET_TYPE_PATTERN.match(asset_type):
            raise HTTPException(400, "Invalid asset type format")
        if asset_type in RESERVED_ASSET_TYPES:
            raise HTTPException(400, f"'{asset_type}' is a reserved name")
    ```

- [x] **Task 3: Implement GET /publishers/{id}/assets (AC: 1, 4)**
  - [x] List all folders under `publishers/{name}/assets/`
  - [x] Count files and sum sizes per asset type
  - [x] Return PublisherAssetsResponse

- [x] **Task 4: Implement GET /publishers/{id}/assets/{type} (AC: 1)**
  - [x] Validate asset_type
  - [x] List files under `publishers/{name}/assets/{type}/`
  - [x] Return list of AssetFileInfo

- [x] **Task 5: Implement POST /publishers/{id}/assets/{type} (AC: 1, 2, 5)**
  - [x] Validate asset_type
  - [x] Get publisher by ID, use publisher.name for storage path
  - [x] Upload file to MinIO: `publishers/{name}/assets/{type}/{filename}`
  - [x] Return uploaded file metadata

- [x] **Task 6: Implement DELETE /publishers/{id}/assets/{type}/{filename} (AC: 1, 6)**
  - [x] Validate asset_type
  - [x] Move file to trash: `trash/publishers/{name}/assets/{type}/{filename}`
  - [x] Use existing `move_prefix_to_trash` or similar pattern

- [x] **Task 7: Update Trash Listing for Assets (AC: 7)**
  - [x] Update `list_trash_entries()` in `storage.py`
  - [x] Add detection for `publishers/{name}/assets/{type}` pattern
  - [x] Set `item_type: "publisher_asset"` with proper metadata

- [x] **Task 8: Add Authentication to All Endpoints (AC: 8)**
  - [x] Use existing `_require_admin` pattern
  - [x] All endpoints return 401 without valid token

- [x] **Task 9: Add Unit Tests (AC: 9)**
  - [x] Create `apps/api/tests/test_publisher_assets_endpoints.py`
  - [x] Test list asset types (empty, with assets)
  - [x] Test list files in asset type
  - [x] Test upload file to new asset type
  - [x] Test upload file to existing asset type
  - [x] Test delete file (moves to trash)
  - [x] Test invalid asset type validation
  - [x] Test reserved name rejection

## Dev Notes

### Storage Path Examples
```
MinIO Bucket: publishers

publishers/
  Universal ELT/
    books/
      BRAINS/
        config.json
        data/...
    assets/
      materials/
        worksheet1.pdf
        audio_guide.mp3
      logos/
        logo.png
        logo-dark.png
      videos/
        intro.mp4
```

### MinIO Operations
Use existing MinIO client pattern:
```python
from app.services import get_minio_client
from app.core.config import get_settings

settings = get_settings()
client = get_minio_client(settings)

# List folders (asset types)
objects = client.list_objects(bucket, prefix=f"{publisher_name}/assets/", recursive=False)

# Upload file
client.put_object(bucket, object_name, data, length, content_type)

# List files in asset type
objects = client.list_objects(bucket, prefix=f"{publisher_name}/assets/{asset_type}/", recursive=True)
```

### Trash Path Structure
When deleting an asset:
```
Source: publishers/Universal ELT/assets/logos/logo.png
Trash:  trash/publishers/Universal ELT/assets/logos/logo.png
```

### Dependencies
- Epic 8 Publisher API must be complete (publisher lookup by ID)
- Existing MinIO integration in storage.py
- Existing trash functionality

### Testing Strategy
Use pytest with mocked MinIO client:
```python
@pytest.fixture
def mock_minio_client(mocker):
    return mocker.patch('app.services.get_minio_client')

def test_list_asset_types(client, mock_minio_client, auth_headers):
    mock_minio_client.return_value.list_objects.return_value = [...]
    response = client.get('/publishers/1/assets', headers=auth_headers)
    assert response.status_code == 200
```

### API Documentation
After implementation, verify OpenAPI docs at `/docs` show:
- `/publishers/{publisher_id}/assets` - GET
- `/publishers/{publisher_id}/assets/{asset_type}` - GET
- `/publishers/{publisher_id}/assets/{asset_type}` - POST (file upload)
- `/publishers/{publisher_id}/assets/{asset_type}/{filename}` - DELETE

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes
- Created Pydantic schemas for asset management (AssetTypeInfo, PublisherAssetsResponse, AssetFileInfo)
- Implemented asset type validation with pattern matching and reserved name checking
- Implemented 4 new API endpoints for publisher asset management:
  - GET /publishers/{id}/assets - List all asset types with file counts and sizes
  - GET /publishers/{id}/assets/{type} - List files in specific asset type
  - POST /publishers/{id}/assets/{type} - Upload file to asset type
  - DELETE /publishers/{id}/assets/{type}/{filename} - Soft-delete file to trash
- Updated trash listing in storage.py to recognize publisher_asset items
- All endpoints use existing `_require_admin` authentication pattern
- Created comprehensive test suite with 16 new tests (15 endpoint tests + 1 trash listing test)
- All tests pass, no regressions introduced
- Full regression: 172 tests pass (16 new, up from 156)

### File List
**Modified:**
- `apps/api/app/routers/publishers.py` - Added asset type validation and 4 asset management endpoints
- `apps/api/app/services/storage.py` - Updated list_trash_entries() to recognize publisher_asset items
- `apps/api/app/schemas/__init__.py` - Added exports for new asset schemas

**Created:**
- `apps/api/app/schemas/asset.py` - Pydantic schemas for asset management
- `apps/api/tests/test_publisher_assets_endpoints.py` - Comprehensive endpoint tests (15 tests)

**Deleted:**
None

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-18 | 0.1 | Initial story draft | John (PM Agent) |
| 2025-12-19 | 1.0 | Implementation complete - all tests pass | James (Dev Agent) |
