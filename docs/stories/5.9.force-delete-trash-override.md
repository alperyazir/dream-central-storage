# Story 5.9: Force Delete Overrides for Trash Items

## Status
Done

## Story
**As an** administrator,
**I want** an authorised way to force-delete trash entries before the seven-day retention window elapses,
**so that** I can immediately remove sensitive or erroneous uploads once compliance approvals exist.

## Story Context
**Existing System Integration:**
- Integrates with: `DELETE /trash` API endpoint, storage service `delete_prefix_from_trash`, admin trash list UI (`apps/api/app/routers/storage.py`, `apps/api/app/services/storage.py`, `apps/admin-panel/src/pages/Trash.tsx`).
- Technology: FastAPI + SQLAlchemy backend, React + Material UI admin panel, MinIO object storage.
- Follows pattern: Story 5.5 permanent delete workflow and Stories 4.1/4.2 trash lifecycle operations.
- Touch points: `TrashDeleteRequest` schema, audit logging utilities, toast/confirmation components, admin authentication guards.

## Acceptance Criteria
1. When a retention conflict occurs, the trash UI offers an "Override retention" flow restricted to authenticated administrators that requires explicit confirmation and a short justification before retrying the deletion.
2. Override requests send `force=true` with the provided justification to the `DELETE /trash` API, bypassing the retention age check while the default flow continues to enforce the seven-day window.
3. Forced deletions emit structured audit logs capturing administrator id, target key, timestamp, override flag, and justification in line with FR7/NFR3 logging expectations.
4. Success and failure feedback clearly distinguish forced deletions, refreshing the trash listing on success while preserving the existing retention warning when the override is not used.
5. Automated tests cover: backend forced deletion success and justification validation, retention conflict without override, override UI interactions, and regression of the default retention guard.

## Tasks / Subtasks
- [x] Extend `TrashDeleteRequest` and storage router logic to require a non-empty `override_reason` when `force` is true, updating schema validation and response payloads accordingly (AC: 2, 3) [Source: apps/api/app/schemas/storage.py; apps/api/app/routers/storage.py]
  - [x] Update `delete_prefix_from_trash` to accept the override reason, bypass retention checks when authorised, and include the justification in audit logs (AC: 2, 3) [Source: apps/api/app/services/storage.py]
- [x] Gate the override flow behind existing admin authentication so audit events capture the acting administrator per FR7 (AC: 1, 3) [Source: docs/prd/requirements.md#functional]
- [x] Enhance the admin trash view with an override modal/flow that surfaces retention details, collects justification, and replays the deletion with `force=true` (AC: 1, 4) [Source: apps/admin-panel/src/pages/Trash.tsx; docs/stories/5.5.permanent-delete-from-trash.md#dev-notes]
  - [x] Localise UI copy to explain compliance implications and add client-side validation for the justification field (AC: 1, 4) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- [x] Expand automated test coverage: Pytest cases for forced deletion and conflict scenarios, Vitest/RTL coverage for override UI, and ensure regression suites remain green (AC: 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [x] Update operator/admin documentation to describe retention overrides, auditing expectations, and escalation steps (AC: 3, 4) [Source: docs/operations/minio-backup-runbook.md; docs/prd/requirements.md#non-functional]

## Dev Notes
### Existing Workflow Insights
- Story 5.5 delivered the permanent delete path and surfaced retention conflict messaging; reuse its modal pattern and event wiring. [Source: docs/stories/5.5.permanent-delete-from-trash.md#dev-notes]
- Stories 4.1 and 4.2 established soft-delete, restore behaviours, and audit expectationsâ€”override logging should mirror those conventions. [Source: docs/stories/4.1.soft-delete-for-books-and-apps.md#dev-notes; docs/stories/4.2.restore-functionality-from-trash.md#dev-notes]

### API Touchpoints
- `TrashDeleteRequest` currently exposes `force` without justification; extend schema and OpenAPI docs to add an `override_reason`. [Source: apps/api/app/schemas/storage.py]
- Retention enforcement lives in `delete_prefix_from_trash`, comparing object ages against `settings.trash_retention_days`; add an authorised override branch while preserving default checks. [Source: apps/api/app/services/storage.py; apps/api/app/core/config.py]
- Storage router audit logs use `logger.info`; include the justification text and override flag for traceability per FR7. [Source: apps/api/app/routers/storage.py; docs/prd/requirements.md#functional]

### UI Considerations
- The admin trash screen handles retention errors in `Trash.tsx`; add a secondary dialog or inline flow that prompts for justification and retries with `force=true`. [Source: apps/admin-panel/src/pages/Trash.tsx]
- Frontend tests in `apps/admin-panel/src/__tests__/trash.test.tsx` already assert retention messaging; extend to cover override interactions. [Source: apps/admin-panel/src/__tests__/trash.test.tsx]

### Security & Authorization
- JWT-authenticated admins remain the only actors allowed to bypass retention; hide or disable override controls when credentials are missing or invalid. [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture; docs/prd/requirements.md#functional]

### File Locations
- Backend: `apps/api/app/schemas`, `apps/api/app/routers`, `apps/api/app/services`. Frontend: `apps/admin-panel/src/pages/trash`, reusable components under `apps/admin-panel/src/features`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Use Pytest for storage service/router paths and Vitest + React Testing Library for UI flows; consider an end-to-end scenario verifying audit logging. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Retention overrides must remain auditable and require explicit justification to satisfy compliance expectations in NFR3. [Source: docs/prd/requirements.md#non-functional]

### Project Structure Notes
- Update admin/operations guides so override usage and logging are documented alongside existing trash retention procedures. [Source: docs/operations/minio-backup-runbook.md]

### Risk and Compatibility Check
- Primary Risk: Misuse of overrides leading to premature data loss or compliance issues.
- Mitigation: Require justification, restrict access to authenticated admins, and emit detailed audit logs.
- Rollback: Disable the override UI and revert API schema changes to ignore `force` requests.

### Compatibility Verification
- [x] Default retention enforcement remains unchanged when overrides are not used.
- [x] No database schema modifications required.
- [x] API contract adjustments communicated via updated OpenAPI docs/SDKs.
- [x] UI components uphold Story 5.7 styling and accessibility guidelines.

### Validation Checklist
- [x] Override flow scoped strictly to trash deletions.
- [x] Copy clearly states compliance expectations and records justification.
- [x] Audit entries capture administrator id, target key, and override reason.
- [x] Automated tests cover both override and default behaviours.

## Testing
- Backend: `pytest tests/test_storage_endpoints.py` (apps/api)
- Frontend: `npm test -- --run src/__tests__/trash.test.tsx` (apps/admin-panel)
- Manual: In staging, attempt forced deletion of a <7-day trash item, verify audit log entries, and confirm standard deletions still block.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-06 | 0.1 | Initial draft outlining retention override story. | John (Product Manager) |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- `pytest tests/test_storage_endpoints.py`
- `npm test -- --run src/__tests__/trash.test.tsx`

### Completion Notes List
- Enforced override justification at the API boundary with schema updates, conditional validation, and enhanced audit logging.
- Bypassed retention only when authorised by updating storage services, router wiring, and backend pytest coverage for force and failure scenarios.
- Introduced admin UI override workflow with dedicated modal, justification capture, and Vitest coverage alongside documentation updates for operations.

### File List
- apps/api/app/schemas/storage.py
- apps/api/app/services/storage.py
- apps/api/app/routers/storage.py
- apps/api/tests/test_storage_endpoints.py
- apps/admin-panel/src/lib/storage.ts
- apps/admin-panel/src/pages/Trash.tsx
- apps/admin-panel/src/__tests__/trash.test.tsx
- docs/operations/minio-backup-runbook.md
- docs/stories/5.9.force-delete-trash-override.md

## QA Results
- 
