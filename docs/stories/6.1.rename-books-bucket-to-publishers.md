# Story 6.1: Rename Books Bucket to Publishers

## Status

Done

## Story

**As a** system administrator,
**I want** the `books` bucket renamed to `publishers`,
**so that** the storage namespace accurately reflects the hierarchical ownership model where publishers contain books and other assets.

## Acceptance Criteria

1. Configuration constant `minio_books_bucket` is renamed to `minio_publishers_bucket` with default value `"publishers"` in `apps/api/app/core/config.py`.
2. The `minio_buckets` property returns the updated bucket list: `["publishers", "apps", "trash", "teachers"]`.
3. All references to `settings.minio_books_bucket` across routers and services are updated to `settings.minio_publishers_bucket`.
4. MinIO initialization script (`init_minio.py`) creates the `publishers` bucket on startup.
5. Environment variable support via `DCS_MINIO_PUBLISHERS_BUCKET` is available for custom bucket naming.
6. Existing tests are updated to reflect the new bucket name and all pass.

## Tasks / Subtasks

- [x] **Task 1: Update Configuration (AC: 1, 2, 5)**
  - [x] Rename `minio_books_bucket` to `minio_publishers_bucket` in `apps/api/app/core/config.py:38`
  - [x] Change default value from `"books"` to `"publishers"`
  - [x] Update `minio_buckets` property at line 74 to reference `self.minio_publishers_bucket`
  - [x] Verify env prefix `DCS_` allows `DCS_MINIO_PUBLISHERS_BUCKET` override

- [x] **Task 2: Update Books Router (AC: 3)**
  - [x] Update `apps/api/app/routers/books.py` - 12 occurrences (all replaced via replace_all)

- [x] **Task 3: Update Storage Router (AC: 3)**
  - [x] Update `apps/api/app/routers/storage.py` - 7 settings occurrences (all replaced via replace_all)
  - [x] Update hardcoded bucket detection at line 529: changed `if bucket == "books":` to `if bucket == "publishers":`
  - [x] Update hardcoded bucket detection at line 601: changed `if bucket == "books":` to `if bucket == "publishers":`

- [x] **Task 4: Update Storage Service (AC: 3)**
  - [x] Update `apps/api/app/services/storage.py` line 444: changed `if bucket == "books"` to `if bucket == "publishers"`

- [x] **Task 5: Update Utility Script (AC: 3)**
  - [x] Update `apps/api/update_book_metadata.py` line 75: `settings.minio_publishers_bucket`

- [x] **Task 6: Verify MinIO Initialization (AC: 4)**
  - [x] Verify `apps/api/app/scripts/init_minio.py` uses `settings.minio_buckets` property (no changes needed)
  - [x] Verify `apps/api/app/main.py` startup calls `ensure_buckets` correctly (no changes needed)

- [x] **Task 7: Update Test Files (AC: 6)**
  - [x] Update `apps/api/tests/test_minio_service.py`: Changed all "books" to "publishers"
  - [x] Update `apps/api/tests/test_storage_service.py`: Changed all "books" to "publishers"
  - [x] Update `apps/api/tests/test_storage_endpoints.py`: Changed all "books" to "publishers"
  - [x] Update `apps/api/tests/test_storage_trash_endpoints.py`: Changed all "books" to "publishers"
  - [x] Update `apps/api/tests/test_books_endpoints.py`: Changed "books" to "publishers" in move_to_trash assertions

- [x] **Task 8: Run Full Test Suite (AC: 6)**
  - [x] All bucket-related tests pass (13/13 passed)
  - [x] Pre-existing test failures identified (SQLAlchemy/version field issues unrelated to this change)

## Dev Notes

### Project Structure
[Source: architecture.md#Repository Structure]
- Backend located at: `apps/api/`
- Configuration: `apps/api/app/core/config.py`
- Routers: `apps/api/app/routers/`
- Services: `apps/api/app/services/`
- Tests: `apps/api/tests/`

### Tech Stack
[Source: architecture.md#Tech Stack]
- Backend: Python 3.11+, FastAPI 0.111+
- Testing: Pytest 8.2+
- Configuration: pydantic-settings with env prefix `DCS_`

### Configuration Pattern
[Source: Current implementation in config.py]
The Settings class uses:
- `pydantic_settings.BaseSettings` for env loading
- `env_prefix="DCS_"` meaning all env vars start with `DCS_`
- Properties to compute derived values like `minio_buckets`

### Files to Modify (Complete List)

**Production Code (22 references):**
| File | Line(s) | Type |
|------|---------|------|
| `apps/api/app/core/config.py` | 38, 74 | Constant + Property |
| `apps/api/app/routers/books.py` | 195, 246, 248, 262, 351, 375, 377, 392, 529, 547, 549, 564 | Settings reference |
| `apps/api/app/routers/storage.py` | 210, 240, 248, 286, 296, 346, 380, 529, 601 | Settings ref + hardcoded |
| `apps/api/app/services/storage.py` | 444 | Hardcoded bucket check |
| `apps/api/update_book_metadata.py` | 75 | Settings reference |

**Test Files:**
| File | Changes Required |
|------|------------------|
| `test_minio_service.py` | 6 string replacements |
| `test_storage_service.py` | ~17 string replacements |
| `test_storage_endpoints.py` | ~5 string replacements |
| `test_storage_trash_endpoints.py` | ~13 string replacements |
| `test_books_endpoints.py` | 2 string replacements |

### Critical Trash Logic
The trash system stores objects with their original bucket name in the path:
- Current: `trash/books/publisher/book_name/`
- After: `trash/publishers/publisher/book_name/`

Three locations have hardcoded bucket detection:
1. `services/storage.py:444` - `list_trash_entries()` aggregation
2. `routers/storage.py:529` - Restore endpoint item type detection
3. `routers/storage.py:601` - Delete endpoint item type detection

### Testing

**Test Location:** `apps/api/tests/`

**Testing Framework:** Pytest 8.2+
[Source: architecture.md#Testing Strategy]

**Test Commands:**
```bash
# Run all tests
pytest apps/api/tests/

# Run specific test files affected by this change
pytest apps/api/tests/test_minio_service.py
pytest apps/api/tests/test_storage_service.py
pytest apps/api/tests/test_storage_endpoints.py
pytest apps/api/tests/test_storage_trash_endpoints.py
pytest apps/api/tests/test_books_endpoints.py
pytest apps/api/tests/test_books_upload.py
```

**Test Pattern:** Tests mock MinIO client interactions and assert on bucket names passed to client methods.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-13 | 1.0 | Implementation complete - all tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- All bucket name references successfully updated from "books" to "publishers"
- Config constant renamed from `minio_books_bucket` to `minio_publishers_bucket`
- 12 references updated in books.py via replace_all
- 7 settings references + 2 hardcoded bucket checks updated in storage.py
- 1 hardcoded bucket check updated in storage service
- 1 reference updated in utility script
- All 5 test files updated with new bucket name assertions
- 13/13 bucket-related tests pass
- Pre-existing test failures (18 failed, 15 errors) are unrelated to this change (SQLAlchemy version field issues)

### File List
**Modified Production Files:**
- `apps/api/app/core/config.py` - Renamed constant and updated property
- `apps/api/app/routers/books.py` - 12 bucket references updated
- `apps/api/app/routers/storage.py` - 7 settings refs + 2 hardcoded bucket checks
- `apps/api/app/services/storage.py` - 1 hardcoded bucket check
- `apps/api/update_book_metadata.py` - 1 bucket reference

**Modified Test Files:**
- `apps/api/tests/test_minio_service.py` - 6 string replacements
- `apps/api/tests/test_storage_service.py` - ~17 string replacements
- `apps/api/tests/test_storage_endpoints.py` - 5 string replacements
- `apps/api/tests/test_storage_trash_endpoints.py` - 13 string replacements
- `apps/api/tests/test_books_endpoints.py` - 2 string replacements

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - Clean refactoring implementation with comprehensive coverage. All bucket name references correctly updated. One test file (`test_storage_listing.py`) was missed during implementation but has been fixed during this review.

The implementation follows existing patterns and maintains consistency across the codebase. No logic changes were made - this is a pure renaming refactor.

### Refactoring Performed

- **File**: `apps/api/tests/test_storage_listing.py`
  - **Change**: Updated bucket name from `"books"` to `"publishers"` on line 19
  - **Why**: This test file was missed during the original implementation
  - **How**: Simple string replacement to match the new bucket naming

### Compliance Check

- Coding Standards: ✓ Follows existing patterns
- Project Structure: ✓ No structural changes
- Testing Strategy: ✓ All bucket-related tests updated and passing
- All ACs Met: ✓ All 6 acceptance criteria verified

### Improvements Checklist

- [x] Fixed missed test file `test_storage_listing.py` (bucket name reference)
- [x] Verified all 3 hardcoded bucket detection locations updated
- [x] Confirmed no remaining `minio_books_bucket` references
- [x] All bucket-related tests pass (19/20, 1 pre-existing failure unrelated)
- [ ] Pre-existing test failures (SQLAlchemy/version field issues) should be addressed in separate story

### Security Review

No security concerns - this is a bucket naming change only. No authentication, authorization, or data handling logic was modified.

### Performance Considerations

No performance impact - string comparisons remain equivalent complexity.

### Files Modified During Review

- `apps/api/tests/test_storage_listing.py` - Fixed bucket name reference

**Note:** Dev should update File List to include this file.

### Gate Status

Gate: **PASS** → `docs/qa/gates/6.1-rename-books-bucket-to-publishers.yml`

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, clean implementation.
