# Story 2.3: Application Build Folder Upload Endpoint

## Status
Done

## Story
**As an** administrator,
**I want** an API endpoint that can upload an application build folder,
**so that** I can add new FlowBook application versions to the system.

## Acceptance Criteria
1. A new endpoint (e.g., `POST /apps/{platform}/upload`) is created for app build uploads.
2. The endpoint accepts a folder and uploads its contents to the `apps` bucket in MinIO.
3. Files are stored under a path corresponding to their platform (e.g., `macOS/`, `windows/`).
4. The endpoint is protected and requires a valid JWT.

## Tasks / Subtasks
- [x] Define upload contract and validation (AC: 1, 2) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Determine request payload format (zipped archive via `multipart/form-data`) and required metadata such as platform or version (AC: 1, 2) [Source: architecture/6-components.md#storage]
  - [x] Validate `platform` against allowed values (`macOS`, `windows`) and derive storage prefix accordingly (AC: 3) [Source: architecture/8-core-workflows.md#8-core-workflows]
- [x] Implement MinIO app build upload service (AC: 2, 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Extend storage helpers to stream archive contents into `apps` bucket under `platform/version/` prefix (AC: 2, 3) [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
  - [x] Generate manifest including file paths and sizes for response payload (AC: 2) [Source: architecture/8-core-workflows.md#8-core-workflows]
- [x] Create authenticated upload endpoint (AC: 1, 2, 3, 4) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-agent-record]
  - [x] Add FastAPI route `/apps/{platform}/upload` protected by JWT auth dependency (AC: 1, 4) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Accept uploaded archive, invoke storage service, and return manifest with HTTP 201 status (AC: 2) [Source: architecture/5-api-specification.md#5-api-specification]
- [x] Error handling & observability (AC: 2, 3) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
  - [x] Translate archive/MinIO failures into sanitized HTTP errors (AC: 2) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Log upload outcomes with platform/version context without leaking credentials (AC: 2, 3) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
- [x] Testing coverage (AC: 1, 2, 3, 4) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write unit tests for storage helper verifying path prefixes per platform and error scenarios (AC: 2, 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add integration tests for endpoint covering auth, success, invalid platform, and upload errors (AC: 1, 2, 4) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-agent-record]

## Dev Notes
### Previous Story Insights
- Story 2.2 established folder upload flow for books; reuse storage helper patterns and JWT auth dependency while adapting path logic for app builds. [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-agent-record]
- Story 2.1 provided MinIO client and bucket bootstrap utilities; ensure they are reused for `apps` bucket interactions. [Source: docs/stories/2.1.minio-service-connection-bucket-setup.md#dev-agent-record]

### Data Models
- Application builds may not have dedicated metadata yet; rely on platform parameter and optional version identifier for organizing storage paths. [Source: architecture/5-api-specification.md#5-api-specification]

### API Specifications
- Follow REST conventions under `/apps/{platform}` namespace and return manifest data for client verification. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Storage operations focus on MinIO integration; keep upload logic inside backend service layer and avoid exposing raw MinIO operations to controllers. [Source: architecture/6-components.md#storage]

### File Locations
- Service helpers should live under `apps/api/app/services`; new router logic belongs under an appropriate module (e.g., `apps/api/app/routers/apps.py`). [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Use Pytest with mocks for MinIO client interactions and FastAPI TestClient for endpoint behaviour. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Maintain streaming uploads to avoid loading large archives entirely into memory; ensure MinIO SDK usage is consistent with prior stories. [Source: architecture/3-tech-stack.md#3-tech-stack]

### Project Structure Notes
- Consider versioning patterns (e.g., `platform/version/`) for long-term maintainability and to support multiple builds per platform. [Source: architecture/8-core-workflows.md#8-core-workflows]

### Testing
- Integrate new tests with existing `pytest` targets to keep CI coverage comprehensive. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | Application build upload endpoint implemented; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Story verified and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from `apps/api/`, 35 tests passed)

### Completion Notes List
- Reused storage helper to support app build archives, generating manifests under `platform/version/` prefixes.
- Added `/apps/{platform}/upload` FastAPI router with JWT enforcement and error handling for invalid platforms and upload failures.
- Implemented unit tests for storage helper and endpoint tests covering auth, success, unknown platform, and error flows.
- Ensured manifests include platform/version and all file paths for downstream validation.

### File List
- apps/api/app/main.py
- apps/api/app/routers/__init__.py
- apps/api/app/routers/apps.py
- apps/api/app/services/__init__.py
- apps/api/app/services/storage.py
- apps/api/tests/test_apps_upload.py
- docs/stories/2.3.application-build-folder-upload-endpoint.md

## QA Results
- Gate: PASS â€“ `/apps/{platform}/upload` enforces JWT auth, validates supported platforms, and streams archives into MinIO with manifests (`apps/api/app/routers/apps.py:1`, `apps/api/app/services/storage.py:1`).
- Evidence:
  - Storage helper reuses archive unpacking to write files under `platform/version/` prefixes and emits file path/size manifest (`apps/api/app/services/storage.py:51`).
  - Endpoint guards platform list, handles errors, and returns 201 with manifest payload (`apps/api/app/routers/apps.py:45`).
  - Pytest suite extends coverage with unit and integration tests; full run (35 tests) passed (`apps/api/tests/test_apps_upload.py:1`, `apps/api/tests/test_storage_service.py:1`).
- Residual Risks:
  - Platform list currently limited to macOS/windows; revisit once additional platforms emerge.
