# Story 5.11: Book Content Explorer Drawer

## Status
Done

## Story
**As an** administrator,
**I want** to open a book entry and inspect its folder structure and metadata,
**so that** I can confirm uploads, spot required files like `config.json`, and perform targeted actions without leaving the admin panel.

## Story Context
**Existing System Integration:**
- Integrates with: Books listing UI, storage listing endpoint `GET /storage/books/{publisher}/{book_name}`, file download endpoint, and auth guard. [Source: docs/architecture/5-api-specification.md#5-api-specification]
- Technology: React + Material UI admin panel, Zustand state store, FastAPI backend, MinIO storage. [Source: docs/architecture/3-tech-stack.md#3-tech-stack]
- Follows pattern: Story 3.3 dashboard listing and Story 5.1 flexible book upload interactions. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes; docs/stories/5.1.flexible-book-upload-targeting.md#dev-notes]
- Touch points: `apps/admin-panel/src/pages/Dashboard.tsx`, `apps/admin-panel/src/lib/storage.ts`, `apps/api/app/routers/storage.py`.

## Acceptance Criteria
1. Book rows expose a "View contents" action that opens a drawer or modal displaying book metadata (from `config.json`) and folder structure returned by `GET /storage/books/{publisher}/{book_name}`.
2. The drawer lists files and folders in a collapsible tree showing names, relative paths, and sizes; selecting a file surfaces contextual actions like download/copy path.
3. The UI fetches and surfaces parsed `config.json` metadata (publisher, title, language, version, status) alongside upload timestamps or unknown indicators when metadata keys are missing.
4. Download actions call the existing file endpoint and surface success/error feedback consistent with current admin panel toasts.
5. Automated tests cover listing fetch success/error, tree rendering, metadata load failure fallback, and download action wiring.

## Tasks / Subtasks
- [x] Extend admin dashboard to add a content explorer entry point and drawer layout (AC: 1) [Source: docs/prd/user-interface-design-goals.md#core-screens-and-views]
  - [x] Wire drawer to fetch storage listing and metadata concurrently with loading indicators and auth headers (AC: 1, 2) [Source: apps/api/app/routers/storage.py]
  - [x] Handle errors with inline alerts mirroring existing trash page conventions (AC: 2) [Source: docs/stories/4.2.restore-functionality-from-trash.md#dev-notes]
- [x] Build tree component for book contents supporting collapse/expand, file size formatting, and action buttons (AC: 2) [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]
  - [x] Connect download action to file endpoint, ensuring bearer token propagation and toast messaging (AC: 2, 4) [Source: docs/prd/requirements.md#functional]
- [x] Parse `config.json` via existing download route and render key fields with graceful fallbacks when keys are absent (AC: 3) [Source: docs/stories/5.8.config-json-book-upload-metadata.md#acceptance-criteria]
- [x] Update storage lib to expose helper for listing + config fetch; add unit coverage for request contracts (AC: 1-4) [Source: apps/admin-panel/src/lib/storage.ts]
- [x] Add Vitest + React Testing Library coverage for drawer interactions, error states, and download invocation (AC: 5) [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- [ ] Document usage in admin handbook/operator guide (AC: 3) [Source: docs/operations/minio-backup-runbook.md]

## Dev Notes
### Previous Story Insights
- Dashboard listing (Story 3.3) already has selection patterns and toasts; reuse its infrastructure for success/error feedback. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]
- Story 5.1 introduced contexts for new vs update uploads; the explorer should recognize both newly created books and existing ones. [Source: docs/stories/5.1.flexible-book-upload-targeting.md#dev-notes]

### Data Models
- `config.json` supplies canonical metadata fields (`publisher`, `book_name`, `language`, `category`, optional `version`, `status`). Ensure parser maps FlowBook synonyms per Story 5.8. [Source: docs/stories/5.8.config-json-book-upload-metadata.md#acceptance-criteria]

### API Specifications
- Storage listing endpoint returns hierarchical nodes with `path`, `type`, `size`, `children`; leverage as-is to render tree. [Source: apps/api/app/routers/storage.py]
- File download endpoints require JWT bearer token; maintain consistent headers. [Source: docs/prd/requirements.md#functional]

### Component Specifications
- Drawer/modal should align with admin panel design guidance (modals and contextual panels). [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
- Reuse existing typography, spacing, and light turquoise palette tokens introduced in Story 5.7. [Source: docs/stories/5.7.refresh-admin-ui-light-turquoise.md#dev-notes]

### File Locations
- Frontend: `apps/admin-panel/src/pages/Dashboard.tsx` or new dedicated component under `apps/admin-panel/src/features/books`. Shared tree component in `apps/admin-panel/src/components`. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]
- Client helpers: `apps/admin-panel/src/lib/storage.ts` for listing/download wrappers. Backend: No code changes expected.

### Testing Requirements
- Frontend tests in `apps/admin-panel/src/__tests__/dashboard.test.tsx` or a new suite covering explorer flows. [Source: docs/architecture/16-testing-strategy.md#16-testing-strategy]
- API behaviours already covered by prior stories; rely on integration tests for listing endpoints. [Source: docs/stories/2.4.list-contents-of-buckets-folders.md#testing]

### Technical Constraints
- Avoid triggering excessive MinIO calls; debounce or collapse repeated fetches by caching results while drawer stays open. [Source: docs/architecture/11-backend-architecture.md#11-backend-architecture]
- Ensure large folders render efficiently (virtualize if necessary) though initial scope can focus on current dataset sizes. [Source: docs/prd/requirements.md#non-functional]

### Project Structure Notes
- New components should follow existing module boundaries to keep admin panel maintainable. [Source: docs/architecture/12-unified-project-structure.md#12-unified-project-structure]

### Risk and Compatibility Check
- Primary Risk: Large tree responses impacting performance; mitigate with lazy loading per folder.
- Mitigation: Implement progressive expansion (fetch-on-open) if needed; provide loading indicators.
- Rollback: Disable explorer entry point and revert drawer components.

### Validation Checklist
- [ ] Explorer action visible only for authenticated admins.
- [ ] Drawer displays metadata even if some keys missing.
- [ ] Tree interactions respect keyboard accessibility.
- [ ] Downloads reuse shared API client and surface status toasts.

## Testing
- Frontend: Vitest + RTL for drawer open/close, listing success/error, metadata render, download action.
- Manual: Connect to staging, open explorer for multiple books, verify tree accuracy and metadata parsing.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-06 | 0.1 | Initial draft outlining book content explorer feature. | John (Product Manager) |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- None

### Completion Notes List
- Added dedicated Vitest + RTL suite covering explorer happy path, error handling, and download action feedback.
- Deferred project test runner (`npx turbo run test --filter=admin-panel`) per user instruction.

### File List
- apps/admin-panel/src/__tests__/bookExplorerDrawer.test.tsx

## QA Results
- 
