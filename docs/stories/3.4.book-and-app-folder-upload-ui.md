# Story 3.4: Book and App Folder Upload UI

## Status
Done

## Story
**As an** administrator,
**I want** a user interface to upload new book and app build folders,
**so that** I can add content to the system without using an API client.

## Acceptance Criteria
1. A prominent "Upload" button is present on the dashboard.
2. Clicking the button opens a modal or new page that allows the user to select a folder from their local machine.
3. The interface provides clear instructions on what to upload (e.g., "Select a Book Data Folder").
4. Once a folder is selected, the UI calls the correct API endpoint (e.g., `POST /books/{book_id}/upload`).
5. The UI displays the upload progress and provides clear success or error feedback to the user upon completion.

## Tasks / Subtasks
- [x] Add upload entry points within the dashboard layout (AC: 1) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
  - [x] Introduce an "Upload" call-to-action in the dashboard header that respects the existing protected routing shell (AC: 1) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#tasks--subtasks]
  - [x] Ensure the button is keyboard-accessible and visible only to authenticated users (`ProtectedRoute` scope) (AC: 1) [Source: docs/stories/3.2.admin-login-page-authentication.md#tasks--subtasks]
- [x] Implement upload modal flow with contextual instructions (AC: 2, 3) [Source: docs/prd/user-interface-design-goals.md#key-interaction-paradigms]
  - [x] Build a Material UI modal that lets admins choose between book and app uploads and surfaces guidance text for each asset type (AC: 2, 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Provide controls for selecting a zipped archive via standard browser file inputs, including helper text detailing expected structure (AC: 2, 3) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#tasks--subtasks]
- [x] Integrate book upload workflow with backend endpoints (AC: 4, 5) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#acceptance-criteria]
  - [x] Allow admins to choose a target book (reuse dashboard metadata) and send the selection alongside the folder using the shared API client (AC: 4) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]
  - [x] Display progress, success, and error states based on the `POST /books/{book_id}/upload` response manifest and failures (AC: 5) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#qa-results]
- [x] Integrate app build upload workflow (AC: 4, 5) [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#acceptance-criteria]
  - [x] Support selecting a platform/build version and post the archive to `POST /apps/{platform}/upload`, reusing normalized auth headers (AC: 4) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-notes]
  - [x] Surface upload progress with platform-aware messaging and handle error responses from the storage service gracefully (AC: 5) [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#qa-results]
- [x] Harden state management and API helpers for uploads (AC: 4, 5) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Extend the admin-panel API helper module with functions for multipart upload requests that include bearer tokens from the Zustand store (AC: 4) [Source: docs/stories/3.1.react-app-initialization-layout.md#dev-notes]
  - [x] Ensure requests reset modal state on completion and clean up selected files to prevent accidental re-submission (AC: 5) [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- [x] Testing and validation (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add Vitest + React Testing Library coverage that exercises modal visibility, instruction text, happy-path book/app uploads, and error messaging (AC: 1, 2, 3, 4, 5) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#testing]
  - [x] Execute admin-panel lint, unit tests, and production build to confirm regression-free uploads feature (AC: 1, 2, 3, 4, 5) [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-agent-record]

## Dev Notes
### Previous Story Insights
- Story 3.3 delivered the dashboard tables, shared auth headers, and highlighted that supported platform lists are currently hard-coded—consider a central source when wiring app upload options. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#qa-results]
- Story 3.2 already provisions the in-memory auth store and ProtectedRoute guard; reuse those when determining token availability before showing upload flows. [Source: docs/stories/3.2.admin-login-page-authentication.md#dev-notes]

### Data Models
- Book records provide `id`, `publisher`, `book_name`, `language`, and `category`, which can populate selection controls for book uploads. [Source: architecture/4-data-models.md#book]
- No specific data model guidance exists for frontend app build metadata beyond platform/version paths returned by the storage listings; ensure the UI captures platform identifiers expected by the upload API. [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#dev-notes]

### API Specifications
- Book folder uploads must target the authenticated `POST /books/{book_id}/upload` endpoint that streams archives to MinIO and returns a manifest. [Source: docs/stories/2.2.book-folder-upload-endpoint.md#qa-results]
- App build uploads utilize `POST /apps/{platform}/upload`, which enforces platform validation and returns manifest details for the stored build. [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#qa-results]

### Component Specifications
- Follow the frontend architecture guidance for organizing modal components, hooks, and services inside the admin panel application. [Source: architecture/10-frontend-architecture.md#10-frontend-architecture]
- Material UI remains the sanctioned component library for dialog, form, and progress primitives. [Source: architecture/3-tech-stack.md#3-tech-stack]

### File Locations
- Place modal and related UI under `apps/admin-panel/src/components` (or `src/features/uploads` if introduced), with hooks/services in `src/lib` to align with the unified project structure. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Implement Vitest + React Testing Library coverage for the upload UI, ensuring mocks capture multipart requests and state transitions. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Continue using React 18, TypeScript, React Router, Zustand, and Material UI as defined in the tech stack; keep JWT handling in memory and avoid persisting tokens during uploads. [Source: architecture/3-tech-stack.md#3-tech-stack]
- Handle upload errors defensively, surfacing sanitized feedback while avoiding leakage of backend details. [Source: architecture/15-security-and-performance.md#15-security-and-performance]

### Project Structure Notes
- Confirm new modules integrate with the existing dashboard entry point without breaking current tables, and consider centralizing platform options to prepare for future backend-driven lists. [Source: docs/qa/gates/3.3-dashboard-for-listing-books-apps.yml:37]

## Testing
- Add Vitest + RTL suites under `apps/admin-panel/src/__tests__` to verify modal interactions, upload helper invocation, progress display, and error handling. [Source: architecture/16-testing-strategy.md#16-testing-strategy]
- Run `npm run lint`, `npm run test -- --run`, and `npm run build` within the admin panel workspace to validate the feature end-to-end. [Source: docs/stories/3.3.dashboard-for-listing-books-apps.md#dev-agent-record]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-29 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-29 | 0.2 | Removed persisted auth tokens and added regression coverage per QA findings. | James (Dev) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex
### Debug Log References
- `npm run lint` (initial validation and QA fix verification)
- `npm run test -- --run` (initial validation and QA fix verification)
- `npm run build`

### Completion Notes List
- Added an upload dialog that guides admins through book versus application archives with helper text and sanitized feedback.
- Wired dashboard upload controls to refresh listings after success, reuse auth headers, highlight revalidation with a status alert, and group application builds by root folder so only high-level artifacts appear.
- Ensured admin auth tokens stay memory-only while logout clears state to preserve security posture.
- Expanded Vitest coverage to cover instructions, happy-path uploads, sanitized error handling, and the no-persistence auth requirement with a regression test.

### File List
- apps/admin-panel/src/components/UploadDialog.tsx
- apps/admin-panel/src/pages/Dashboard.tsx
- apps/admin-panel/src/__tests__/dashboard.test.tsx
- apps/admin-panel/src/__tests__/auth.test.tsx
- apps/admin-panel/src/lib/platforms.ts
- apps/admin-panel/src/stores/auth.ts

## QA Results
- Gate: FAIL – Auth store persists bearer tokens to `localStorage`, violating the "in memory" constraint (`apps/admin-panel/src/stores/auth.ts:49`).
- Evidence:
  - Login flow writes the JWT to storage and only removes it on logout, so credentials survive refresh.
- Residual Risks:
  - Persisted tokens lengthen the attack window until reverted or formally accepted.

### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Zustand store now holds credentials exclusively in component state; all localStorage helpers were removed so refreshes no longer extend the session lifetime (`apps/admin-panel/src/stores/auth.ts:5-78`).
- Login success path continues to normalize credentials and drive authenticated API calls without leaking tokens beyond process memory (`apps/admin-panel/src/stores/auth.ts:41-59`).

### Requirements Traceability
- **AC1** – Redirect remains guarded by the ProtectedRoute and unauthenticated users never reach the dashboard view (`apps/admin-panel/src/__tests__/dashboard.test.tsx:35-52`).
- **AC2 & AC4** – Authenticated dashboard requests still attach bearer headers sourced from the in-memory store during upload preparation (`apps/admin-panel/src/__tests__/dashboard.test.tsx:95-137`).
- **AC3** – Upload instructions and contextual messaging stay intact through modal coverage exercised in dashboard suites (`apps/admin-panel/src/__tests__/dashboard.test.tsx:175-222`).
- **AC5** – Progress and error handling flows remain observable through RTL assertions of feedback states (`apps/admin-panel/src/__tests__/dashboard.test.tsx:224-276`).
- **Security Requirement** – Regression test confirms the login sequence keeps `localStorage` empty, satisfying the in-memory mandate (`apps/admin-panel/src/__tests__/auth.test.tsx:78-100`).

### Test Architecture Assessment
- Added auth regression test relies on spies rather than implementation details, keeping the security contract explicit while remaining resilient to future store refactors (`apps/admin-panel/src/__tests__/auth.test.tsx:78-100`).
- Existing dashboard coverage still resets the store per test to avoid cross-test leakage, validating both guard rails and upload UI flows (`apps/admin-panel/src/__tests__/dashboard.test.tsx:19-35`).

### NFR Validation
- **Security:** PASS – Credentials never persist beyond runtime memory; logout and failed authentication reset state to a clean baseline (`apps/admin-panel/src/stores/auth.ts:60-74`).
- **Performance:** PASS – Store mutations remain constant-time and removal of storage serialization trims synchronous work during login (`apps/admin-panel/src/stores/auth.ts:41-59`).
- **Reliability:** PASS – Error handling still funnels through `deriveErrorMessage`, ensuring predictable operator feedback without residual tokens (`apps/admin-panel/src/stores/auth.ts:15-25`).
- **Maintainability:** PASS – Store surface is simpler without persistence helpers, and tests document the non-persistence contract for future contributors (`apps/admin-panel/src/__tests__/auth.test.tsx:78-100`).

### Testability Evaluation
- Controllability: Reset helpers keep store state deterministic across suites while the new regression test constrains the storage contract (`apps/admin-panel/src/__tests__/auth.test.tsx:27-41`).
- Observability: LocalStorage spy assertions and role-based UI queries expose behavior clearly without needing internal access (`apps/admin-panel/src/__tests__/auth.test.tsx:78-100`).
- Debuggability: Removal of persistence reduces hidden state sources, making authentication failures easier to trace (`apps/admin-panel/src/stores/auth.ts:5-78`).

### Risk Summary
- Residual Risk: Low – Sessions end on refresh by design; document this expectation for admins so the shorter lifetime is anticipated.

### Gate Decision Recommendation
- Gate **PASS** – Story is ready for Done once stakeholders acknowledge the intended non-persistent session behavior.
