# Story 7.1: Add Teachers Navigation and Page

## Status

Done

## Story

**As an** administrator,
**I want** a Teachers section in the admin panel,
**so that** I can view and manage teacher-uploaded materials.

## Acceptance Criteria

1. NavBar displays "Teachers" link with SchoolIcon below "Applications".
2. Route `/teachers` is registered in App.tsx and protected by authentication.
3. Teachers page displays a table of teacher materials with columns: Teacher ID, Filename, File Type, Size, Upload Date.
4. Teachers page includes search/filter functionality by teacher ID.
5. Teachers page has "Upload Material" button (dialog implemented in Story 7.2).
6. Delete action soft-deletes material to trash via `DELETE /teachers/{teacher_id}/materials/{path}` endpoint.
7. Page follows existing Books.tsx patterns for consistency.

## Tasks / Subtasks

- [x] **Task 1: Create teachers.ts API Module (AC: 3, 6)**
  - [x] Create `apps/admin-panel/src/lib/teachers.ts`
  - [x] Define `TeacherMaterial` interface:
    ```typescript
    interface TeacherMaterial {
      teacher_id: string;
      path: string;
      name: string;
      size: number;
      content_type: string;
      last_modified?: string;
    }
    ```
  - [x] Implement `fetchTeacherMaterials(teacherId: string, token: string, tokenType: string)` function
  - [x] Implement `deleteTeacherMaterial(teacherId: string, path: string, token: string, tokenType: string)` function
  - [x] Implement `listAllTeachers(token: string, tokenType: string)` function to get unique teacher IDs
  - [x] Follow patterns from `lib/books.ts` for API calls and error handling

- [x] **Task 2: Create Teachers Page Component (AC: 3, 4, 5, 7)**
  - [x] Create `apps/admin-panel/src/pages/Teachers.tsx`
  - [x] Import MUI components following Books.tsx pattern:
    - Table, TableContainer, TableHead, TableBody, TableRow, TableCell
    - TextField, Select, FormControl, InputLabel, MenuItem
    - Button, IconButton, Tooltip, Alert, CircularProgress
  - [x] Implement state management:
    ```typescript
    const [materials, setMaterials] = useState<TeacherMaterial[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    const [searchQuery, setSearchQuery] = useState('');
    const [teacherFilter, setTeacherFilter] = useState('');
    const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
    const [deleteTarget, setDeleteTarget] = useState<TeacherMaterial | null>(null);
    ```
  - [x] Implement `loadMaterials()` function to fetch all teacher materials
  - [x] Implement filtering by teacher ID and search query
  - [x] Implement delete confirmation dialog
  - [x] Add "Upload Material" button in page header (dialog in Story 7.2)

- [x] **Task 3: Implement Materials Table (AC: 3)**
  - [x] Create table with columns: Teacher ID, Filename, Type, Size, Actions
  - [x] Add sortable column headers (following Books.tsx pattern)
  - [x] Format file sizes using existing `formatBytes` helper
  - [x] Display MIME type as readable chip (e.g., "PDF", "MP3", "PNG")
  - [x] Add View/Delete action buttons per row

- [x] **Task 4: Implement Search and Filter (AC: 4)**
  - [x] Add search TextField with SearchIcon
  - [x] Add Teacher ID dropdown filter (populated from unique teacher IDs)
  - [x] Add "Clear Filters" button when filters active
  - [x] Show filter status: "Showing X of Y materials"

- [x] **Task 5: Implement Delete Functionality (AC: 6)**
  - [x] Create delete confirmation Dialog
  - [x] Call `deleteTeacherMaterial()` on confirm
  - [x] Refresh materials list after successful delete
  - [x] Show error Alert on failure

- [x] **Task 6: Add Teachers Route (AC: 2)**
  - [x] Import TeachersPage in `App.tsx`
  - [x] Add route inside ProtectedRoute:
    ```tsx
    <Route path="teachers" element={<TeachersPage />} />
    ```

- [x] **Task 7: Add Teachers NavLink (AC: 1)**
  - [x] Import SchoolIcon from `@mui/icons-material/School`
  - [x] Add NavLink in `NavBar.tsx` below Applications:
    ```tsx
    <li>
      <NavLink to="/teachers" className={({ isActive }) => (isActive ? 'active' : '')}>
        <SchoolIcon fontSize="small" />
        <span>Teachers</span>
      </NavLink>
    </li>
    ```

- [x] **Task 8: Verify Existing Functionality (AC: 7)**
  - [x] Verify Books page still works correctly
  - [x] Verify Applications page still works correctly
  - [x] Verify Trash page still works correctly
  - [x] Test navigation between all pages

## Dev Notes

### API Endpoints (from Epic 6.4)
[Source: apps/api/app/routers/teachers.py]

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/teachers/{teacher_id}/materials` | GET | List teacher's materials |
| `/teachers/{teacher_id}/materials/{path}` | GET | Download material |
| `/teachers/{teacher_id}/materials/{path}` | DELETE | Soft-delete to trash |

### Existing Patterns to Follow
[Source: apps/admin-panel/src/pages/Books.tsx]

**State Management:**
```typescript
const token = useAuthStore((state) => state.token);
const tokenType = useAuthStore((state) => state.tokenType);
```

**Table Structure:**
```tsx
<TableContainer component={Paper}>
  <Table>
    <TableHead>...</TableHead>
    <TableBody>...</TableBody>
  </Table>
</TableContainer>
```

**Filter Pattern:**
```tsx
<FormControl sx={{ minWidth: 200 }}>
  <InputLabel>Teacher</InputLabel>
  <Select value={teacherFilter} onChange={...}>
    <MenuItem value="">All Teachers</MenuItem>
    {teachers.map((t) => <MenuItem key={t} value={t}>{t}</MenuItem>)}
  </Select>
</FormControl>
```

### File Locations
[Source: apps/admin-panel/src structure]

| File | Action |
|------|--------|
| `src/lib/teachers.ts` | CREATE |
| `src/pages/Teachers.tsx` | CREATE |
| `src/App.tsx` | MODIFY (add route) |
| `src/components/NavBar.tsx` | MODIFY (add link) |

### API Response Structure
The `GET /teachers/{teacher_id}/materials` endpoint returns a tree structure:
```json
{
  "path": "teacher_123/materials/",
  "children": [
    {"name": "lesson.pdf", "size": 1024, "is_dir": false},
    {"name": "audio", "is_dir": true, "children": [...]}
  ]
}
```

Need to flatten this tree for table display.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2025-12-14 | 0.2 | Applied QA fixes: Upload Date column, authenticated download, parallel API calls | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation proceeded without blocking issues.

### Completion Notes List
- Added `GET /teachers/` endpoint to backend for listing all teacher IDs (required for frontend dropdown filter)
- Created frontend API module with tree-flattening logic for materials display
- Followed Books.tsx patterns for table, sorting, filtering, and delete confirmation
- Upload dialog placeholder included (full implementation in Story 7.2)
- Pre-existing test failures in storage.test.ts, trash.test.tsx unrelated to this story
- Teachers API tests: 19/19 passed

**QA Fixes Applied (2025-12-14):**
- Fix #1: Added Upload Date column to table (AC3 requirement) - displays `last_modified` with sortable header
- Fix #2: Implemented authenticated download - `downloadTeacherMaterial()` uses fetch+blob for auth token inclusion
- Fix #3: Optimized API calls - `fetchAllTeacherMaterials()` now uses Promise.allSettled for parallel requests

### File List
| File | Action |
|------|--------|
| `apps/api/app/routers/teachers.py` | MODIFIED (added list_all_teachers endpoint) |
| `apps/admin-panel/src/lib/teachers.ts` | CREATED |
| `apps/admin-panel/src/pages/Teachers.tsx` | CREATED |
| `apps/admin-panel/src/App.tsx` | MODIFIED (added route) |
| `apps/admin-panel/src/components/NavBar.tsx` | MODIFIED (added nav link) |

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation follows established patterns from Books.tsx with good consistency. The code is well-structured with appropriate separation of concerns between the API module (`teachers.ts`) and page component (`Teachers.tsx`). TypeScript types are properly defined, MUI components are used consistently, and error handling follows existing patterns.

**Strengths:**
- Clean tree-flattening logic in `teachers.ts` for handling nested API response
- Consistent state management pattern with Zustand auth store
- Good UX with empty states, loading indicators, and filter status display
- Backend endpoint added appropriately with proper auth guards

**Issues Found:**

### Compliance Check

- Coding Standards: ✓ Follows existing patterns
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ⚠ No frontend unit tests (consistent with existing pages)
- All ACs Met: ✗ See issues below

### Improvements Checklist

- [ ] **AC3 Gap - Missing Upload Date column**: Story AC3 specifies "Teacher ID, Filename, File Type, Size, Upload Date" but table only shows Teacher ID, Filename, Type, Size. The `last_modified` field exists in TeacherMaterial interface but is not rendered in table.
- [ ] **View button authentication issue**: `handleViewMaterial()` at line 162-165 opens URL in new tab via `window.open()`, but `/teachers/{id}/materials/{path}` endpoint requires Bearer auth. Browser won't include auth header, resulting in 401. Need to either:
  - Use authenticated fetch + blob URL (like AuthenticatedImage pattern)
  - Or implement presigned URL endpoint (like book cover)
- [ ] **Performance: Sequential API calls**: `fetchAllTeacherMaterials` at lines 100-118 fetches each teacher's materials sequentially in a for-loop. For many teachers, this will be slow. Consider `Promise.all()` for parallel fetching.

### Security Review

✓ All endpoints protected by `_require_admin()` authentication
✓ Input sanitization via `_sanitize_segment()` and `_normalize_relative_path()`
✓ Path traversal protection in backend
✓ Soft-delete preserves data in trash bucket

### Performance Considerations

⚠ **N+1 API calls pattern**: Current implementation makes 1 call to list teachers + N calls to fetch each teacher's materials. For 50 teachers, this means 51 API calls on page load. Consider:
- Backend endpoint to return all materials across teachers in single call
- Or frontend parallel fetching with Promise.all

### Files Modified During Review

None - review only, no refactoring performed.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/7.1-add-teachers-navigation-and-page.yml

### Recommended Status

**✗ Changes Required** - Address missing Upload Date column (AC3 gap) and View button auth issue before marking Done. Performance optimization can be deferred but should be tracked.
