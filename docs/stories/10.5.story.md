# Story 10.5: Module Segmentation Logic

## Status
Done

## Story
**As a** system developer,
**I want** a module segmentation service that segments extracted text into logical modules/units/chapters,
**so that** the AI processing pipeline can analyze content per module, extract topics and vocabulary in meaningful chunks, and provide structured data for the Dream LMS.

## Acceptance Criteria
1. Detect module boundaries from headers/titles
2. Use table of contents if available
3. AI-assisted segmentation for unclear structures
4. Manual module definition override (admin)
5. Handle books with no clear module structure
6. Map pages to modules

## Tasks / Subtasks

- [x] Task 1: Create segmentation service module structure (AC: 1-6)
  - [x] Create `apps/api/app/services/segmentation/__init__.py` module
  - [x] Create `apps/api/app/services/segmentation/models.py` with dataclasses
  - [x] Define `Module` dataclass: module_id, title, pages (list[int]), start_page, end_page, text, word_count
  - [x] Define `SegmentationResult` dataclass: book_id, publisher_id, book_name, modules (list[Module]), method, segmented_at
  - [x] Define `SegmentationMethod` enum: HEADER_BASED, TOC_BASED, AI_ASSISTED, MANUAL, SINGLE_MODULE
  - [x] Define exceptions: `SegmentationError`, `NoTextFoundError`, `InvalidModuleDefinitionError`

- [x] Task 2: Implement header-based segmentation strategy (AC: 1)
  - [x] Create `apps/api/app/services/segmentation/strategies/header.py`
  - [x] Implement `HeaderBasedStrategy` class
  - [x] Detect patterns: "Unit X", "Chapter X", "Module X", "Section X", "Part X" (case-insensitive)
  - [x] Support numbered patterns: "Unit 1", "Chapter One", "I.", "1.", etc.
  - [x] Detect Turkish patterns: "Unite X", "Bolum X" (for bilingual books)
  - [x] Return list of detected boundaries with page numbers and titles

- [x] Task 3: Implement TOC-based segmentation strategy (AC: 2)
  - [x] Create `apps/api/app/services/segmentation/strategies/toc.py`
  - [x] Implement `TOCBasedStrategy` class
  - [x] Detect "Table of Contents", "Contents", "Index" patterns on first 10 pages
  - [x] Parse TOC entries with page numbers
  - [x] Handle various TOC formats (dots, lines, page numbers on right)
  - [x] Return structured TOC data with title and page mappings

- [x] Task 4: Implement AI-assisted segmentation strategy (AC: 3)
  - [x] Create `apps/api/app/services/segmentation/strategies/ai.py`
  - [x] Implement `AIAssistedStrategy` class
  - [x] Use LLMService from Story 10.1 for AI analysis
  - [x] Create segmentation prompt template for LLM
  - [x] Send book text (or summary) to LLM to identify logical segments
  - [x] Parse LLM JSON response to extract module boundaries
  - [x] Handle LLM failures gracefully with fallback to single module

- [x] Task 5: Implement manual module definition support (AC: 4)
  - [x] Create `apps/api/app/services/segmentation/strategies/manual.py`
  - [x] Implement `ManualStrategy` class
  - [x] Accept manual module definitions from book config or API
  - [x] Validate page ranges don't overlap and cover all pages
  - [x] Support partial manual override (some modules manual, rest auto-detected)

- [x] Task 6: Implement fallback for books with no clear structure (AC: 5)
  - [x] Create `apps/api/app/services/segmentation/strategies/fallback.py`
  - [x] Implement `SingleModuleStrategy` class
  - [x] Treat entire book as single module if no boundaries detected
  - [x] Option to split by page count (e.g., 20 pages per module) as fallback

- [x] Task 7: Create unified segmentation service (AC: 1-6)
  - [x] Create `apps/api/app/services/segmentation/service.py`
  - [x] Implement `SegmentationService` class
  - [x] Implement `segment_book()` - main entry point, coordinates strategies
  - [x] Load extracted text from ai-data/text/ (using AIDataStorage from Story 10.4)
  - [x] Strategy selection order: Manual (if provided) -> TOC -> Header -> AI -> Fallback
  - [x] Implement `get_segmentation_service()` singleton factory
  - [x] Progress reporting callback for queue integration

- [x] Task 8: Implement module storage (AC: 6)
  - [x] Extend `AIDataStorage` in `apps/api/app/services/pdf/storage.py` or create new storage class
  - [x] Implement `save_modules()` - save module_N.json files to ai-data/modules/
  - [x] Implement `save_segmentation_metadata()` - save segmentation info
  - [x] Implement `get_module()` and `list_modules()` for retrieval
  - [x] Storage path: `/{publisher_id}/books/{book_id}/{book_name}/ai-data/modules/`

- [x] Task 9: Add segmentation configuration settings (AC: 3, 4)
  - [x] Add settings to `apps/api/app/core/config.py`
  - [x] Add `DCS_SEGMENTATION_MIN_MODULE_PAGES` (default: 3)
  - [x] Add `DCS_SEGMENTATION_MAX_MODULES` (default: 50)
  - [x] Add `DCS_SEGMENTATION_AI_ENABLED` (default: true)
  - [x] Add `DCS_SEGMENTATION_DEFAULT_STRATEGY` (default: "auto")

- [x] Task 10: Write unit tests (AC: 1-6)
  - [x] Create `apps/api/tests/test_segmentation.py`
  - [x] Test header pattern detection with various formats
  - [x] Test TOC parsing with different TOC styles
  - [x] Test AI-assisted segmentation with mocked LLM
  - [x] Test manual module definition validation
  - [x] Test fallback to single module
  - [x] Test page-to-module mapping accuracy
  - [x] Test module storage and retrieval
  - [x] Test strategy selection order

- [x] Task 11: Integration with queue system (AC: 1-6)
  - [x] Update `apps/api/app/services/queue/tasks.py`
  - [x] Implement `_run_segmentation()` function for segmentation stage
  - [x] Receive text extraction result from previous stage
  - [x] Pass segmentation result to next stage (topic_analysis)
  - [x] Wire progress reporting from segmentation to queue progress

## Dev Notes

### Previous Story Insights (Story 10.4)
- **Pattern Used:** Module structure follows `services/{module}/` pattern with `models.py`, `service.py`, `__init__.py`
- **Singleton Pattern:** `get_extraction_service()` factory function for global instance
- **Exception Hierarchy:** Specific exceptions inherit from base error class with book_id context
- **Async Patterns:** Using async/await throughout services
- **Storage:** `AIDataStorage` class handles MinIO operations for ai-data structure
- **Queue Integration:** Add stage implementation in `_run_processing_stage()` function in tasks.py
- **Progress Callback:** Sync callback that tracks progress, final async report

[Source: Story 10.4 Dev Agent Record]

### Data Models (from Epic 10)
Module JSON structure for `ai-data/modules/module_N.json`:
```json
{
  "module_id": 1,
  "title": "Unit 1: Greetings",
  "pages": [1, 2, 3, 4, 5],
  "text": "Full text content of the module...",
  "topics": [],  // Populated by Story 10.6
  "vocabulary_ids": [],  // Populated by Story 10.7
  "language": "en",
  "difficulty": "A1",  // Populated by Story 10.6
  "word_count": 450,
  "extracted_at": "2024-01-15T10:30:00Z"
}
```

[Source: docs/prd/epic-10-ai-book-processing-pipeline.md#data-schemas]

### Storage Structure
```
/publishers/{publisher_id}/books/{book_id}/{book_name}/
└── ai-data/
    ├── text/                    # From Story 10.4
    │   ├── page_001.txt
    │   └── extraction_metadata.json
    └── modules/                 # NEW in this story
        ├── module_1.json
        ├── module_2.json
        └── segmentation_metadata.json
```

[Source: docs/prd/epic-10-ai-book-processing-pipeline.md#storage-structure]

### Segmentation Strategies (from Epic 10)
1. **Header-based:** Detect "Unit X", "Chapter X", "Module X" patterns
2. **TOC-based:** Parse table of contents for structure
3. **AI-assisted:** Ask LLM to identify logical segments
4. **Page-range:** Manual definition by admin

[Source: docs/prd/epic-10-ai-book-processing-pipeline.md#story-105]

### Header Detection Patterns
Regex patterns to detect module boundaries:
```python
HEADER_PATTERNS = [
    r'^(Unit|Chapter|Module|Section|Part|Lesson)\s*\d+',  # Unit 1, Chapter 2
    r'^(Unit|Chapter|Module|Section|Part|Lesson)\s+(One|Two|Three|...)',  # Unit One
    r'^\d+\.\s+\w+',  # 1. Introduction
    r'^[IVXLCDM]+\.\s+\w+',  # I. Introduction (Roman numerals)
    r'^(Unite|Bolum|Konu)\s*\d+',  # Turkish patterns
]
```

### AI Segmentation Prompt Template
```python
SEGMENTATION_PROMPT = """Analyze this book text and identify logical module/chapter boundaries.

Instructions:
- Identify distinct units, chapters, or modules in the content
- Return the title and starting page number for each module
- If no clear structure exists, suggest logical divisions by topic
- Return as JSON array

Text excerpt (first portion of book):
{text_excerpt}

Return JSON format:
[
  {"title": "Module title", "start_page": 1},
  {"title": "Next module", "start_page": 15},
  ...
]
"""
```

### Queue Stage Integration
The segmentation stage has 15% weight in the processing pipeline.
```python
PROCESSING_STAGES = {
    "text_extraction": 20,  # Story 10.4 ✓
    "segmentation": 15,     # THIS STORY
    "topic_analysis": 20,
    "vocabulary": 20,
    "audio_generation": 25,
}
```

[Source: apps/api/app/services/queue/models.py:74-80]

### Existing Dependencies
- `LLMService` from Story 10.1 (for AI-assisted segmentation)
- `AIDataStorage` from Story 10.4 (for loading extracted text)
- `QueueService` from Story 10.3 (for job integration)
- MinIO service for storage operations

[Source: apps/api/app/services/llm/, pdf/, queue/]

### Project File Structure
New files to create:
```
apps/api/app/services/segmentation/
├── __init__.py              # Module exports
├── models.py                # Module, SegmentationResult, exceptions
├── service.py               # SegmentationService
└── strategies/
    ├── __init__.py
    ├── base.py              # SegmentationStrategy ABC
    ├── header.py            # HeaderBasedStrategy
    ├── toc.py               # TOCBasedStrategy
    ├── ai.py                # AIAssistedStrategy
    ├── manual.py            # ManualStrategy
    └── fallback.py          # SingleModuleStrategy
```

[Source: Pattern from apps/api/app/services/pdf/, llm/]

## Testing

### Test Location
`apps/api/tests/test_segmentation.py`

### Testing Standards
- Use pytest with async support (`pytest-asyncio`)
- Mock MinIO storage operations
- Mock LLMService calls for AI segmentation tests
- Use sample text fixtures for various book structures
- Follow patterns from `apps/api/tests/test_pdf_extraction.py`

[Source: docs/architecture/16-testing-strategy.md]

### Test Cases to Cover
1. Header detection with "Unit 1", "Chapter 1", etc.
2. Roman numeral detection (I, II, III, IV)
3. TOC parsing with page numbers
4. AI segmentation with mocked LLM response
5. Manual module definition validation
6. Page range overlap detection
7. Fallback to single module when no structure detected
8. Module storage to MinIO
9. Text loading from ai-data/text/
10. Strategy selection priority
11. Edge case: Empty text
12. Edge case: Single-page book

## Dependencies

### Python Packages
No new packages required - uses existing:
- `pymupdf` (for text access if needed)
- `httpx` (for LLM service)
- `minio` (for storage)

### Existing Services Used
- `LLMService` from Story 10.1
- `AIDataStorage` from Story 10.4
- `QueueService` from Story 10.3

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-30 | 0.1 | Initial story draft | Bob (SM Agent) |
| 2024-12-30 | 1.0 | Implementation complete | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - All tests passed on first run, no debugging required.

### Completion Notes List
- Implemented 5 segmentation strategies: Header-based, TOC-based, AI-assisted, Manual, and Fallback (SingleModule + PageSplit)
- HeaderBasedStrategy supports: Unit/Chapter/Module/Section/Part/Lesson patterns, Roman numerals (I-XX), Turkish patterns (Unite/Bolum/Konu)
- TOCBasedStrategy parses table of contents with dot leaders, dashes, or space alignment
- AIAssistedStrategy integrates with LLMService from Story 10.1 for intelligent boundary detection
- ManualStrategy validates page ranges for overlap and coverage
- SegmentationService coordinates strategies in priority order: Manual → TOC → Header → AI → Fallback
- ModuleStorage saves module JSON files to MinIO at `ai-data/modules/module_N.json`
- Added 4 configuration settings to config.py with DCS_ prefix
- Queue integration via `_run_segmentation()` function in tasks.py
- 49 unit tests covering all components - all passing
- 391 total tests passing (pre-existing failures unrelated to this story)

### File List
**Created Files:**
- `apps/api/app/services/segmentation/__init__.py` - Module exports
- `apps/api/app/services/segmentation/models.py` - Data models and exceptions
- `apps/api/app/services/segmentation/service.py` - SegmentationService class
- `apps/api/app/services/segmentation/storage.py` - ModuleStorage class
- `apps/api/app/services/segmentation/strategies/__init__.py` - Strategy exports
- `apps/api/app/services/segmentation/strategies/base.py` - SegmentationStrategy ABC
- `apps/api/app/services/segmentation/strategies/header.py` - HeaderBasedStrategy
- `apps/api/app/services/segmentation/strategies/toc.py` - TOCBasedStrategy
- `apps/api/app/services/segmentation/strategies/ai.py` - AIAssistedStrategy
- `apps/api/app/services/segmentation/strategies/manual.py` - ManualStrategy
- `apps/api/app/services/segmentation/strategies/fallback.py` - SingleModuleStrategy, PageSplitStrategy
- `apps/api/tests/test_segmentation.py` - 49 unit tests

**Modified Files:**
- `apps/api/app/core/config.py` - Added 4 segmentation settings (lines 94-98)
- `apps/api/app/services/queue/tasks.py` - Added segmentation imports and `_run_segmentation()` function

## QA Results

### Review Date: 2024-12-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation following established patterns. The Strategy pattern is well-applied for segmentation approaches, providing clean extensibility. All files follow the project's module structure conventions with proper singleton factories, exception hierarchies, and async patterns. Code is well-documented with clear docstrings.

**Strengths:**
- Clean Strategy pattern implementation with 5 strategies + base ABC
- Proper use of dataclasses for immutable data models
- Comprehensive exception hierarchy with context-aware error messages
- Good separation of concerns (service, storage, strategies)
- Graceful fallback chain when primary strategies fail

### Refactoring Performed

- **File**: `tests/test_segmentation.py`
  - **Change**: Removed unused imports (datetime, timezone, BytesIO, ModuleBoundary)
  - **Why**: Linting compliance - imports were declared but never used
  - **How**: Simplified imports section to only include what's used

- **File**: `app/services/segmentation/service.py` (previously fixed by dev)
  - **Change**: Removed unused imports (Any, SegmentationError, BytesIO)
  - **Why**: Linting compliance
  - **How**: Cleaned up TYPE_CHECKING block and function-level imports

- **File**: `app/services/segmentation/strategies/ai.py` (previously fixed by dev)
  - **Change**: Removed unused `Any` import
  - **Why**: Linting compliance
  - **How**: Simplified TYPE_CHECKING import block

### Compliance Check

- Coding Standards: ✓ All linting passes, proper async patterns
- Project Structure: ✓ Follows `services/{module}/` pattern with strategies subdirectory
- Testing Strategy: ✓ 49 unit tests, proper mocking, async test markers
- All ACs Met: ✓ All 6 acceptance criteria have test coverage

### Requirements Traceability (AC → Tests)

| AC | Requirement | Test Coverage |
|----|-------------|---------------|
| AC1 | Header/title boundary detection | 7 tests (HeaderBasedStrategy class) |
| AC2 | TOC-based segmentation | 4 tests (TOCBasedStrategy class) |
| AC3 | AI-assisted segmentation | 3 tests (AIAssistedStrategy class) |
| AC4 | Manual module override | 8 tests (ManualModuleDefinition + ManualStrategy) |
| AC5 | Handle no clear structure | 4 tests (SingleModule + PageSplit + service fallback) |
| AC6 | Map pages to modules | 5 tests (Module, Storage, text aggregation) |

### Improvements Checklist

- [x] Fixed unused imports in test file
- [x] Verified all 49 tests pass
- [x] Linting passes for all files
- [x] Strategy selection order validated (Manual → TOC → Header → AI → Fallback)
- [x] Edge cases covered (empty pages, single page, no structure)

### Security Review

No security concerns identified. The service:
- Validates manual module definitions for page range validity
- Does not expose any external endpoints directly
- Properly handles LLM failures without exposing internal errors
- Input validation prevents page range overlaps and invalid configurations

### Performance Considerations

- Confidence thresholds prevent over-processing of marginal matches
- Text excerpts limited to 500 chars/page for AI analysis (max_text_length: 8000)
- Strategy chain exits early when successful match found
- Module limits enforced (max_modules: 50 default)

### Files Modified During Review

- `apps/api/tests/test_segmentation.py` - Fixed unused imports

### Gate Status

Gate: PASS → docs/qa/gates/10.5-module-segmentation.yml
Risk profile: N/A (low-risk story)
NFR assessment: Inline above

### Recommended Status

✓ Ready for Done - All acceptance criteria met with comprehensive test coverage. No blocking issues found.
