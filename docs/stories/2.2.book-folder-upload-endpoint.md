# Story 2.2: Book Folder Upload Endpoint

## Status
Done

## Story
**As an** administrator,
**I want** an API endpoint that can upload an entire book folder,
**so that** I can add new book datasets to the system.

## Acceptance Criteria
1. A new endpoint (e.g., `POST /books/{book_id}/upload`) is created to handle folder uploads.
2. The endpoint accepts a folder structure and recursively uploads all files and sub-folders to the `books` bucket in MinIO.
3. Files are stored under a path corresponding to their publisher and book name (e.g., `publisher_name/book_name/`).
4. The endpoint returns a success message with a manifest of the uploaded files.
5. The endpoint is protected and requires a valid JWT.

## Tasks / Subtasks
- [x] Design upload contract and validation (AC: 1, 2) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Define request payload strategy (zipped archive via `multipart/form-data`) and document required metadata fields (AC: 1, 2) [Source: architecture/6-components.md#storage]
  - [x] Confirm expectation that `publisher`/`book_name` come solely from repository lookup (no client override) to keep storage paths consistent (AC: 3) [Source: architecture/4-data-models.md#book]
- [x] Implement MinIO upload service (AC: 2, 3, 4) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Extend storage service module with helper to stream archive contents into MinIO under `publisher/book_name/` prefix (AC: 2, 3) [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
  - [x] Generate upload manifest listing file paths and sizes, returning it from the service (AC: 4) [Source: architecture/8-core-workflows.md#8-core-workflows]
- [x] Create authenticated upload endpoint (AC: 1, 2, 3, 4, 5) [Source: docs/stories/1.4.book-crud-endpoints.md#dev-agent-record]
  - [x] Add FastAPI route under `/books/{book_id}/upload` requiring JWT bearer auth (reuse auth dependency) (AC: 1, 5) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Accept uploaded archive, invoke storage service, and return manifest payload with HTTP 201 status (AC: 2, 3, 4) [Source: architecture/5-api-specification.md#5-api-specification]
- [x] Error handling & logging (AC: 2, 3) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
  - [x] Handle MinIO exceptions gracefully, translating to HTTP errors (e.g., 400 for bad archive, 502 for storage failures) with sanitized messages (AC: 3) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Log upload outcomes including bucket prefix and file counts without leaking credentials (AC: 2, 3) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
- [x] Testing strategy (AC: 1, 2, 3, 4, 5) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write unit tests for storage helper using mocked MinIO client ensuring archive extraction and correct key naming (AC: 2, 3, 4) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add FastAPI integration tests using mock dependencies to verify auth enforcement, success manifest, and error responses (AC: 1, 2, 4, 5) [Source: docs/stories/1.4.book-crud-endpoints.md#dev-agent-record]

## Dev Notes
### Previous Story Insights
- Story 1.4 established JWT-protected book endpoints and repository patterns; reuse the auth dependency and repository to fetch book metadata for path construction. [Source: docs/stories/1.4.book-crud-endpoints.md#dev-agent-record]
- Story 2.1 delivered MinIO client/bucket helpers; extend those utilities for upload operations. [Source: docs/stories/2.1.minio-service-connection-bucket-setup.md#dev-agent-record]

### Data Models
- Book metadata provides publisher and book name fields required for storage prefixing. [Source: architecture/4-data-models.md#book]

### API Specifications
- Follow REST conventions for upload endpoint under `/books/{book_id}` namespace and include manifest details in response. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Storage workflows emphasize MinIO usage; ensure upload logic stays within backend service layer. [Source: architecture/6-components.md#storage]

### File Locations
- Place upload service helpers under `apps/api/app/services` and route/controller code under `apps/api/app/routers`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Pytest with dependency injection/mocking for MinIO interactions and FastAPI TestClient for endpoint verification. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Maintain FastAPI async patterns, stream uploads to avoid storing large archives in memory, and utilize MinIO SDK from Story 2.1. [Source: architecture/3-tech-stack.md#3-tech-stack]

### Project Structure Notes
- Keep upload manifest definition within backend app scope; consider JSON response for downstream automation. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing
- Ensure new tests integrate with existing `pytest` suite and run in CI. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | Book upload endpoint implemented; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Story verified and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from `apps/api/`, 31 tests passed)

### Completion Notes List
- Added storage service helper to unpack ZIP archives into MinIO and return upload manifests.
- Delivered `/books/{book_id}/upload` endpoint with JWT enforcement and manifest response.
- Added unit tests for storage helper and integration-style tests for upload endpoint error/success flows.
- Leveraged existing MinIO client factory and auth patterns to keep implementation consistent.

### File List
- apps/api/app/routers/books.py
- apps/api/app/services/__init__.py
- apps/api/app/services/storage.py
- apps/api/tests/test_books_upload.py
- apps/api/tests/test_storage_service.py
- docs/stories/2.2.book-folder-upload-endpoint.md

## QA Results
- Gate: PASS â€“ `/books/{book_id}/upload` streams archived book content into MinIO using repository-derived prefixes and returns a manifest (`apps/api/app/routers/books.py:114`, `apps/api/app/services/storage.py:18`).
- Evidence:
  - Upload service unpacks ZIP entries, writes them to the `books` bucket under `publisher/book_name/`, and returns file paths/sizes (`apps/api/app/services/storage.py:40`).
  - Endpoint enforces JWT auth via existing dependency, validates book existence, and surfaces upload errors as HTTP 400/502 (`apps/api/app/routers/books.py:114`).
  - Pytest suite adds unit tests for archive handling plus integration coverage for auth, success, 404, and error responses (`apps/api/tests/test_storage_service.py:1`, `apps/api/tests/test_books_upload.py:1`); full run reports 31 passing tests.
- Residual Risks:
  - None identified; archive handling rejects invalid ZIPs and relies on repository metadata for storage paths.
