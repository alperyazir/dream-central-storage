# Story 2.4: List Contents of Buckets/Folders

## Status
Done

## Story
**As an** administrator,
**I want** to list the contents of books and application builds via the API,
**so that** I can verify uploads and manage stored files.

## Acceptance Criteria
1. An endpoint (e.g., `GET /storage/books/{publisher}/{book_name}`) is created to list the file structure of a specific book.
2. An endpoint (e.g., `GET /storage/apps/{platform}`) is created to list the contents of a specific application build.
3. The endpoints return a structured list of files and folders (e.g., a JSON tree).
4. The endpoints are protected and require a valid JWT.

## Tasks / Subtasks
- [x] Define storage listing contract (AC: 1, 2, 3) [Source: architecture/5-api-specification.md#5-api-specification]
  - [x] Determine response schema (tree with path/type/size) for both books and app builds (AC: 3) [Source: architecture/6-components.md#storage]
  - [x] Clarify request parameters; initial implementation supports optional version filter for apps (AC: 1, 2) [Source: architecture/8-core-workflows.md#8-core-workflows]
- [x] Implement storage listing service helpers (AC: 1, 2, 3) [Source: architecture/3-tech-stack.md#3-tech-stack]
  - [x] Extend MinIO service to recursively list objects for given prefixes, building hierarchical structure (AC: 1, 2, 3) [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]
  - [x] Support configurable prefixes for book paths (`publisher/book_name/`) and platform paths (`platform/`) (AC: 1, 2) [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-agent-record]
- [x] Create authenticated storage endpoints (AC: 1, 2, 3, 4) [Source: docs/stories/2.3.application-build-folder-upload-endpoint.md#dev-agent-record]
  - [x] Add `GET /storage/books/{publisher}/{book_name}` returning structured listing for book content (AC: 1, 3, 4) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Add `GET /storage/apps/{platform}` returning structured listing for application builds with optional version filter (AC: 2, 3, 4) [Source: architecture/5-api-specification.md#5-api-specification]
- [x] Error handling & observability (AC: 1, 2) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
  - [x] Translate MinIO listing errors into sanitized HTTP responses (AC: 1, 2) [Source: architecture/15-security-and-performance.md#15-security-and-performance]
  - [x] Log listing requests with bucket/prefix context to aid troubleshooting (AC: 1, 2) [Source: architecture/19-monitoring-and-observability.md#19-monitoring-and-observability]
- [x] Testing strategy (AC: 1, 2, 3, 4) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Write unit tests for storage listing helper using mocked MinIO client to simulate nested structures (AC: 1, 2, 3) [Source: architecture/16-testing-strategy.md#16-testing-strategy]
  - [x] Add integration tests for endpoints verifying auth, successful listing, and error handling (AC: 1, 2, 4) [Source: docs/stories/1.4.book-crud-endpoints.md#dev-agent-record]

## Dev Notes
### Previous Story Insights
- Stories 2.2 and 2.3 implemented upload flows and manifests; reuse storage prefixes and auth dependencies to align listing behaviour with upload destinations. [Source: docs/stories/2.2.book-folder-upload-endpoint.md#dev-agent-record]
- Story 2.1 provided MinIO client infrastructure; extend it for listing operations. [Source: docs/stories/2.1.minio-service-connection-bucket-setup.md#dev-agent-record]

### Data Models
- Book metadata still determines publisher/book_name mapping; ensure listing path relies on existing database entries. [Source: architecture/4-data-models.md#book]

### API Specifications
- Response should provide structured JSON tree for client-side rendering/management. [Source: architecture/5-api-specification.md#5-api-specification]

### Component Specifications
- Storage listing logic should live in service layer to keep routers lightweight. [Source: architecture/6-components.md#storage]

### File Locations
- Storage services remain under `apps/api/app/services`; routers under `apps/api/app/routers`. [Source: architecture/12-unified-project-structure.md#12-unified-project-structure]

### Testing Requirements
- Mock MinIO client to validate recursion and error handling; use FastAPI TestClient for endpoint behaviour. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

### Technical Constraints
- Consider performance when listing large hierarchies; may need depth limit or pagination in future iterations. [Source: architecture/3-tech-stack.md#3-tech-stack]

### Testing
- Ensure new tests run via Pytest and integrate with CI. [Source: architecture/16-testing-strategy.md#16-testing-strategy]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | 0.1 | Initial draft created. | Bob (Scrum Master) |
| 2025-09-23 | 0.2 | Story validated and approved for development. | Sarah (Product Owner) |
| 2025-09-23 | 0.3 | Storage listing endpoints implemented; awaiting review. | James (Developer) |
| 2025-09-23 | 0.4 | Story verified and marked Done. | Sarah (Product Owner) |

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (Developer Mode)

### Debug Log References
- `pytest` (executed from `apps/api/`, 39 tests passed)

### Completion Notes List
- Added storage service helper to list MinIO objects recursively and return hierarchical JSON tree.
- Implemented `/storage/books/{publisher}/{book_name}` and `/storage/apps/{platform}` endpoints with optional version filter and JWT enforcement.
- Logged listing requests and handled MinIO errors gracefully with sanitized responses.
- Added unit and integration tests covering tree construction, auth enforcement, success paths, and error scenarios.

### File List
- apps/api/app/main.py
- apps/api/app/routers/__init__.py
- apps/api/app/routers/storage.py
- apps/api/app/services/__init__.py
- apps/api/app/services/storage.py
- apps/api/tests/test_storage_endpoints.py
- apps/api/tests/test_storage_listing.py
- docs/stories/2.4.list-contents-of-buckets-folders.md

## QA Results
- Gate: PASS â€“ Storage listing endpoints return hierarchical trees for books/apps with JWT protection (`apps/api/app/routers/storage.py:1`, `apps/api/app/services/storage.py:85`).
- Evidence:
  - Listing helper walks MinIO prefixes, assembling folder/file nodes with sizes and paths (`apps/api/app/services/storage.py:85`).
  - `/storage/books/{publisher}/{book_name}` and `/storage/apps/{platform}` endpoints reuse existing auth dependency and optional version filtering (`apps/api/app/routers/storage.py:23`).
  - Tests cover tree construction, auth enforcement, success/filters, and error handling; overall pytest run counts 39 passing tests (`apps/api/tests/test_storage_listing.py:1`, `apps/api/tests/test_storage_endpoints.py:1`).
- Residual Risks:
  - Large buckets may require pagination or depth limits in future iterations; current implementation lists all objects.
